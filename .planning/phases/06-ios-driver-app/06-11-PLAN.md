---
phase: 06-ios-driver-app
plan: 11
type: execute
wave: 3
depends_on: ["06-03", "06-04"]
files_modified:
  - VroomXDriver/Views/Earnings/EarningsView.swift
  - VroomXDriver/Views/Earnings/SettlementDetailView.swift
  - VroomXDriver/Views/Main/MainTabView.swift
autonomous: true

must_haves:
  truths:
    - "Driver sees pay period hero card with total earnings"
    - "Financial breakdown shows revenue, driver pay, expenses, and net"
    - "Payment history lists past settlements"
    - "Settlement detail shows trip-by-trip breakdown"
    - "PDF and CSV export available for settlements"
  artifacts:
    - path: "VroomXDriver/Views/Earnings/EarningsView.swift"
      provides: "Earnings tab with hero card, breakdown, payment history"
      contains: "EarningsView"
    - path: "VroomXDriver/Views/Earnings/SettlementDetailView.swift"
      provides: "Settlement detail with trip breakdown and export"
      contains: "SettlementDetailView"
  key_links:
    - from: "VroomXDriver/Views/Earnings/EarningsView.swift"
      to: "VroomXDriver/Core/DataManager.swift"
      via: "Reads trips to calculate earnings"
      pattern: "DataManager\\.shared\\.trips"
    - from: "VroomXDriver/Views/Earnings/SettlementDetailView.swift"
      to: "VroomXDriver/Views/BOL/PDFGenerator.swift"
      via: "Uses PDFGenerator for settlement PDF export"
      pattern: "PDFGenerator"
---

<objective>
Build the Earnings tab with pay period hero card, financial breakdown, payment history, and settlement detail with PDF/CSV export.

Purpose: Drivers need visibility into their earnings. This tab shows current and historical pay periods with trip-by-trip financial breakdown.

Output: EarningsView and SettlementDetailView replacing the Earnings tab placeholder
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/06-ios-driver-app/06-CONTEXT.md
@.planning/phases/06-ios-driver-app/06-03-SUMMARY.md
@.planning/phases/06-ios-driver-app/06-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build EarningsView with hero card, breakdown, and payment history</name>
  <files>
    VroomXDriver/Views/Earnings/EarningsView.swift
    VroomXDriver/Views/Main/MainTabView.swift
  </files>
  <action>
**EarningsView.swift:**
- NavigationStack for drill-down to settlement detail

- **Pay period hero card** (large card with gradient brandPrimary -> brandAccent):
  - Current pay period dates (e.g., "Feb 1 - Feb 15")
  - Total earnings amount (large, bold, mono font): sum of driver_pay across trips in period
  - Trip count: "X trips"
  - Status indicator: "Current Period" badge

- **Financial breakdown section** (below hero card, 4 rows):
  - Total Revenue: sum of total_revenue across trips in current period
  - Driver Pay: sum of driver_pay (brandPrimary color)
  - Total Expenses: sum of total_expenses (brandDanger if nonzero)
  - Net Earnings: driver_pay - expenses (green if positive, red if negative)
  - Each row: label left, amount right, with subtle separator line

- **Bar chart** (optional visual):
  - Simple horizontal bar chart showing earnings by week (last 4 weeks)
  - Use SwiftUI Chart framework if available (iOS 16+), or custom rectangles
  - brandPrimary fill color

- **Payment history section:**
  - Section header: "Payment History"
  - List of past pay periods (grouped by bi-weekly or monthly periods based on trip dates):
    - Date range, total earnings amount, trip count, status badge (paid/pending)
    - NavigationLink to SettlementDetailView
  - Generate pay periods by grouping completed trips by their start_date into 2-week intervals
  - Sort descending (most recent first)

- Pull-to-refresh to reload trip data

**Calculate earnings from DataManager.shared.trips:**
- Current period: trips where start_date falls within current 2-week period
- Past periods: group remaining trips by 2-week intervals
- All financial values from denormalized trip fields (total_revenue, driver_pay, total_expenses)

**Update MainTabView.swift:**
- Replace Earnings tab placeholder with `EarningsView()`
  </action>
  <verify>EarningsView shows hero card with current period earnings, financial breakdown, and payment history list. MainTabView Earnings tab is wired.</verify>
  <done>Earnings tab shows current period earnings hero card, financial breakdown, and historical payment periods</done>
</task>

<task type="auto">
  <name>Task 2: Build SettlementDetailView with trip breakdown and PDF/CSV export</name>
  <files>VroomXDriver/Views/Earnings/SettlementDetailView.swift</files>
  <action>
**SettlementDetailView.swift:**
Takes a `Settlement` struct (pay period dates + trips array) as input.

- **Header:** Pay period date range, total earnings (large), trip count

- **Summary card:**
  - Gross Revenue (sum of total_revenue)
  - Carrier Pay (sum of carrier_pay)
  - Driver Pay (sum of driver_pay) — highlighted
  - Total Expenses (sum of total_expenses)
  - Net Earnings (driver_pay - total_expenses) — green/red

- **Trip-by-trip breakdown table:**
  - Column headers: Trip #, Date, Route, Revenue, Driver Pay, Expenses, Net
  - Row for each trip in the settlement:
    - trip_number
    - start_date formatted
    - origin_summary -> destination_summary (truncated if long)
    - total_revenue, driver_pay, total_expenses, per-trip net
  - Alternating row background colors for readability
  - Total row at bottom with bold totals

- **Export actions** (bottom bar or toolbar):
  1. "Export PDF" button:
     - Generate settlement PDF using PDFGenerator utilities
     - PDF layout: header with VroomX branding, period dates, summary table, trip breakdown table, footer
     - Use UIGraphicsPDFRenderer (same approach as BOL)
     - Open share sheet with generated PDF data
  2. "Export CSV" button:
     - Generate CSV string with columns: Trip Number, Date, Route, Revenue, Driver Pay, Expenses, Net
     - Create temporary file, open share sheet
     - CSV comma-separated, with header row

**PDF settlement generation:**
- Page 1: "Settlement Statement" header, VroomX branding, period dates, summary totals
- Page 2+: Trip breakdown table (paginate if >15 trips)
- Footer: "Generated by VroomX Driver App" + timestamp
  </action>
  <verify>SettlementDetailView shows trip breakdown table with all financial columns. PDF export generates valid PDF. CSV export generates valid CSV with headers.</verify>
  <done>Settlement detail shows trip-by-trip earnings breakdown with PDF and CSV export for record-keeping</done>
</task>

</tasks>

<verification>
- Earnings hero card shows correct sum of driver_pay for current period
- Financial breakdown values match sum of denormalized trip fields
- Pay periods are calculated by grouping trips by 2-week intervals
- Settlement detail shows every trip in the period with financial columns
- PDF export generates professional settlement statement
- CSV export has correct headers and data formatting
- All currency values formatted with 2 decimal places
</verification>

<success_criteria>
- Driver sees current and historical earnings at a glance
- Settlement detail shows trip-by-trip financial breakdown
- PDF and CSV export work via iOS share sheet
- All financial calculations use denormalized trip fields
</success_criteria>

<output>
After completion, create `.planning/phases/06-ios-driver-app/06-11-SUMMARY.md`
</output>
