---
phase: 06-ios-driver-app
plan: 12
type: execute
wave: 3
depends_on: ["06-03", "06-04"]
files_modified:
  - VroomXDriver/Views/Messages/MessagesView.swift
  - VroomXDriver/Core/NotificationManager.swift
  - VroomXDriver/Views/Main/MainTabView.swift
autonomous: true

user_setup:
  - service: apple-developer
    why: "Push notification certificate/key for APNs"
    env_vars:
      - name: APNS_KEY_ID
        source: "Apple Developer -> Certificates, Identifiers & Profiles -> Keys"
      - name: APNS_TEAM_ID
        source: "Apple Developer -> Membership -> Team ID"
      - name: APNS_AUTH_KEY
        source: "Apple Developer -> Keys -> Download .p8 file"
    dashboard_config:
      - task: "Create APNs auth key"
        location: "Apple Developer -> Certificates, Identifiers & Profiles -> Keys -> Create"
      - task: "Enable Push Notification capability in App ID"
        location: "Apple Developer -> Identifiers -> App ID -> Push Notifications"

must_haves:
  truths:
    - "Driver sees list of dispatch notifications and messages"
    - "Unread notifications are visually distinct"
    - "Tapping a notification marks it as read"
    - "Push notifications trigger for trip assignments and status changes"
    - "Messages tab shows badge count for unread notifications"
  artifacts:
    - path: "VroomXDriver/Views/Messages/MessagesView.swift"
      provides: "Messages tab with notification list"
      contains: "MessagesView"
    - path: "VroomXDriver/Core/NotificationManager.swift"
      provides: "Push notification registration, handling, and badge management"
      contains: "NotificationManager"
  key_links:
    - from: "VroomXDriver/Core/NotificationManager.swift"
      to: "VroomXDriver/Core/DataManager.swift"
      via: "Stores device token in device_tokens table"
      pattern: "device_tokens"
    - from: "VroomXDriver/Views/Messages/MessagesView.swift"
      to: "VroomXDriver/Core/DataManager.swift"
      via: "Reads and marks notifications via DataManager"
      pattern: "DataManager\\.shared\\.notifications"
---

<objective>
Build the Messages tab and push notification system (APNs registration, device token storage, notification display, badge count).

Purpose: Drivers need to receive real-time updates from dispatch -- trip assignments, status changes, and urgent messages. The Messages tab provides a notification history.

Output: MessagesView, NotificationManager, MainTabView Messages tab wired
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/06-ios-driver-app/06-CONTEXT.md
@.planning/phases/06-ios-driver-app/06-RESEARCH.md
@.planning/phases/06-ios-driver-app/06-03-SUMMARY.md
@.planning/phases/06-ios-driver-app/06-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build NotificationManager for push notifications</name>
  <files>VroomXDriver/Core/NotificationManager.swift</files>
  <action>
**NotificationManager.swift:**
`NotificationManager: NSObject, ObservableObject, UNUserNotificationCenterDelegate`

**Published state:**
- `unreadCount: Int = 0`
- `deviceToken: String?`

**Push notification registration:**
- `requestPermission()` — request UNUserNotificationCenter.requestAuthorization(options: [.alert, .badge, .sound])
- After permission granted: call `UIApplication.shared.registerForRemoteNotifications()`
- Implement `application(_:didRegisterForRemoteNotificationsWithDeviceToken:)` handler via delegate pattern
- Convert device token Data to hex string

**Device token storage:**
- `registerDeviceToken(driverId: String) async` — store token in `device_tokens` table via Supabase:
  - UPSERT (insert or update on conflict): tenant_id (from JWT), driver_id, device_token, platform='ios', last_active_at=now()
- `deregisterDeviceToken() async` — delete from `device_tokens` where device_token matches (called on logout)

**Notification handling:**
- `userNotificationCenter(_:willPresent:)` — handle foreground notification: show banner, play sound, update badge
- `userNotificationCenter(_:didReceive:)` — handle tap on notification: navigate to relevant screen based on notification data
- Parse notification payload: extract notification_type, trip_id, order_id from data payload
- After handling: mark notification as read in DB

**Badge management:**
- `updateBadgeCount() async` — query driver_notifications where read_at IS NULL, set unreadCount
- Update app badge number: `UIApplication.shared.applicationIconBadgeNumber = unreadCount`
- Called on app launch, notification received, and after marking read

**Integration with DataManager:**
- On notification received: trigger DataManager.fetchTrips() or DataManager.fetchOrders() to refresh relevant data
- Notification types and actions:
  - trip_assignment: refresh trips, navigate to trip detail
  - status_change: refresh orders, navigate to order detail
  - dispatch_message: refresh notifications, show in Messages tab
  - urgent: show alert dialog with message content
  </action>
  <verify>NotificationManager requests permission, registers device token, handles foreground/background notifications, and manages badge count.</verify>
  <done>Push notification system registers with APNs, stores device tokens, handles notification display and navigation</done>
</task>

<task type="auto">
  <name>Task 2: Build MessagesView and wire into MainTabView</name>
  <files>
    VroomXDriver/Views/Messages/MessagesView.swift
    VroomXDriver/Views/Main/MainTabView.swift
  </files>
  <action>
**MessagesView.swift:**
- NavigationStack for potential detail navigation

- **Notification list:** All driver_notifications sorted by created_at desc
  - Each row:
    - Icon based on notification_type: bell for trip_assignment, arrow.triangle.swap for status_change, message for dispatch_message, exclamationmark.triangle for urgent
    - Title (bold if unread)
    - Body text (truncated to 2 lines)
    - Time ago label ("2h ago", "Yesterday", "Feb 10")
    - Unread indicator: small brandPrimary dot on left side
  - Tap action:
    - Mark notification as read (DataManager.markNotificationRead)
    - If notification data contains trip_id: navigate to trip detail
    - If notification data contains order_id: navigate to order detail
    - Otherwise: expand notification body inline

- **Sections:**
  - "Today" — notifications from today
  - "This Week" — notifications from this week
  - "Earlier" — older notifications

- **Empty state:** "No messages yet" with message icon. "Notifications from dispatch will appear here."

- Pull-to-refresh to reload notifications

- Filter options (optional): "All", "Unread", "Trip Assignments", "Status Changes"

**Update MainTabView.swift:**
- Replace Messages tab placeholder with `MessagesView()`
- Add badge on Messages tab: `.badge(notificationManager.unreadCount)` if unreadCount > 0
- Inject NotificationManager as environment object
- Update VroomXDriverApp.swift to create NotificationManager @StateObject and inject
- Call notificationManager.requestPermission() and notificationManager.updateBadgeCount() on app launch
  </action>
  <verify>MessagesView shows notification list with unread indicators. Tab badge shows unread count. Tapping marks as read and navigates to relevant content.</verify>
  <done>Messages tab shows notification history with unread badges, tap-to-read, and navigation to related trips/orders</done>
</task>

</tasks>

<verification>
- Push permission requested on first launch (or after login)
- Device token stored in device_tokens table with correct driver_id and tenant_id
- Device token deregistered on logout
- Foreground notifications show banner
- Background notification tap navigates to relevant screen
- Messages tab badge shows unread count
- Tapping notification marks as read (unread dot disappears)
- Notifications grouped by time period (Today, This Week, Earlier)
</verification>

<success_criteria>
- Driver receives push notifications for trip assignments and status changes
- Messages tab shows full notification history with unread indicators
- Badge count on tab accurately reflects unread notifications
- Tapping a notification navigates to the relevant trip or order
- Device token properly managed (registered on login, deregistered on logout)
</success_criteria>

<output>
After completion, create `.planning/phases/06-ios-driver-app/06-12-SUMMARY.md`
</output>
