---
phase: 06-ios-driver-app
plan: 10
type: execute
wave: 5
depends_on: ["06-09"]
files_modified:
  - VroomXDriver/Views/BOL/BOLGenerator.swift
  - VroomXDriver/Views/BOL/BOLPreviewView.swift
  - VroomXDriver/Views/BOL/PDFGenerator.swift
  - VroomXDriver/Views/Inspection/CustomerSignOffView.swift
  - supabase/functions/send-bol-email/index.ts
autonomous: true

must_haves:
  truths:
    - "BOL PDF generates with vehicle info, inspection details, damage diagrams, and signatures"
    - "BOL PDF has 2 pages matching Horizon's professional layout"
    - "Driver can preview the BOL before sending"
    - "BOL can be emailed to customer via Supabase Edge Function"
    - "BOL PDF is uploaded to bol-documents storage bucket"
  artifacts:
    - path: "VroomXDriver/Views/BOL/BOLGenerator.swift"
      provides: "2-page BOL PDF generation from inspection and order data"
      contains: "generateBOL"
    - path: "VroomXDriver/Views/BOL/BOLPreviewView.swift"
      provides: "PDF preview with email and share options"
      contains: "BOLPreviewView"
    - path: "supabase/functions/send-bol-email/index.ts"
      provides: "Edge Function that sends BOL PDF via email"
      contains: "Resend"
  key_links:
    - from: "VroomXDriver/Views/Inspection/CustomerSignOffView.swift"
      to: "VroomXDriver/Views/BOL/BOLPreviewView.swift"
      via: "fullScreenCover triggered after successful customer sign-off, passing completed inspection ID"
      pattern: "showBOLPreview"
    - from: "VroomXDriver/Views/BOL/BOLGenerator.swift"
      to: "UIGraphicsPDFRenderer"
      via: "System PDF rendering"
      pattern: "UIGraphicsPDFRenderer"
    - from: "VroomXDriver/Views/BOL/BOLPreviewView.swift"
      to: "supabase/functions/send-bol-email/index.ts"
      via: "Edge Function invocation for email delivery"
      pattern: "SupabaseManager\\.shared\\.client\\.functions"
---

<objective>
Build BOL (Bill of Lading) generation, preview, and email delivery. The BOL is a 2-page professional PDF created from inspection + order data.

Purpose: The BOL is the legal document that proves vehicle condition at pickup/delivery. It must be generated on-device (works offline), previewed, and emailable.

Output: BOLGenerator, BOLPreviewView, PDFGenerator, Supabase Edge Function for email
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/06-ios-driver-app/06-CONTEXT.md
@.planning/phases/06-ios-driver-app/06-RESEARCH.md
@.planning/phases/06-ios-driver-app/06-09-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build BOLGenerator and PDFGenerator for 2-page BOL PDF</name>
  <files>
    VroomXDriver/Views/BOL/BOLGenerator.swift
    VroomXDriver/Views/BOL/PDFGenerator.swift
  </files>
  <action>
**BOLGenerator.swift:**
Reference Horizon Star's BOLGenerator.swift for layout but rebrand for VroomX. Use `UIGraphicsPDFRenderer` (system framework, no third-party dependencies).

Page dimensions: Letter size (8.5 x 11 inches, 612 x 792 pt at 72 dpi).

`func generateBOL(order: VroomXOrder, pickupInspection: VehicleInspection?, deliveryInspection: VehicleInspection?, pickupPhotos: [InspectionPhoto], deliveryPhotos: [InspectionPhoto], pickupDamages: [InspectionDamage], deliveryDamages: [InspectionDamage], driverName: String, truckNumber: String?) -> Data?`

**PAGE 1: Inspection Details**
- Header: "VroomX Transport" logo/text (NOT Horizon Star), "BILL OF LADING" title, order number, date
- Vehicle info box: Year, Make, Model, VIN, Color, Vehicle Type
- Pickup inspection section:
  - Address, date, odometer reading
  - Damage summary (list of damages by type and view)
  - Vehicle diagram thumbnail showing damage markers (render diagram to image)
  - Driver signature image
  - Customer signature image with name
- Delivery inspection section (same layout as pickup):
  - Only present if delivery inspection exists
- Condition comparison: side-by-side pickup vs delivery damage counts

**PAGE 2: Terms & Signatures**
- Standard BOL terms and conditions text (vehicle transport carrier liability language)
- Financial summary: Revenue, carrier pay, payment type
- Driver certification section with signature line
- Customer certification section with signature line
- Footer: "Generated by VroomX Driver App" with timestamp

Colors: Use VroomX indigo primary (#3B82F6) for headers. Professional grayscale for body.
Fonts: UIFont.systemFont sizes matching Horizon (titleFont 16pt, headerFont 11pt, bodyFont 9pt, smallFont 7pt).

Return `Data` (PDF bytes) that can be displayed in PDFKit or saved to file.

**PDFGenerator.swift:**
Shared PDF utility functions:
- `drawText(_ text: String, at: CGPoint, font: UIFont, color: UIColor, maxWidth: CGFloat?)` — text rendering helper
- `drawLine(from: CGPoint, to: CGPoint, color: UIColor, width: CGFloat)` — line rendering
- `drawRect(_ rect: CGRect, fill: UIColor?, stroke: UIColor?, strokeWidth: CGFloat)` — rectangle drawing
- `drawImage(_ image: UIImage, in rect: CGRect)` — image rendering
- `drawSignature(_ signatureURL: String?, in rect: CGRect, label: String)` — download signature image from URL and draw with label
- These are used by BOLGenerator and also by settlement PDF export (Plan 11)
  </action>
  <verify>BOLGenerator.generateBOL returns valid PDF Data with 2 pages. VroomX branding (not Horizon). All inspection data rendered including signatures and damage diagrams.</verify>
  <done>2-page BOL PDF generates from inspection and order data with VroomX branding, vehicle details, damage reports, and signatures</done>
</task>

<task type="auto">
  <name>Task 2: Build BOLPreviewView and email Edge Function</name>
  <files>
    VroomXDriver/Views/BOL/BOLPreviewView.swift
    supabase/functions/send-bol-email/index.ts
  </files>
  <action>
**BOLPreviewView.swift:**
- **Navigation trigger:** BOLPreviewView is navigated to from CustomerSignOffView (Plan 09) after successful customer sign-off. CustomerSignOffView sets `showBOLPreview = true` with the completed inspection ID. Plan 10 wires this: replace the placeholder in CustomerSignOffView with a `.fullScreenCover(isPresented: $showBOLPreview)` that presents BOLPreviewView.
- Takes `inspectionId: String`, `order: VroomXOrder`, `inspection: VehicleInspection`, `photos: [InspectionPhoto]`, `damages: [InspectionDamage]`, and `driverName: String` as input. On appear, generates the BOL PDF via BOLGenerator.
- Also accessible from OrderDetailView's FileManagementGrid (when tapping an existing BOL attachment).
- Full-screen PDF preview using PDFKit's PDFView:
  - `import PDFKit`
  - Create `PDFDocument(data: pdfData)` and display in PDFView (wrapped in UIViewRepresentable)
  - Pinch-to-zoom, scroll through pages
- **Action buttons** at bottom:
  1. "Email BOL" — opens email input sheet:
     - Pre-filled with delivery contact email or pickup contact email if available
     - Custom email field
     - "Send" button -> uploads PDF to Supabase Storage (`bol-documents/{orderId}/BOL-{orderNumber}.pdf`), creates order_attachments record, invokes Edge Function
  2. "Share" — iOS share sheet (UIActivityViewController) with PDF as attachment
  3. "Save" — save PDF to Files app (use file exporter)
- Loading state during email send
- Success/error feedback via toast/banner

**Upload BOL to Storage:**
- Path: `{orderId}/BOL-{orderNumber}.pdf`
- Bucket: `bol-documents`
- After upload: create `order_attachments` record with file_type='bol_pdf', storage_path, file_name

**supabase/functions/send-bol-email/index.ts:**
Supabase Edge Function that sends BOL PDF via email:
```typescript
// Deno-based Edge Function
import { serve } from "https://deno.land/std@0.168.0/http/server.ts"
import { Resend } from "npm:resend"

serve(async (req) => {
  const { to, orderNumber, pdfStoragePath, tenantName } = await req.json()

  // Download PDF from Supabase Storage
  // Use service role client to access storage
  const supabaseUrl = Deno.env.get('SUPABASE_URL')!
  const serviceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!

  // Fetch PDF from storage
  const storageUrl = `${supabaseUrl}/storage/v1/object/authenticated/bol-documents/${pdfStoragePath}`
  const pdfResponse = await fetch(storageUrl, {
    headers: { 'Authorization': `Bearer ${serviceKey}` }
  })
  const pdfBuffer = await pdfResponse.arrayBuffer()

  // Send via Resend (same email service as web dashboard)
  const resend = new Resend(Deno.env.get('RESEND_API_KEY')!)
  await resend.emails.send({
    from: `${tenantName} <noreply@vroomx.com>`,
    to: [to],
    subject: `Bill of Lading - Order ${orderNumber}`,
    html: `<p>Please find attached the Bill of Lading for Order ${orderNumber}.</p><p>Thank you for choosing ${tenantName}.</p>`,
    attachments: [{
      filename: `BOL-${orderNumber}.pdf`,
      content: Buffer.from(pdfBuffer).toString('base64'),
    }]
  })

  return new Response(JSON.stringify({ success: true }), {
    headers: { 'Content-Type': 'application/json' }
  })
})
```

**Wire CustomerSignOffView -> BOLPreviewView:**
- In CustomerSignOffView.swift (from Plan 09), replace the placeholder `showBOLPreview` state with a `.fullScreenCover(isPresented: $showBOLPreview)` that presents `BOLPreviewView(inspectionId: completedInspectionId!, order: order, inspection: inspection, photos: photos, damages: damages, driverName: driverName)`
- After successful customer sign-off and data save, set `showBOLPreview = true`
- BOLPreviewView generates the PDF on appear using BOLGenerator.generateBOL()
- On dismiss from BOLPreviewView, the inspection flow is complete and returns to order detail

**Invoke from iOS:**
```swift
try await SupabaseManager.shared.client.functions.invoke(
    "send-bol-email",
    options: .init(body: [
        "to": email,
        "orderNumber": order.order_number ?? "",
        "pdfStoragePath": storagePath,
        "tenantName": tenantName
    ])
)
```
  </action>
  <verify>BOLPreviewView shows PDF with zoom/scroll. Email sends via Edge Function with PDF attachment. PDF uploaded to bol-documents bucket.</verify>
  <done>BOL preview with email delivery via Supabase Edge Function, share sheet, and file save options</done>
</task>

</tasks>

<verification>
- BOL PDF has VroomX branding (blue headers, "VroomX Transport" not "Horizon Star")
- PDF has 2 pages: inspection details + terms/signatures
- Vehicle damage markers rendered in diagram
- Both driver and customer signatures rendered
- Email sends via Resend through Edge Function
- PDF uploaded to bol-documents storage bucket
- order_attachments record created for the BOL
- Works offline: PDF generates locally (email requires connectivity)
</verification>

<success_criteria>
- Driver can generate a professional 2-page BOL PDF after inspection completion
- BOL can be previewed, emailed, shared, or saved
- Email delivery works via Supabase Edge Function with Resend
- BOL is stored in Supabase Storage and linked to the order via order_attachments
</success_criteria>

<output>
After completion, create `.planning/phases/06-ios-driver-app/06-10-SUMMARY.md`
</output>
