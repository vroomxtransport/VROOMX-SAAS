---
phase: 06-ios-driver-app
plan: 07
type: execute
wave: 3
depends_on: ["06-03", "06-04"]
files_modified:
  - VroomXDriver/Views/Orders/OrderDetailView.swift
  - VroomXDriver/Views/Orders/TimelineView.swift
  - VroomXDriver/Views/Orders/ETAButton.swift
  - VroomXDriver/Views/Orders/MapLinkButton.swift
  - VroomXDriver/Views/Orders/FileManagementGrid.swift
  - VroomXDriver/Views/Shared/ContactActionSheet.swift
autonomous: true

must_haves:
  truths:
    - "Order detail shows vehicle info, pickup/delivery addresses, dates, timeline, and files"
    - "Driver can update order status (picked up, in transit, delivered)"
    - "Driver can submit pickup and delivery ETAs"
    - "Tapping an address opens Apple/Google Maps"
    - "Contact actions (call, SMS, copy) work for pickup/delivery contacts"
    - "Files grid shows BOLs, photos, and attachments for the order"
  artifacts:
    - path: "VroomXDriver/Views/Orders/OrderDetailView.swift"
      provides: "Full order detail with status updates, ETA, contacts, files"
      contains: "OrderDetailView"
    - path: "VroomXDriver/Views/Orders/TimelineView.swift"
      provides: "7-step delivery progress timeline"
      contains: "TimelineView"
  key_links:
    - from: "VroomXDriver/Views/Orders/OrderDetailView.swift"
      to: "VroomXDriver/Core/DataManager.swift"
      via: "updateOrderStatus, submitETA mutations"
      pattern: "DataManager\\.shared\\.updateOrderStatus"
    - from: "VroomXDriver/Views/Orders/MapLinkButton.swift"
      to: "UIApplication.shared.open"
      via: "Opens Maps URL"
      pattern: "UIApplication\\.shared\\.open"
---

<objective>
Build the order detail view with delivery timeline, status updates, ETA submission, map links, contact actions, and file management.

Purpose: The order detail is where drivers interact with individual orders -- updating status, submitting ETAs, starting inspections, contacting pickup/delivery locations, and viewing attached documents.

Output: OrderDetailView and supporting components (timeline, ETA, map, contacts, files)
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/06-ios-driver-app/06-CONTEXT.md
@.planning/phases/06-ios-driver-app/06-RESEARCH.md
@.planning/phases/06-ios-driver-app/06-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build OrderDetailView with status updates and ETA</name>
  <files>
    VroomXDriver/Views/Orders/OrderDetailView.swift
    VroomXDriver/Views/Orders/TimelineView.swift
    VroomXDriver/Views/Orders/ETAButton.swift
  </files>
  <action>
**OrderDetailView.swift:**
Takes `order: VroomXOrder` as input. ScrollView layout:

- **Header:** Order number, status badge (colored pill), vehicle description (year make model color)
- **Vehicle info card:** VIN, vehicle type, color (with color dot)
- **Timeline:** TimelineView showing delivery progress
- **Status action button:**
  - If status == assigned: "Mark Picked Up" button (brandPrimary) -> calls DataManager.updateOrderStatus(orderId:, status: .picked_up)
  - If status == picked_up: "Mark Delivered" button (brandSuccess) -> calls DataManager.updateOrderStatus(orderId:, status: .delivered)
  - If status == delivered: "Start Delivery Inspection" button -> NavigationLink to InspectionView (placeholder until Plan 08)
  - Confirmation alert before status change: "Mark this order as {status}?"

- **Pickup section:**
  - Address: pickup_location, pickup_city, pickup_state, pickup_zip
  - MapLinkButton for the address
  - Contact: pickup_contact_name, pickup_contact_phone with ContactActionSheet
  - Scheduled date: pickup_date formatted
  - Actual date: actual_pickup_date (if set)
  - ETA: ETAButton for pickup_eta

- **Delivery section:**
  - Same layout as pickup but with delivery fields
  - MapLinkButton for delivery address
  - Contact: delivery_contact_name, delivery_contact_phone
  - ETA: ETAButton for delivery_eta

- **Financial section:** (visible but read-only for driver)
  - Revenue, carrier pay, broker fee, payment type
  - Payment status badge

- **Files section:** FileManagementGrid showing order attachments

- **Notes section:** order.notes if present

- **Inspection actions:**
  - "Start Pickup Inspection" button (if status is assigned/picked_up and no pickup inspection exists)
  - "Start Delivery Inspection" button (if status is delivered and no delivery inspection exists)
  - "View Inspection" button (if inspection already completed)
  - NavigationLink to InspectionView (built in Plans 08-09)

**TimelineView.swift:**
- 7-step vertical timeline matching Horizon v3:
  1. Order Created (always complete)
  2. Assigned to Trip (complete if trip_id != nil)
  3. Pickup Inspection (complete if pickup inspection exists)
  4. Picked Up (complete if status >= picked_up)
  5. In Transit (active if status == picked_up)
  6. Delivery Inspection (complete if delivery inspection exists)
  7. Delivered (complete if status >= delivered)
- Each step: circle indicator (filled green if complete, blue ring if active, gray if pending), title, optional timestamp
- Vertical connecting line between steps

**ETAButton.swift:**
- Shows current ETA if set, or "Set ETA" button
- Tap opens DatePicker sheet (date + time)
- On confirm: calls DataManager.submitETA
- Shows formatted ETA value inline when set
- Edit button to modify existing ETA
  </action>
  <verify>OrderDetailView shows all order info. Status update buttons work for assigned->picked_up->delivered transitions. Timeline reflects current order state. ETA submission works.</verify>
  <done>Order detail provides full order context with status updates, ETA submission, and delivery timeline</done>
</task>

<task type="auto">
  <name>Task 2: Build MapLinkButton, ContactActionSheet, and FileManagementGrid</name>
  <files>
    VroomXDriver/Views/Orders/MapLinkButton.swift
    VroomXDriver/Views/Orders/FileManagementGrid.swift
    VroomXDriver/Views/Shared/ContactActionSheet.swift
  </files>
  <action>
**MapLinkButton.swift:**
- Takes `address: String` as input
- Button with map SF Symbol and "Open in Maps" label
- On tap: URL-encode the address, try opening Google Maps first (`comgooglemaps://?q=...`), fall back to Apple Maps (`maps://?q=...`)
- Use `UIApplication.shared.canOpenURL` to check for Google Maps
- Small, inline button style matching card aesthetics

**ContactActionSheet.swift:**
- Takes `name: String?` and `phone: String?` as input
- Displays name and phone number
- Three action buttons (horizontal row):
  1. Phone icon — `tel:{phone}` URL to call
  2. Message icon — `sms:{phone}` URL to open Messages
  3. Copy icon — copy phone to clipboard with haptic feedback
- Uses `UIApplication.shared.open` for tel: and sms: URLs
- Gracefully hide if phone is nil

**FileManagementGrid.swift:**
- Takes `orderId: String` as input
- Fetches order_attachments from Supabase where order_id = orderId
- 2-column LazyVGrid layout
- Each file card: icon based on file_type (doc, photo, PDF), file name, file size
- File types: bol_pdf (PDF icon), receipt (receipt icon), photo (photo icon), document (doc icon)
- Tap to view: open file in a full-screen sheet (PDFKit for PDFs, AsyncImage for photos)
- "Add File" button: opens camera or photo library to attach a new photo
- Upload new attachments to Supabase Storage `bol-documents` bucket and create order_attachments record
- Empty state: "No files attached" with plus icon
  </action>
  <verify>MapLinkButton opens Google/Apple Maps. ContactActionSheet has call/SMS/copy actions. FileManagementGrid displays and uploads order attachments.</verify>
  <done>Supporting components enable map navigation, contact actions, and file management from order detail</done>
</task>

</tasks>

<verification>
- Order status updates sync to Supabase (actual_pickup_date/actual_delivery_date set on status change)
- Timeline accurately reflects order state from VroomX status enum
- Map links try Google Maps first, fall back to Apple Maps
- Contact actions work for call, SMS, and clipboard copy
- ETA DatePicker stores value to orders.pickup_eta/delivery_eta
- File grid shows existing attachments and allows adding new ones
</verification>

<success_criteria>
- Driver can view complete order details including vehicle, addresses, contacts, and financials
- Status can be updated from assigned -> picked_up -> delivered
- ETAs can be submitted and modified
- Addresses open in Maps, contacts are actionable (call/SMS/copy)
- Files grid shows BOLs and allows photo attachments
</success_criteria>

<output>
After completion, create `.planning/phases/06-ios-driver-app/06-07-SUMMARY.md`
</output>
