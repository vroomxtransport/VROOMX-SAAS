---
phase: 06-ios-driver-app
plan: 09
type: execute
wave: 4
depends_on: ["06-08"]
files_modified:
  - VroomXDriver/Views/Inspection/InspectionNotesView.swift
  - VroomXDriver/Views/Inspection/DriverReviewView.swift
  - VroomXDriver/Views/Inspection/CustomerReviewView.swift
  - VroomXDriver/Views/Inspection/CustomerSignOffView.swift
  - VroomXDriver/Views/Inspection/SignaturePadView.swift
autonomous: true

must_haves:
  truths:
    - "Inspection step 4 captures odometer, interior condition, notes, and GPS location"
    - "Inspection step 5 shows all inspection data for driver review and digital signature"
    - "Inspection step 6 allows customer to verify condition and sign digitally"
    - "Customer sign-off triggers inspection completion and BOL generation"
    - "SignaturePad captures drawn signature and exports as image"
  artifacts:
    - path: "VroomXDriver/Views/Inspection/InspectionNotesView.swift"
      provides: "Odometer, interior condition, notes, GPS capture"
      contains: "InspectionNotesView"
    - path: "VroomXDriver/Views/Inspection/SignaturePadView.swift"
      provides: "Drawing-based signature capture component"
      contains: "SignaturePadView"
    - path: "VroomXDriver/Views/Inspection/CustomerSignOffView.swift"
      provides: "Customer verification and signature capture"
      contains: "CustomerSignOffView"
  key_links:
    - from: "VroomXDriver/Views/Inspection/CustomerSignOffView.swift"
      to: "VroomXDriver/Core/DataManager.swift"
      via: "Saves inspection to DB and triggers BOL generation"
      pattern: "SupabaseManager\\.shared"
    - from: "VroomXDriver/Views/Inspection/InspectionNotesView.swift"
      to: "CoreLocation"
      via: "GPS location capture for inspection"
      pattern: "CLLocationManager"
---

<objective>
Build inspection steps 4-6: notes/conditions, driver review with signature, and customer sign-off with signature. Complete the 6-step inspection workflow.

Purpose: Steps 4-6 finalize the inspection with condition details, driver certification, and customer verification. The customer sign-off triggers BOL generation (Plan 10).

Output: InspectionNotesView, DriverReviewView, CustomerReviewView, CustomerSignOffView, SignaturePadView
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/06-ios-driver-app/06-CONTEXT.md
@.planning/phases/06-ios-driver-app/06-RESEARCH.md
@.planning/phases/06-ios-driver-app/06-08-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build InspectionNotesView (step 4) and SignaturePadView</name>
  <files>
    VroomXDriver/Views/Inspection/InspectionNotesView.swift
    VroomXDriver/Views/Inspection/SignaturePadView.swift
  </files>
  <action>
**InspectionNotesView.swift:**
Step 4 of the inspection flow. Captures condition details:

- **Odometer reading:** TextField with numberPad keyboard, placeholder "Enter mileage"
- **Interior condition:** Segmented picker or radio buttons: "Excellent", "Good", "Fair", "Poor"
- **Custom notes:** TextEditor (multiline) for free-text notes about vehicle condition
- **GPS location capture:**
  - On appear: request location via InspectionLocationManager (from Horizon pattern, adapted)
  - Display: latitude, longitude, reverse-geocoded address
  - Timestamp: current date/time formatted
  - GPS icon with "Location captured" or "Capturing location..." state
  - Use CoreLocation CLLocationManager with requestWhenInUseAuthorization
- **Location display card:** Map pin icon, address text, coordinates, timestamp
- All values bound to inspection state (passed from InspectionView parent)

**SignaturePadView.swift:**
Reusable signature capture component (used in steps 5 and 6):

- Canvas-based drawing surface with white background
- Touch/drag gesture draws smooth lines (use Path with addLine/addCurve)
- Black ink, 2pt line width for signature
- "Clear" button to erase and start over
- "Done" button to finalize
- `@Binding var signatureImage: UIImage?` — exports the drawn signature as UIImage
- Export method: render the Canvas content to UIImage using UIGraphicsImageRenderer
- Minimum stroke detection: require at least 2 distinct strokes before allowing "Done" (prevents empty signatures)
- Border around drawing area, instructional text "Sign here" in light gray placeholder
- Aspect ratio approximately 3:1 (signature box, not square)
  </action>
  <verify>InspectionNotesView captures odometer, interior condition, notes, and GPS. SignaturePadView allows drawing and exports to UIImage.</verify>
  <done>Notes capture with GPS and reusable signature pad component ready for driver and customer sign-off</done>
</task>

<task type="auto">
  <name>Task 2: Build DriverReviewView (step 5) and CustomerSignOffView (step 6)</name>
  <files>
    VroomXDriver/Views/Inspection/DriverReviewView.swift
    VroomXDriver/Views/Inspection/CustomerReviewView.swift
    VroomXDriver/Views/Inspection/CustomerSignOffView.swift
  </files>
  <action>
**DriverReviewView.swift:**
Step 5 — Driver reviews all inspection data and signs:

- **Summary sections** (read-only review):
  - Photo count: "{n} photos captured" with thumbnail strip (horizontal scroll of captured photos)
  - Video: "Walkthrough video recorded" or "No video" indicator
  - Exterior damages: "X damages marked across Y views" with damage type breakdown
  - Notes: odometer reading, interior condition, custom notes
  - Location: GPS address and timestamp
- **Driver certification text:** "I, {driver_name}, certify that the above inspection accurately reflects the condition of the vehicle at the time of {pickup/delivery}."
- **SignaturePadView** for driver signature
- **"Sign & Continue" button:** Enabled only when signature is captured. On tap: saves driver signature image locally, uploads to Supabase Storage (`inspection-media/{inspectionId}/driver_signature.png`), and advances to step 6.

**CustomerReviewView.swift:**
Step 6 substep — Customer views vehicle condition before signing:

- Simplified summary of inspection data for customer viewing:
  - Vehicle description (year make model)
  - Photo thumbnails (horizontal scroll)
  - Damage summary with diagram thumbnails showing marked locations
  - Odometer reading
- "Hand device to customer" instructional text
- Customer name text field (required before signature)
- Optional customer notes text field
- "Proceed to Sign" button -> navigates to CustomerSignOffView

**CustomerSignOffView.swift:**
Step 6 substep — Customer signature capture:

- Customer certification text: "I, {customer_name}, acknowledge the vehicle condition as described in this inspection report."
- SignaturePadView for customer signature
- **"Sign & Complete" button:** On tap:
  1. Save customer signature image locally and upload to Storage
  2. Save ALL inspection data to Supabase:
     - Update vehicle_inspections record: set odometer_reading, interior_condition, notes, gps fields, driver_signature_url, customer_signature_url, customer_name, customer_notes, status='completed', completed_at=now()
     - Insert all inspection_photos records (for any not already created)
     - Insert all inspection_damages records
     - Insert inspection_videos record (if video captured)
  3. Set inspection status to 'completed'
  4. Trigger navigation to BOL preview (Plan 10) — for now, show success screen with "Inspection Complete" and dismiss button
  5. Dismiss the inspection flow
- Error handling: if save fails (offline), queue via PendingActionsQueue and show "Inspection saved locally, will sync when online"
  </action>
  <verify>DriverReviewView shows inspection summary and captures driver signature. CustomerSignOffView captures customer signature and saves all inspection data to Supabase. Inspection marked as completed.</verify>
  <done>Full 6-step inspection flow complete: photos -> video -> exterior diagram -> notes -> driver sign -> customer sign -> data saved to DB</done>
</task>

</tasks>

<verification>
- All 6 inspection steps accessible in sequence from InspectionView
- Odometer reading stored as integer, GPS coordinates as doubles
- Both driver and customer signatures captured as images and uploaded to Storage
- All inspection data persisted to vehicle_inspections, inspection_photos, inspection_damages, inspection_videos tables
- Inspection status set to 'completed' with completed_at timestamp
- Offline handling: data saved locally if network unavailable
- Customer name required before signature
</verification>

<success_criteria>
- Driver can complete full 6-step inspection: photos, video, exterior damage marking, notes/GPS, driver signature, customer signature
- All data saved to database with correct relationships
- Signatures exported as images and uploaded to Storage
- Works offline (data queued for sync)
</success_criteria>

<output>
After completion, create `.planning/phases/06-ios-driver-app/06-09-SUMMARY.md`
</output>
