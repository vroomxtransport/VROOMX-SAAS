---
phase: 06-ios-driver-app
plan: 03
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - VroomXDriver/Core/AuthManager.swift
  - VroomXDriver/Views/Auth/LoginView.swift
  - VroomXDriver/Views/Main/ContentView.swift
  - VroomXDriver/Views/Main/MainTabView.swift
  - VroomXDriver/VroomXDriverApp.swift
autonomous: true

must_haves:
  truths:
    - "Driver can enter email and receive OTP code"
    - "Driver can verify OTP and be authenticated"
    - "After login, app shows MainTabView with 5 tabs"
    - "After first login, driver sets up a 4-digit PIN for quick access"
    - "On subsequent launches, PIN entry screen shown if biometric fails or is unavailable"
    - "Biometric unlock works after initial PIN setup"
    - "Logout clears all cached data and returns to login screen"
    - "Driver record is fetched by auth_user_id after authentication"
  artifacts:
    - path: "VroomXDriver/Core/AuthManager.swift"
      provides: "Email OTP auth, biometric unlock, session management, driver record linking"
      contains: "signInWithOTP"
    - path: "VroomXDriver/Views/Auth/LoginView.swift"
      provides: "Login UI with email OTP, PIN setup, PIN entry, and biometric prompt"
      contains: "LoginView"
    - path: "VroomXDriver/Views/Main/MainTabView.swift"
      provides: "5-tab navigation matching CONTEXT.md spec"
      contains: "TabView"
  key_links:
    - from: "VroomXDriver/Core/AuthManager.swift"
      to: "VroomXDriver/Core/SupabaseManager.swift"
      via: "SupabaseManager.shared.client.auth"
      pattern: "SupabaseManager\\.shared"
    - from: "VroomXDriver/Views/Main/ContentView.swift"
      to: "VroomXDriver/Core/AuthManager.swift"
      via: "isAuthenticated state drives login vs main view"
      pattern: "isAuthenticated"
---

<objective>
Build the complete authentication flow (email OTP + biometric + PIN) and the app shell (ContentView routing + 5-tab MainTabView).

Purpose: Authentication is the gateway to the entire app. The 5-tab shell provides the navigation structure that all subsequent view plans plug into.

Output: Working auth flow, content routing, and 5-tab navigation shell with placeholder views
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/06-ios-driver-app/06-CONTEXT.md
@.planning/phases/06-ios-driver-app/06-RESEARCH.md
@.planning/phases/06-ios-driver-app/06-01-SUMMARY.md
@.planning/phases/06-ios-driver-app/06-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build AuthManager with email OTP, biometric unlock, and session management</name>
  <files>VroomXDriver/Core/AuthManager.swift</files>
  <action>
Create `AuthManager: ObservableObject` with:

**Published state:**
- `isAuthenticated: Bool = false`
- `currentDriver: VroomXDriver?` (the linked driver record)
- `isLoading: Bool = false`
- `error: String?`
- `authState: AuthState` enum (unauthenticated, awaitingOTP, authenticated, biometricAvailable)

**Email OTP flow:**
- `sendOTP(email: String) async throws` — calls `SupabaseManager.shared.client.auth.signInWithOTP(email: email)`, sets authState to .awaitingOTP
- `verifyOTP(email: String, code: String) async throws` — calls `client.auth.verifyOTP(email: email, token: code, type: .email)`, then fetches driver record
- On successful verify: store session refresh token in Keychain (using KeychainAccess), fetch driver record by auth_user_id

**Driver record linking:**
- `fetchDriverRecord(authUserId: String) async` — query drivers table where auth_user_id = authUserId. If found, set currentDriver and isAuthenticated=true. If NOT found, set error = "Driver account not found. Contact your dispatcher."
- Cache driver record via CacheManager for offline access

**Biometric unlock (Face ID / Touch ID):**
- `setupBiometric() async` — after successful OTP login, prompt LAContext.evaluatePolicy. If user approves, flag in UserDefaults that biometric is enabled
- `authenticateWithBiometrics() async -> Bool` — use LAContext to verify, if success restore session from Keychain, re-validate with Supabase
- On app launch: if biometric enabled and session token in Keychain, attempt biometric auth first

**PIN quick-access:**
- `setupPIN(pin: String) async throws` — hash PIN (SHA256), store hash in Keychain AND update drivers.pin_hash in DB
- `verifyPIN(pin: String) async -> Bool` — compare hash with stored hash in Keychain (offline) or DB (online)

**Session management:**
- `restoreSession() async` — check if Supabase session is valid, if expired attempt refresh
- `logout() async` — clear Keychain tokens, clear CacheManager.shared.clearAllCache(), sign out from Supabase, set isAuthenticated=false, currentDriver=nil

**Important:** Use `@MainActor` for all Published property updates. Import LocalAuthentication, KeychainAccess, Supabase.
  </action>
  <verify>AuthManager has sendOTP, verifyOTP, authenticateWithBiometrics, logout methods. isAuthenticated drives app state. Keychain used for tokens (not UserDefaults).</verify>
  <done>AuthManager handles complete auth lifecycle: email OTP -> biometric setup -> session persistence -> logout with cache clearing</done>
</task>

<task type="auto">
  <name>Task 2: Build LoginView, ContentView routing, and MainTabView shell</name>
  <files>
    VroomXDriver/Views/Auth/LoginView.swift
    VroomXDriver/Views/Main/ContentView.swift
    VroomXDriver/Views/Main/MainTabView.swift
    VroomXDriver/VroomXDriverApp.swift
  </files>
  <action>
**LoginView.swift:**
- Multi-phase UI with 3 possible entry paths:
- **Path A — First login (email OTP):**
  - Phase 1: VroomX logo/wordmark, email TextField, "Send Code" Button. Validate email format before sending.
  - Phase 2: 6-digit OTP input field (TextField with keyboardType .numberPad), "Verify" Button, "Resend Code" link
  - Phase 3 (after successful OTP): PIN setup screen — "Set a 4-digit PIN for quick access" with 4-digit PIN entry (masked dots), confirm PIN entry, "Set PIN" button. Calls authManager.setupPIN(pin:). After PIN setup, prompt biometric setup.
- **Path B — Returning user (PIN entry):**
  - If a PIN exists in Keychain (user has logged in before) AND biometric is unavailable or fails:
  - Show VroomX logo, "Welcome back, {driver_name}" greeting, 4-digit PIN entry field (numberPad, masked dots), "Unlock" button
  - On verify: calls authManager.verifyPIN(pin:) -> if valid, restore session from Keychain
  - "Forgot PIN? Sign in with email" link -> switches to Path A
- **Path C — Returning user (biometric):**
  - Show biometric unlock button if previously authenticated (Face ID icon)
  - If biometric fails or is cancelled, fall back to Path B (PIN entry)
- Launch logic in ContentView: if session + PIN exist -> try biometric first -> fallback to PIN -> fallback to email OTP
- Loading spinner during async operations
- Error banner for auth failures
- Use VroomX theme colors (brandPrimary blue background accents, dark mode default)
- `@EnvironmentObject var authManager: AuthManager`

**ContentView.swift:**
- Root view that switches between LoginView and MainTabView based on `authManager.isAuthenticated`
- On appear: attempt `authManager.restoreSession()` — if session valid, skip login
- If biometric enabled: show biometric prompt first
- Splash/loading state while session is being restored

**MainTabView.swift:**
- 5-tab TabView matching CONTEXT.md spec:
  1. Home tab — SF Symbol `house.fill`, label "Home" — placeholder `Text("Home")`
  2. Trips tab — SF Symbol `shippingbox.fill`, label "Trips" — placeholder `Text("Trips")`
  3. Earnings tab — SF Symbol `wallet.pass.fill`, label "Earnings" — placeholder `Text("Earnings")`
  4. Messages tab — SF Symbol `message.fill`, label "Messages" — placeholder `Text("Messages")`
  5. Profile tab — SF Symbol `person.fill`, label "Profile" — placeholder `Text("Profile")`
- Tab bar tint color: Color.brandPrimary
- `@EnvironmentObject var authManager: AuthManager` available to all child views

**Update VroomXDriverApp.swift:**
- Create ThemeManager and AuthManager as @StateObject
- Inject both as environmentObject into ContentView
- Apply colorScheme from ThemeManager
- Set up NetworkMonitor as environment object
  </action>
  <verify>
    - App entry point creates and injects ThemeManager, AuthManager, NetworkMonitor
    - ContentView shows LoginView when unauthenticated, MainTabView when authenticated
    - MainTabView has exactly 5 tabs with correct SF Symbols
    - LoginView has email entry, OTP verification, PIN setup, and PIN entry phases
    - Returning users see PIN entry (or biometric) instead of email OTP
  </verify>
  <done>Complete auth UI + app shell: driver can log in via email OTP, set up PIN, unlock via PIN/biometric on return, sees 5-tab navigation, can log out</done>
</task>

</tasks>

<verification>
- AuthManager uses Supabase SDK for OTP (not raw HTTP)
- Tokens stored in Keychain (not UserDefaults)
- Logout clears ALL cached data (CacheManager.clearAllCache)
- Driver record fetched by auth_user_id (not email matching)
- MainTabView has exactly 5 tabs: Home, Trips, Earnings, Messages, Profile
- VroomX branding (blue/violet, not green)
</verification>

<success_criteria>
- Driver can enter email, receive OTP, verify code, set up 4-digit PIN, and reach the 5-tab main screen
- On subsequent launches, driver unlocks via biometric or PIN (no email OTP required)
- If biometric unavailable or fails, PIN entry screen shown as fallback
- Biometric unlock available after initial PIN setup
- Logout returns to login screen with all cache cleared
- App shell provides navigation structure for all subsequent view plans
</success_criteria>

<output>
After completion, create `.planning/phases/06-ios-driver-app/06-03-SUMMARY.md`
</output>
