---
phase: 06-ios-driver-app
plan: 08
type: execute
wave: 4
depends_on: ["06-07"]
files_modified:
  - VroomXDriver/Views/Inspection/InspectionView.swift
  - VroomXDriver/Views/Inspection/InspectionPhotoView.swift
  - VroomXDriver/Views/Inspection/InspectionVideoCaptureView.swift
  - VroomXDriver/Views/Inspection/ExteriorInspectionView.swift
  - VroomXDriver/Views/Inspection/VehicleDiagrams.swift
  - VroomXDriver/Views/Inspection/VehicleDiagramView.swift
autonomous: true

must_haves:
  truths:
    - "6-step inspection flow progresses linearly from photos to customer sign-off"
    - "Photo capture supports 7 required + 5 optional photos with camera interface"
    - "Video capture is REQUIRED (step 2 of 6-step workflow per CONTEXT.md) — driver must record walkthrough video before proceeding"
    - "Exterior inspection shows interactive vehicle diagram with 5 views (front/rear/left/right/top)"
    - "Damage markers can be placed on vehicle diagram by tapping/dragging"
    - "5 damage types available: Scratch(S), Dent(D), Chip(C), Broken(B), Missing(M)"
  artifacts:
    - path: "VroomXDriver/Views/Inspection/InspectionView.swift"
      provides: "6-step inspection flow controller"
      contains: "InspectionStep"
    - path: "VroomXDriver/Views/Inspection/ExteriorInspectionView.swift"
      provides: "Interactive SVG vehicle diagram with damage marker placement"
      contains: "ExteriorInspectionView"
    - path: "VroomXDriver/Views/Inspection/VehicleDiagrams.swift"
      provides: "Vehicle outline diagrams for 5 vehicle types"
      contains: "VehicleDiagrams"
  key_links:
    - from: "VroomXDriver/Views/Inspection/InspectionView.swift"
      to: "VroomXDriver/Core/DataManager.swift"
      via: "Creates vehicle_inspections record on start"
      pattern: "SupabaseManager\\.shared"
    - from: "VroomXDriver/Views/Inspection/InspectionPhotoView.swift"
      to: "VroomXDriver/Core/InspectionUploadQueue.swift"
      via: "Queues photo uploads"
      pattern: "InspectionUploadQueue"
---

<objective>
Build inspection steps 1-3: photo capture (7 required + 5 optional), video walkthrough, and exterior inspection with interactive vehicle damage diagrams.

Purpose: The vehicle inspection workflow is the core differentiator of the driver app. Steps 1-3 capture visual evidence of vehicle condition at pickup/delivery.

Output: InspectionView flow controller, photo capture, video capture, exterior diagram with damage markers
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/06-ios-driver-app/06-CONTEXT.md
@.planning/phases/06-ios-driver-app/06-RESEARCH.md
@.planning/phases/06-ios-driver-app/06-04-SUMMARY.md
@.planning/phases/06-ios-driver-app/06-07-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build InspectionView flow controller and photo/video capture</name>
  <files>
    VroomXDriver/Views/Inspection/InspectionView.swift
    VroomXDriver/Views/Inspection/InspectionPhotoView.swift
    VroomXDriver/Views/Inspection/InspectionVideoCaptureView.swift
  </files>
  <action>
**InspectionView.swift:**
- Takes `order: VroomXOrder` and `inspectionType: InspectionType` (pickup or delivery) as input
- Creates vehicle_inspections record in Supabase on first appearance (or loads existing if in_progress)
- 6-step flow managed by `@State var currentStep: InspectionStep` (from Enums.swift):
  1. .photos -> InspectionPhotoView
  2. .video -> InspectionVideoCaptureView
  3. .exterior -> ExteriorInspectionView
  4. .notes -> InspectionNotesView (Plan 09)
  5. .driverReview -> DriverReviewView (Plan 09)
  6. .customerReview -> CustomerSignOffView (Plan 09)
- Step indicator at top: horizontal row of 6 circles, filled for completed, ring for current, gray for future. Step label below.
- "Next" and "Back" navigation buttons at bottom
- Step validation: photos step requires all 7 required photos before allowing next; video step requires a recorded video before allowing next (all 6 steps are required per CONTEXT.md)
- Dismiss confirmation if inspection is incomplete ("Discard inspection?")
- Local state holds all inspection data (photos, damages, notes, signatures) until completion
- Use @State arrays/dictionaries for photos, damages, video recorded status

**InspectionPhotoView.swift:**
- Takes inspection state bindings for photo data
- Grid layout of photo slots: 7 required + 5 optional
- Required photos: Odometer, Front, Left, Right, Rear, Top, Key/VIN
- Optional photos: Custom 1-5 (labeled "Additional {n}")
- Each slot shows:
  - Empty state: camera icon + photo type label, tap to capture
  - Captured state: thumbnail of photo, tap to retake or view full size
  - Upload status indicator (checkmark for uploaded, spinner for uploading, exclamation for failed)
- Camera capture: Use UIImagePickerController wrapped in UIViewControllerRepresentable (or SwiftUI PhotosPicker for library fallback)
  - Set sourceType to .camera
  - After capture: save image locally (Documents directory), queue upload via InspectionUploadQueue
  - Generate thumbnail for display
- Validation: all 7 required slots must have photos before allowing "Next"
- Photo paths stored locally and in InspectionUploadQueue for background upload
- Compress images to 80% JPEG quality before upload

**InspectionVideoCaptureView.swift:**
- Video recording interface for vehicle walkthrough
- **REQUIRED step** — CONTEXT.md specifies a 6-step inspection workflow, video capture is step 2. Driver MUST record a video before advancing to step 3. No skip option.
- Use AVFoundation camera preview (UIViewRepresentable wrapping AVCaptureVideoPreviewLayer)
- Record button (red circle, tap to start/stop)
- Recording timer display (elapsed time)
- Minimum duration: 5 seconds (prevent accidental taps from counting as valid video)
- Maximum duration: 5 minutes
- After recording: save video locally, queue upload via InspectionUploadQueue
- Video preview: thumbnail of first frame + duration label
- Option to re-record (delete current and record again), but NOT to skip
- "Next" button disabled until a video has been recorded
  </action>
  <verify>InspectionView navigates through 6 steps with progress indicator. Photo capture has 12 slots (7 required). Video capture records and saves locally. Upload queue receives media items.</verify>
  <done>Inspection flow controller manages 6-step progression; photo and video capture save locally and queue uploads</done>
</task>

<task type="auto">
  <name>Task 2: Build exterior inspection with interactive vehicle damage diagrams</name>
  <files>
    VroomXDriver/Views/Inspection/ExteriorInspectionView.swift
    VroomXDriver/Views/Inspection/VehicleDiagrams.swift
    VroomXDriver/Views/Inspection/VehicleDiagramView.swift
  </files>
  <action>
**VehicleDiagrams.swift:**
- Provides vehicle outline shapes for 5 vehicle types: sedan, SUV, pickup truck, van, minivan
- Each diagram is a set of SwiftUI Path objects or pre-rendered images in Assets.xcassets
- Reference Horizon Star's VehicleDiagrams.swift for the outline shapes but adapt for VroomX
- Expose as a function: `static func diagramImage(for vehicleType: String) -> Image` that returns the appropriate vehicle outline
- Vehicle type mapping from VroomX vehicle_type field to diagram type (sedan=default, SUV, truck/pickup, van, minivan)
- Diagrams should be clean line-art style suitable for damage marker overlay
- 5 views per vehicle: Front, Rear, Left Side, Right Side, Top

**VehicleDiagramView.swift:**
- Interactive diagram component:
  - Takes `vehicleType: String`, `currentView: String` (front/rear/left/right/top), `damages: Binding<[InspectionDamage]>`
  - Displays the vehicle outline for the current view
  - Tap gesture on the diagram: adds a damage marker at the tap location
  - Damage marker: small colored circle with damage type initial (S/D/C/B/M)
  - Marker colors: Scratch=orange, Dent=red, Chip=blue, Broken=purple, Missing=pink
  - Long-press a marker to edit (change type) or delete
  - Drag gesture to reposition markers
  - Damage coordinates stored as normalized x/y (0-1 range) relative to diagram bounds
  - Current damage type selector: horizontal row of 5 buttons (one per damage type) with color indicators

**ExteriorInspectionView.swift:**
- 5-tab view selector at top: Front, Rear, Left, Right, Top (segmented control or horizontal scroll)
- VehicleDiagramView for the selected view
- Damage type selector (5 types) below the diagram
- Damage list below diagram: shows all damages for current view with type, position description
- Summary count: "X damages marked" total across all views
- Instructions text: "Tap on the vehicle diagram to mark damage locations"
- Takes inspection state bindings for damages array
- On "Next": save all damages to local inspection state (persisted to DB on completion in Plan 09)
  </action>
  <verify>VehicleDiagrams provides outlines for 5 vehicle types. VehicleDiagramView allows tap-to-place, drag, and delete damage markers. ExteriorInspectionView has 5-view selector and damage type picker.</verify>
  <done>Interactive vehicle damage inspection with 5-view diagrams, drag-and-drop damage markers, and 5 damage types matching CONTEXT.md spec</done>
</task>

</tasks>

<verification>
- Inspection creates a record in vehicle_inspections table
- 7 required photo slots enforced before progressing past step 1
- Video capture uses AVFoundation (not just photo library), is REQUIRED (no skip button)
- Damage markers are color-coded by type with correct initials
- Damage positions stored as normalized coordinates (0-1 range)
- 5 vehicle views available in exterior inspection
- All media queued to InspectionUploadQueue for background upload
</verification>

<success_criteria>
- Driver can capture 7 required + 5 optional photos of the vehicle
- Driver must record a walkthrough video (required, not skippable)
- Driver can view vehicle diagrams from 5 angles and place damage markers
- Damage markers are interactive (tap to place, drag to move, long-press to edit/delete)
- Media uploads happen in background via upload queue
</success_criteria>

<output>
After completion, create `.planning/phases/06-ios-driver-app/06-08-SUMMARY.md`
</output>
