---
phase: 06-ios-driver-app
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00006_driver_app_tables.sql
  - VroomXDriver/VroomXDriver.xcodeproj
  - VroomXDriver/VroomXDriverApp.swift
  - VroomXDriver/Config.swift
  - VroomXDriver/Info.plist
autonomous: true

must_haves:
  truths:
    - "VroomX database has vehicle_inspections, inspection_photos, inspection_videos, inspection_damages, order_attachments, driver_notifications, and device_tokens tables with RLS"
    - "Drivers table has auth_user_id column linking Supabase Auth users to driver records"
    - "Orders table has pickup_eta and delivery_eta columns"
    - "Trip_expenses table has receipt_url column for receipt photo storage"
    - "Xcode project builds with supabase-swift SDK imported"
    - "Storage buckets exist for inspection-media, receipts, and bol-documents"
  artifacts:
    - path: "supabase/migrations/00006_driver_app_tables.sql"
      provides: "All new tables, columns, RLS policies, indexes, and storage bucket setup for iOS driver app"
      contains: "vehicle_inspections"
    - path: "VroomXDriver/VroomXDriverApp.swift"
      provides: "SwiftUI app entry point"
    - path: "VroomXDriver/Config.swift"
      provides: "Supabase URL and anon key configuration"
  key_links:
    - from: "supabase/migrations/00006_driver_app_tables.sql"
      to: "supabase/migrations/00002_core_entities.sql"
      via: "ALTER TABLE drivers ADD COLUMN auth_user_id"
      pattern: "auth_user_id"
    - from: "VroomXDriver/Config.swift"
      to: "Supabase project"
      via: "URL and anon key constants"
      pattern: "supabaseURL"
---

<objective>
Create the database migration for all iOS driver app tables and scaffold the Xcode SwiftUI project with Supabase Swift SDK.

Purpose: The iOS app requires 7 new database tables (inspections, photos, videos, damages, attachments, notifications, device tokens), 3 new columns on existing tables, and 3 storage buckets. The Xcode project scaffold provides the foundation for all subsequent iOS plans.

Output: SQL migration file + buildable Xcode project with Supabase SDK dependency
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ios-driver-app/06-RESEARCH.md
@supabase/migrations/00001_initial_schema.sql
@supabase/migrations/00002_core_entities.sql
@supabase/migrations/00003_trips_and_dispatch.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migration 00006_driver_app_tables.sql</name>
  <files>supabase/migrations/00006_driver_app_tables.sql</files>
  <action>
Create SQL migration with the following, matching existing VroomX RLS patterns (tenant_id column, `(SELECT public.get_tenant_id())` wrapper, authenticated role policies for SELECT/INSERT/UPDATE/DELETE):

**New enum types:**
- `inspection_type` AS ENUM ('pickup', 'delivery')
- `inspection_status` AS ENUM ('in_progress', 'completed')
- `damage_type` AS ENUM ('scratch', 'dent', 'chip', 'broken', 'missing')
- `photo_type` AS ENUM ('odometer', 'front', 'left', 'right', 'rear', 'top', 'key_vin', 'custom_1', 'custom_2', 'custom_3', 'custom_4', 'custom_5')
- `notification_type` AS ENUM ('trip_assignment', 'status_change', 'dispatch_message', 'urgent')

**New tables (all with tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE):**

1. `vehicle_inspections`:
   - id UUID PK DEFAULT gen_random_uuid()
   - tenant_id, order_id UUID REFERENCES orders(id), driver_id UUID REFERENCES drivers(id)
   - inspection_type (enum), status (inspection_status enum, default 'in_progress')
   - odometer_reading INTEGER, interior_condition TEXT, notes TEXT
   - gps_latitude DOUBLE PRECISION, gps_longitude DOUBLE PRECISION, gps_address TEXT
   - driver_signature_url TEXT, customer_signature_url TEXT
   - customer_name TEXT, customer_notes TEXT
   - completed_at TIMESTAMPTZ
   - created_at, updated_at (standard timestamps)

2. `inspection_photos`:
   - id UUID PK, tenant_id, inspection_id UUID REFERENCES vehicle_inspections(id) ON DELETE CASCADE
   - photo_type (enum), storage_path TEXT NOT NULL, thumbnail_path TEXT
   - upload_status TEXT DEFAULT 'pending' (pending/uploaded/failed)
   - created_at TIMESTAMPTZ

3. `inspection_videos`:
   - id UUID PK, tenant_id, inspection_id UUID REFERENCES vehicle_inspections(id) ON DELETE CASCADE
   - storage_path TEXT NOT NULL, duration_seconds INTEGER
   - upload_status TEXT DEFAULT 'pending'
   - created_at TIMESTAMPTZ

4. `inspection_damages`:
   - id UUID PK, tenant_id, inspection_id UUID REFERENCES vehicle_inspections(id) ON DELETE CASCADE
   - damage_type (enum), view TEXT NOT NULL (front/rear/left/right/top)
   - x_position DOUBLE PRECISION NOT NULL, y_position DOUBLE PRECISION NOT NULL
   - description TEXT
   - created_at TIMESTAMPTZ

5. `order_attachments`:
   - id UUID PK, tenant_id, order_id UUID REFERENCES orders(id) ON DELETE CASCADE
   - file_name TEXT NOT NULL, file_type TEXT NOT NULL (bol_pdf/receipt/photo/document)
   - storage_path TEXT NOT NULL, file_size INTEGER
   - uploaded_by UUID REFERENCES auth.users(id)
   - created_at TIMESTAMPTZ

6. `driver_notifications`:
   - id UUID PK, tenant_id, driver_id UUID REFERENCES drivers(id)
   - notification_type (enum), title TEXT NOT NULL, body TEXT NOT NULL
   - data JSONB DEFAULT '{}'
   - read_at TIMESTAMPTZ, created_at TIMESTAMPTZ

7. `device_tokens`:
   - id UUID PK, tenant_id, driver_id UUID REFERENCES drivers(id)
   - device_token TEXT NOT NULL, platform TEXT NOT NULL DEFAULT 'ios'
   - last_active_at TIMESTAMPTZ DEFAULT now()
   - created_at TIMESTAMPTZ
   - UNIQUE(driver_id, device_token)

**ALTER existing tables:**
- `ALTER TABLE public.drivers ADD COLUMN auth_user_id UUID REFERENCES auth.users(id);`
- `ALTER TABLE public.drivers ADD COLUMN pin_hash TEXT;`
- `CREATE UNIQUE INDEX idx_drivers_auth_user_id ON public.drivers(auth_user_id) WHERE auth_user_id IS NOT NULL;`
- `ALTER TABLE public.orders ADD COLUMN pickup_eta TIMESTAMPTZ;`
- `ALTER TABLE public.orders ADD COLUMN delivery_eta TIMESTAMPTZ;`
- `ALTER TABLE public.trip_expenses ADD COLUMN receipt_url TEXT;` (receipt photo storage path for Supabase Storage `receipts` bucket)

**For each new table:** Add RLS enable, 4 policies (select/insert/update/delete) matching the VroomX pattern, indexes on tenant_id + relevant foreign keys, updated_at triggers (for vehicle_inspections), and GRANT SELECT TO supabase_realtime.

**Add Realtime publication** for vehicle_inspections, driver_notifications.

**Storage buckets** (as SQL comments noting they need manual creation in Supabase Dashboard or via CLI):
```sql
-- NOTE: Create these storage buckets via Supabase Dashboard or CLI:
-- 1. inspection-media (private)
-- 2. receipts (private)
-- 3. bol-documents (private)
-- Storage RLS policies should check tenant_id from JWT
```
  </action>
  <verify>
    Verify SQL syntax is valid by checking migration file exists and has proper structure:
    - All 7 CREATE TABLE statements present
    - All 4 ALTER TABLE statements present (drivers x2, orders x2, trip_expenses x1)
    - RLS ENABLE + 4 policies per table
    - Indexes on tenant_id for each table
    - Realtime publication for vehicle_inspections and driver_notifications
  </verify>
  <done>Migration file creates all required tables, alters existing tables, and establishes RLS policies matching VroomX conventions</done>
</task>

<task type="auto">
  <name>Task 2: Scaffold Xcode SwiftUI project with Supabase SDK</name>
  <files>
    VroomXDriver/VroomXDriverApp.swift
    VroomXDriver/Config.swift
    VroomXDriver/Info.plist
    VroomXDriver/Package.swift
  </files>
  <action>
Create the VroomXDriver/ directory at the project root (sibling to src/, supabase/).

**Only create the root directory and these 4 files. Do NOT create subdirectories â€” subsequent plans create their own directories as needed (06-02 creates Models/, Theme/, Core/; 06-03 creates Views/Auth/, Views/Main/; etc.).**

**Create VroomXDriver/Package.swift** (Swift Package Manager):
```swift
// swift-tools-version: 5.9
import PackageDescription

let package = Package(
    name: "VroomXDriver",
    platforms: [.iOS(.v17)],
    dependencies: [
        .package(url: "https://github.com/supabase/supabase-swift.git", from: "2.41.0"),
        .package(url: "https://github.com/kishikawakatsumi/KeychainAccess.git", from: "4.2.2"),
    ],
    targets: [
        .executableTarget(
            name: "VroomXDriver",
            dependencies: [
                .product(name: "Supabase", package: "supabase-swift"),
                .product(name: "KeychainAccess", package: "KeychainAccess"),
            ]
        ),
    ]
)
```

NOTE: The actual Xcode project will be created by the developer via Xcode IDE (File > New > Project > iOS App > SwiftUI). The Package.swift above documents the dependencies. For the plan, create the directory structure and source files that will be added to the Xcode project.

**VroomXDriverApp.swift:**
```swift
import SwiftUI

@main
struct VroomXDriverApp: App {
    var body: some Scene {
        WindowGroup {
            Text("VroomX Driver") // Placeholder until ContentView is built in Plan 03
        }
    }
}
```

**Config.swift:**
```swift
import Foundation

enum Config {
    // MARK: - Supabase Configuration
    // These values come from the VroomX Supabase project dashboard
    static let supabaseURL = "YOUR_SUPABASE_URL"  // Replace with actual project URL
    static let supabaseAnonKey = "YOUR_SUPABASE_ANON_KEY"  // Replace with actual anon key

    // MARK: - App Constants
    static let appName = "VroomX Driver"
    static let appVersion = "1.0.0"

    // MARK: - Storage Buckets
    static let inspectionMediaBucket = "inspection-media"
    static let receiptsBucket = "receipts"
    static let bolDocumentsBucket = "bol-documents"

    // MARK: - Keychain
    static let keychainService = "com.vroomx.driver"
    static let keychainSessionKey = "supabase_session"
    static let keychainPINKey = "driver_pin"

    // MARK: - Cache Keys
    static let cachedTripsKey = "cached_trips"
    static let cachedOrdersKey = "cached_orders"
    static let cachedExpensesKey = "cached_expenses"
    static let cachedDriverKey = "cached_driver"
}
```
  </action>
  <verify>
    Verify directory structure exists:
    - VroomXDriver/ directory at project root
    - VroomXDriverApp.swift, Config.swift, Info.plist, and Package.swift exist
    - Package.swift with supabase-swift and KeychainAccess dependencies
    - No premature subdirectories (subdirectories created by plans that need them)
  </verify>
  <done>Xcode project scaffold exists with entry point, config, and dependency declarations. Subdirectories deferred to consuming plans.</done>
</task>

</tasks>

<verification>
- Migration file exists at supabase/migrations/00006_driver_app_tables.sql
- All 7 new tables defined with tenant_id and RLS
- drivers table gets auth_user_id and pin_hash columns
- orders table gets pickup_eta and delivery_eta columns
- VroomXDriver/ root directory created with 4 source files (no premature subdirectories)
- VroomXDriverApp.swift and Config.swift are valid Swift
</verification>

<success_criteria>
- Database migration covers all inspection, notification, and attachment tables needed by the iOS app
- Xcode project scaffold provides root directory and entry files; subdirectories created by consuming plans
- Supabase Swift SDK dependency is declared
- No overlap with subsequent plans' file ownership
</success_criteria>

<output>
After completion, create `.planning/phases/06-ios-driver-app/06-01-SUMMARY.md`
</output>
