---
phase: 04-billing-invoicing
plan: 05
type: execute
wave: 3
depends_on: ["04-02", "04-03"]
files_modified:
  - src/components/layout/sidebar.tsx
  - src/app/(dashboard)/billing/page.tsx
  - src/app/(dashboard)/billing/_components/receivables-table.tsx
  - src/app/(dashboard)/billing/_components/aging-table.tsx
  - src/app/(dashboard)/billing/_components/batch-actions.tsx
  - src/app/(dashboard)/billing/_components/collection-rate.tsx
  - src/app/(dashboard)/brokers/[id]/page.tsx
  - src/app/(dashboard)/brokers/_components/broker-receivables.tsx
autonomous: true
user_setup:
  - service: resend
    why: "Email delivery for invoices"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard -> API Keys -> Create API Key"
      - name: RESEND_FROM_EMAIL
        source: "Your verified domain email (e.g., invoices@yourdomain.com). Falls back to onboarding@resend.dev for development."
    dashboard_config:
      - task: "Verify a sending domain (for production)"
        location: "Resend Dashboard -> Domains -> Add Domain"

must_haves:
  truths:
    - "Billing page shows broker-grouped receivables with total owed, invoice count, and overdue amounts"
    - "Aging analysis displays color-coded bucket columns per broker"
    - "Batch send invoices sends individual emails to selected unpaid orders"
    - "Batch mark paid records full payment for selected orders"
    - "Collection rate metric shows percentage of invoiced amount collected"
    - "Sidebar navigation shows 'Billing' at /billing instead of 'Invoices' at /invoices"
    - "Broker detail page shows a receivables section with outstanding invoices for that broker"
  artifacts:
    - path: "src/app/(dashboard)/billing/page.tsx"
      provides: "Billing page with receivables, aging, and collection rate"
      contains: "BillingPage"
    - path: "src/app/(dashboard)/billing/_components/receivables-table.tsx"
      provides: "Broker-grouped receivables table with expandable rows"
      contains: "ReceivablesTable"
    - path: "src/app/(dashboard)/billing/_components/aging-table.tsx"
      provides: "Color-coded aging analysis by broker"
      contains: "AgingTable"
    - path: "src/app/(dashboard)/billing/_components/batch-actions.tsx"
      provides: "Batch send invoices and mark paid toolbar"
      contains: "BatchActions"
    - path: "src/app/(dashboard)/billing/_components/collection-rate.tsx"
      provides: "Collection rate metric card"
      contains: "CollectionRate"
    - path: "src/components/layout/sidebar.tsx"
      provides: "Updated sidebar with Billing nav item"
      contains: "Billing"
    - path: "src/app/(dashboard)/brokers/_components/broker-receivables.tsx"
      provides: "Receivables section for broker detail page"
      contains: "BrokerReceivables"
    - path: "src/app/(dashboard)/brokers/[id]/page.tsx"
      provides: "Updated broker detail page with receivables section"
      contains: "BrokerReceivables"
  key_links:
    - from: "src/app/(dashboard)/billing/page.tsx"
      to: "src/lib/queries/receivables.ts"
      via: "Server-side data fetching"
      pattern: "fetchBrokerReceivables|fetchAgingAnalysis|fetchCollectionRate"
    - from: "src/app/(dashboard)/billing/_components/batch-actions.tsx"
      to: "src/app/actions/payments.ts"
      via: "batchMarkPaid server action"
      pattern: "batchMarkPaid"
    - from: "src/app/(dashboard)/billing/_components/batch-actions.tsx"
      to: "/api/invoices/[orderId]/send"
      via: "Individual fetch calls for batch invoice sending"
      pattern: "api/invoices.*send"
    - from: "src/components/layout/sidebar.tsx"
      to: "/billing"
      via: "Navigation link"
      pattern: "href.*billing"
    - from: "src/app/(dashboard)/brokers/[id]/page.tsx"
      to: "src/app/(dashboard)/brokers/_components/broker-receivables.tsx"
      via: "Component composition in broker detail"
      pattern: "BrokerReceivables"
---

<objective>
Build the Billing page with broker-grouped receivables table, aging analysis, batch actions (send invoices, mark paid), and collection rate metric. Update sidebar navigation from "Invoices" to "Billing".

Purpose: This is the primary financial dashboard — dispatchers see who owes money, how much, and how long overdue. Batch operations save time on high-volume payment processing. This completes the billing UI.

Output: Full billing page at `/billing` with receivables table, aging analysis, batch actions, collection rate, and updated sidebar navigation.
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-billing-invoicing/04-CONTEXT.md
@.planning/phases/04-billing-invoicing/04-RESEARCH.md
@.planning/phases/04-billing-invoicing/04-02-SUMMARY.md
@.planning/phases/04-billing-invoicing/04-03-SUMMARY.md
@src/components/layout/sidebar.tsx
@src/lib/queries/receivables.ts
@src/app/actions/payments.ts
@src/app/(dashboard)/dispatch/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update sidebar navigation and create billing page shell</name>
  <files>
    src/components/layout/sidebar.tsx
    src/app/(dashboard)/billing/page.tsx
    src/app/(dashboard)/billing/_components/collection-rate.tsx
  </files>
  <action>
    **Step 1: Update sidebar.tsx**

    Change the "Invoices" nav item to "Billing":
    ```typescript
    // Before:
    { name: 'Invoices', href: '/invoices', icon: Receipt, minRole: 'admin' },
    // After:
    { name: 'Billing', href: '/billing', icon: Receipt, minRole: 'admin' },
    ```

    **Step 2: Create `src/app/(dashboard)/billing/page.tsx`**

    Server component page that fetches data and renders the billing dashboard.

    ```typescript
    import { createClient } from '@/lib/supabase/server'
    import { fetchBrokerReceivables, fetchAgingAnalysis, fetchCollectionRate } from '@/lib/queries/receivables'
    import { ReceivablesTable } from './_components/receivables-table'
    import { AgingTable } from './_components/aging-table'
    import { CollectionRate } from './_components/collection-rate'
    ```

    Page layout:
    1. **Header:** "Billing" title with collection rate metric card on the right
    2. **Receivables section:** ReceivablesTable with batch actions toolbar
    3. **Aging Analysis section:** AgingTable below receivables (same scroll, per CONTEXT.md)

    Fetch all three data sources server-side:
    ```typescript
    const supabase = await createClient()
    const [receivables, aging, collection] = await Promise.all([
      fetchBrokerReceivables(supabase),
      fetchAgingAnalysis(supabase),
      fetchCollectionRate(supabase),
    ])
    ```

    Wrap the client components in a `<BillingClient>` wrapper if needed for interactivity (checkbox state, batch actions). Alternatively, make the page a server component that passes data as props to client components.

    **Step 3: Create `src/app/(dashboard)/billing/_components/collection-rate.tsx`**

    A client component showing the collection rate metric.

    Props: `{ totalInvoiced: number; totalCollected: number; rate: number }`

    Display:
    - Large percentage number (e.g., "87%")
    - Label: "Collection Rate"
    - Sub-text: "$X collected of $Y invoiced"
    - Visual: circular progress indicator or simple bar
    - Color: green if >= 80%, amber if >= 60%, red if < 60%

    Use compact formatting for large numbers.
  </action>
  <verify>
    - `npx tsc --noEmit` compiles without errors
    - `grep 'Billing' src/components/layout/sidebar.tsx` returns match
    - `grep '/billing' src/components/layout/sidebar.tsx` returns match
    - `grep 'fetchBrokerReceivables' src/app/(dashboard)/billing/page.tsx` returns match
    - CollectionRate component renders rate as percentage
  </verify>
  <done>Sidebar shows "Billing" at /billing. Billing page fetches receivables, aging, and collection rate data server-side. Collection rate displays as a prominent metric card.</done>
</task>

<task type="auto">
  <name>Task 2: Create receivables table, aging table, and batch actions</name>
  <files>
    src/app/(dashboard)/billing/_components/receivables-table.tsx
    src/app/(dashboard)/billing/_components/aging-table.tsx
    src/app/(dashboard)/billing/_components/batch-actions.tsx
  </files>
  <action>
    **Step 1: Create `src/app/(dashboard)/billing/_components/receivables-table.tsx`**

    A `'use client'` component showing broker-grouped receivables.

    Props: `{ receivables: BrokerReceivable[] }`

    Layout:
    1. **Table with columns:**
       - Checkbox (for row selection — used by batch actions)
       - Broker Name (clickable, navigates to `/brokers/{id}` per CONTEXT.md)
       - Total Owed (formatted currency, right-aligned)
       - Invoice Count
       - Oldest Unpaid (formatted date)
       - Paid This Month (formatted currency)
       - Overdue Amount (formatted currency, red if > 0)

    2. **Expandable rows:** Clicking the expand icon on a broker row reveals the individual orders:
       - Order number, carrier pay, amount paid, remaining, payment status badge, invoice date
       - Each order row has its own checkbox for batch selection

    3. **State management:**
       - `selectedOrderIds: Set<string>` — tracks checked orders across all brokers
       - `expandedBrokers: Set<string>` — tracks which broker rows are expanded
       - Pass `selectedOrderIds` and `onSelectionChange` up to parent for batch actions

    4. **Empty state:** "No outstanding receivables" message.

    Use shadcn/ui Table, Checkbox components. Use `Intl.NumberFormat` for currency (follow existing `formatCurrency` pattern from order-detail.tsx).

    **Step 2: Create `src/app/(dashboard)/billing/_components/aging-table.tsx`**

    A `'use client'` component showing aging analysis.

    Props: `{ aging: AgingRow[] }`

    Layout:
    1. **Section header:** "Aging Analysis" with subtitle
    2. **Table with columns:**
       - Broker Name
       - Current (green text/bg)
       - 1-30 Days (yellow text/bg)
       - 31-60 Days (orange text/bg)
       - 61-90 Days (red text/bg)
       - 90+ Days (dark red text/bg)
       - Total

    3. **Color coding per CONTEXT.md:**
       - Current: `text-green-700 bg-green-50`
       - 1-30: `text-yellow-700 bg-yellow-50`
       - 31-60: `text-orange-700 bg-orange-50`
       - 61-90: `text-red-700 bg-red-50`
       - 90+: `text-red-900 bg-red-100`

    4. **Drill-down:** Clicking a bucket cell shows the specific orders for that broker/bucket. Implement as a modal or inline expand (Claude's discretion per CONTEXT.md). Recommended: inline expand showing order list below the clicked row.

    5. **Totals row:** Sum of all brokers per column at the bottom.

    6. **Empty state:** "No aging data — no invoiced orders found."

    **Step 3: Create `src/app/(dashboard)/billing/_components/batch-actions.tsx`**

    A `'use client'` component toolbar that appears when orders are selected.

    Props:
    ```typescript
    interface BatchActionsProps {
      selectedOrderIds: string[]
      onClear: () => void
    }
    ```

    Layout (sticky toolbar at top of receivables section, visible when selection.length > 0):
    1. **Selection count:** "{N} orders selected"
    2. **"Send Invoices" button:**
       - For each selected orderId, call `POST /api/invoices/${orderId}/send` individually (NOT batch API — Resend doesn't support attachments in batch)
       - Use `Promise.allSettled()` to handle partial failures
       - Show progress: "Sending 3/5..."
       - On complete: toast with "X invoices sent, Y failed"
       - Invalidate orders query
    3. **"Mark Paid" button:**
       - Opens a small popover/dialog asking for payment date (default: today)
       - Calls `batchMarkPaid(selectedOrderIds, paymentDate)` server action
       - On complete: toast with "X orders marked as paid"
       - Invalidate orders query and clear selection
    4. **"Clear Selection" button**

    Use sonner for toast notifications. Use shadcn/ui Popover for the date picker dialog.
  </action>
  <verify>
    - `npx tsc --noEmit` compiles without errors
    - `grep 'ReceivablesTable' src/app/(dashboard)/billing/_components/receivables-table.tsx` returns match
    - `grep 'AgingTable' src/app/(dashboard)/billing/_components/aging-table.tsx` returns match
    - `grep 'BatchActions' src/app/(dashboard)/billing/_components/batch-actions.tsx` returns match
    - Receivables table has checkbox selection and expandable broker rows
    - Aging table has color-coded bucket columns
    - Batch actions call individual /api/invoices sends (not batch API)
    - Batch mark paid uses batchMarkPaid server action
  </verify>
  <done>Receivables table shows broker-grouped outstanding invoices with expandable order details and checkbox selection. Aging analysis displays color-coded buckets (current through 90+) per broker with drill-down capability. Batch actions toolbar enables sending multiple invoices (individual Resend calls) and marking multiple orders as paid with a single date.</done>
</task>

<task type="auto">
  <name>Task 3: Add receivables section to broker detail page</name>
  <files>
    src/app/(dashboard)/brokers/_components/broker-receivables.tsx
    src/app/(dashboard)/brokers/[id]/page.tsx
  </files>
  <action>
    Per locked decision: "Clicking a broker row navigates to the existing broker detail page (add receivables section there)."

    **Step 1: Create `src/app/(dashboard)/brokers/_components/broker-receivables.tsx`**

    A `'use client'` component that shows outstanding receivables for a single broker.

    Props:
    ```typescript
    interface BrokerReceivablesProps {
      brokerId: string
    }
    ```

    Implementation:
    1. Use `createBrowserClient()` from `@/lib/supabase/browser` to fetch orders for this broker.
    2. Fetch orders with `payment_status` in `['unpaid', 'invoiced', 'partially_paid']` filtered by `broker_id`:
       ```typescript
       const { data: orders } = await supabase
         .from('orders')
         .select('id, order_number, carrier_pay, amount_paid, payment_status, invoice_date')
         .eq('broker_id', brokerId)
         .in('payment_status', ['unpaid', 'invoiced', 'partially_paid'])
         .order('created_at', { ascending: false })
       ```
    3. Use TanStack Query with queryKey `['broker-receivables', brokerId]` for data fetching.

    Layout:
    - Section header: "Receivables" with a DollarSign icon
    - Summary line: "X outstanding orders totaling $Y"
    - Table of outstanding orders: Order Number, Carrier Pay, Amount Paid, Remaining, Payment Status (badge), Invoice Date
    - Each order row links to `/orders/${order.id}` for full detail
    - Empty state: "No outstanding receivables for this broker."

    Use shadcn/ui Table and Badge components. Use `PAYMENT_STATUS_LABELS` and `PAYMENT_STATUS_COLORS` from `@/types`.

    **Step 2: Update `src/app/(dashboard)/brokers/[id]/page.tsx`**

    1. Import the new component:
       ```typescript
       import { BrokerReceivables } from '../_components/broker-receivables'
       ```

    2. Add the receivables section to the content grid, after the "Payment & Billing" card and before the "Notes" section. Place it as a full-width section (spanning both columns on lg):
       ```tsx
       {/* Receivables */}
       <div className="lg:col-span-2">
         <BrokerReceivables brokerId={id} />
       </div>
       ```

    3. Import `DollarSign` from lucide-react if needed by the component.
  </action>
  <verify>
    - `npx tsc --noEmit` compiles without errors
    - `grep 'BrokerReceivables' src/app/(dashboard)/brokers/_components/broker-receivables.tsx` returns match
    - `grep 'BrokerReceivables' src/app/(dashboard)/brokers/[id]/page.tsx` returns match
    - Broker detail page renders receivables section with outstanding orders
  </verify>
  <done>Broker detail page shows a receivables section listing outstanding orders with amounts, payment statuses, and links to order detail. This completes the navigation flow: receivables table broker row -> broker detail page -> receivables section.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- Sidebar shows "Billing" at /billing route
- Billing page loads receivables, aging, and collection rate
- Receivables table supports row expansion and checkbox selection
- Aging table has proper color coding per bucket
- Batch send processes orders individually (not Resend batch API)
- Batch mark paid uses server action
- Collection rate renders as visual metric
</verification>

<success_criteria>
- Billing page accessible at /billing via sidebar navigation
- Broker receivables table shows per-broker totals with expandable order list
- Aging analysis shows Current / 1-30 / 31-60 / 61-90 / 90+ buckets per broker with color coding
- Batch send invoices iterates orders individually via Resend
- Batch mark paid records full payment on selected orders
- Collection rate metric displays percentage with visual indicator
- Clicking broker name navigates to broker detail page
- Broker detail page shows receivables section with outstanding orders for that broker
</success_criteria>

<output>
After completion, create `.planning/phases/04-billing-invoicing/04-05-SUMMARY.md`
</output>
