---
phase: 04-billing-invoicing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00004_billing_invoicing.sql
  - src/db/schema.ts
  - src/types/database.ts
  - src/types/index.ts
  - src/lib/validations/payment.ts
autonomous: true

must_haves:
  truths:
    - "Orders have a payment_status column independent of order_status"
    - "Payments table exists with tenant isolation via RLS"
    - "Tenants table has company info columns for invoice headers"
    - "PaymentStatus type and labels are available in the type system"
  artifacts:
    - path: "supabase/migrations/00004_billing_invoicing.sql"
      provides: "Payment status enum, payments table, order billing columns, tenant company columns, RLS policies"
      contains: "CREATE TYPE public.payment_status"
    - path: "src/db/schema.ts"
      provides: "Drizzle schema with payments table and payment_status enum"
      contains: "paymentStatusEnum"
    - path: "src/types/database.ts"
      provides: "Payment and updated Order/Tenant TypeScript interfaces"
      contains: "interface Payment"
    - path: "src/types/index.ts"
      provides: "PaymentStatus union type, labels, colors"
      contains: "PaymentStatus"
    - path: "src/lib/validations/payment.ts"
      provides: "Zod validation schema for payment recording"
      contains: "recordPaymentSchema"
  key_links:
    - from: "supabase/migrations/00004_billing_invoicing.sql"
      to: "src/db/schema.ts"
      via: "Drizzle schema mirrors SQL tables"
      pattern: "paymentStatusEnum.*unpaid.*invoiced.*partially_paid.*paid"
    - from: "src/db/schema.ts"
      to: "src/types/database.ts"
      via: "TypeScript interfaces match Drizzle table columns"
      pattern: "payment_status.*PaymentStatus"
---

<objective>
Create the database foundation for billing & invoicing: payment_status enum, payments table, billing columns on orders, company info columns on tenants, and all supporting TypeScript types and validation schemas.

Purpose: Every subsequent billing plan depends on these database tables, types, and validations existing. This is the horizontal foundation that unlocks Wave 2 (invoice generation + payment data layer).

Output: SQL migration, updated Drizzle schema, TypeScript interfaces, type unions/labels/colors, and Zod payment validation schema. Also installs new npm dependencies (@react-pdf/renderer, resend, @react-email/components).
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-billing-invoicing/04-CONTEXT.md
@.planning/phases/04-billing-invoicing/04-RESEARCH.md
@supabase/migrations/00003_trips_and_dispatch.sql
@src/db/schema.ts
@src/types/database.ts
@src/types/index.ts
@src/lib/validations/trip.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install npm dependencies and create SQL migration</name>
  <files>
    package.json
    supabase/migrations/00004_billing_invoicing.sql
  </files>
  <action>
    **Step 1: Install dependencies**
    ```bash
    npm install @react-pdf/renderer resend @react-email/components
    ```

    **Step 2: Create migration file** `supabase/migrations/00004_billing_invoicing.sql`

    Follow the exact pattern from `00003_trips_and_dispatch.sql` for RLS policies, indexes, and triggers.

    The migration must include:

    1. **payment_status enum:**
    ```sql
    CREATE TYPE public.payment_status AS ENUM ('unpaid', 'invoiced', 'partially_paid', 'paid');
    ```

    2. **Add billing columns to orders:**
    - `payment_status public.payment_status NOT NULL DEFAULT 'unpaid'`
    - `invoice_date TIMESTAMPTZ` (set when invoice is sent)
    - `amount_paid NUMERIC(12,2) DEFAULT 0` (denormalized sum of payments, follows trips table pattern)

    3. **Add company info columns to tenants** (for invoice header):
    - `address TEXT`
    - `city TEXT`
    - `state TEXT`
    - `zip TEXT`
    - `phone TEXT`

    4. **Create payments table:**
    ```sql
    CREATE TABLE public.payments (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      tenant_id UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
      order_id UUID NOT NULL REFERENCES public.orders(id) ON DELETE CASCADE,
      amount NUMERIC(12,2) NOT NULL,
      payment_date DATE NOT NULL,
      notes TEXT,
      created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
      updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
    );
    ```

    5. **Indexes:**
    - `idx_orders_tenant_payment_status ON orders(tenant_id, payment_status)`
    - `idx_orders_tenant_invoice_date ON orders(tenant_id, invoice_date)`
    - `idx_payments_tenant_id ON payments(tenant_id)`
    - `idx_payments_order_id ON payments(order_id)`

    6. **RLS on payments** (follow trips RLS pattern exactly):
    ```sql
    ALTER TABLE public.payments ENABLE ROW LEVEL SECURITY;

    CREATE POLICY "payments_select" ON public.payments
      FOR SELECT TO authenticated
      USING (tenant_id = (SELECT public.get_tenant_id()));

    CREATE POLICY "payments_insert" ON public.payments
      FOR INSERT TO authenticated
      WITH CHECK (tenant_id = (SELECT public.get_tenant_id()));

    CREATE POLICY "payments_update" ON public.payments
      FOR UPDATE TO authenticated
      USING (tenant_id = (SELECT public.get_tenant_id()));

    CREATE POLICY "payments_delete" ON public.payments
      FOR DELETE TO authenticated
      USING (tenant_id = (SELECT public.get_tenant_id()));
    ```

    7. **Triggers:** `set_updated_at` trigger on payments using existing `handle_updated_at()` function.

    8. **Realtime:** `GRANT SELECT ON public.payments TO supabase_realtime;`
  </action>
  <verify>
    - `cat supabase/migrations/00004_billing_invoicing.sql` shows all elements
    - File contains `CREATE TYPE public.payment_status`
    - File contains `CREATE TABLE public.payments`
    - File contains `ENABLE ROW LEVEL SECURITY` for payments
    - File contains `ALTER TABLE public.orders ADD COLUMN payment_status`
    - File contains `ALTER TABLE public.tenants ADD COLUMN address`
    - `npm ls @react-pdf/renderer resend @react-email/components` shows all installed
  </verify>
  <done>Migration file exists with payment_status enum, payments table, order billing columns, tenant company columns, RLS policies, indexes, triggers, and realtime grant. All three npm packages installed.</done>
</task>

<task type="auto">
  <name>Task 2: Update Drizzle schema, TypeScript types, and create payment validation</name>
  <files>
    src/db/schema.ts
    src/types/database.ts
    src/types/index.ts
    src/lib/validations/payment.ts
  </files>
  <action>
    **Step 1: Update `src/db/schema.ts`**

    Add under Phase 4 section (after Phase 3 tables):

    1. New enum:
    ```typescript
    export const paymentStatusEnum = pgEnum('payment_status', [
      'unpaid', 'invoiced', 'partially_paid', 'paid',
    ])
    ```

    2. Add billing columns to orders table definition:
    - `paymentStatus: paymentStatusEnum('payment_status').notNull().default('unpaid')`
    - `invoiceDate: timestamp('invoice_date', { withTimezone: true })`
    - `amountPaid: numeric('amount_paid', { precision: 12, scale: 2 }).default('0')`

    3. Add company info columns to tenants table definition:
    - `address: text('address')`
    - `city: text('city')`
    - `state: text('state')`
    - `zip: text('zip')`
    - `phone: text('phone')`

    4. New payments table:
    ```typescript
    export const payments = pgTable('payments', {
      id: uuid('id').primaryKey().defaultRandom(),
      tenantId: uuid('tenant_id').notNull().references(() => tenants.id, { onDelete: 'cascade' }),
      orderId: uuid('order_id').notNull().references(() => orders.id, { onDelete: 'cascade' }),
      amount: numeric('amount', { precision: 12, scale: 2 }).notNull(),
      paymentDate: date('payment_date').notNull(),
      notes: text('notes'),
      createdAt: timestamp('created_at', { withTimezone: true }).notNull().defaultNow(),
      updatedAt: timestamp('updated_at', { withTimezone: true }).notNull().defaultNow(),
    }, (table) => [
      index('idx_payments_tenant_id').on(table.tenantId),
      index('idx_payments_order_id').on(table.orderId),
    ])
    ```

    5. Add type exports at bottom:
    ```typescript
    // Phase 4
    export type DrizzlePayment = typeof payments.$inferSelect
    export type NewPayment = typeof payments.$inferInsert
    ```

    **Step 2: Update `src/types/database.ts`**

    1. Add `Payment` interface:
    ```typescript
    export interface Payment {
      id: string
      tenant_id: string
      order_id: string
      amount: string
      payment_date: string
      notes: string | null
      created_at: string
      updated_at: string
    }
    ```

    2. Add billing fields to `Order` interface:
    - `payment_status: 'unpaid' | 'invoiced' | 'partially_paid' | 'paid'`
    - `invoice_date: string | null`
    - `amount_paid: string`

    3. Add company info fields to `Tenant` interface:
    - `address: string | null`
    - `city: string | null`
    - `state: string | null`
    - `zip: string | null`
    - `phone: string | null`

    **Step 3: Update `src/types/index.ts`**

    Add Phase 4 section after Phase 3 types:

    ```typescript
    // ============================================================================
    // Phase 4: Billing & Invoicing Types
    // ============================================================================

    export type PaymentStatus = 'unpaid' | 'invoiced' | 'partially_paid' | 'paid'

    export const PAYMENT_STATUSES: readonly PaymentStatus[] = [
      'unpaid', 'invoiced', 'partially_paid', 'paid',
    ] as const

    export const PAYMENT_STATUS_LABELS: Record<PaymentStatus, string> = {
      unpaid: 'Unpaid',
      invoiced: 'Invoiced',
      partially_paid: 'Partially Paid',
      paid: 'Paid',
    }

    export const PAYMENT_STATUS_COLORS: Record<PaymentStatus, string> = {
      unpaid: 'bg-gray-50 text-gray-700 border-gray-200',
      invoiced: 'bg-indigo-50 text-indigo-700 border-indigo-200',
      partially_paid: 'bg-amber-50 text-amber-700 border-amber-200',
      paid: 'bg-emerald-50 text-emerald-700 border-emerald-200',
    }
    ```

    **Step 4: Create `src/lib/validations/payment.ts`**

    Follow the pattern from `src/lib/validations/trip.ts`:

    ```typescript
    import { z } from 'zod'

    export const recordPaymentSchema = z.object({
      amount: z.coerce.number()
        .positive('Amount must be greater than 0')
        .multipleOf(0.01, 'Amount must have at most 2 decimal places'),
      paymentDate: z.string().min(1, 'Payment date is required'),
      notes: z.string().optional().or(z.literal('')),
    })

    export type RecordPaymentValues = z.infer<typeof recordPaymentSchema>
    export type RecordPaymentInput = z.input<typeof recordPaymentSchema>
    ```
  </action>
  <verify>
    - `npx tsc --noEmit` compiles without errors
    - `grep 'paymentStatusEnum' src/db/schema.ts` returns match
    - `grep 'Payment' src/types/database.ts` returns match
    - `grep 'PaymentStatus' src/types/index.ts` returns match
    - `grep 'recordPaymentSchema' src/lib/validations/payment.ts` returns match
  </verify>
  <done>Drizzle schema has payments table and payment_status enum. TypeScript interfaces include Payment, updated Order (with payment_status, invoice_date, amount_paid), and updated Tenant (with address, city, state, zip, phone). PaymentStatus type union with labels and colors exists. Payment validation schema is ready for server actions.</done>
</task>

</tasks>

<verification>
- SQL migration file exists at `supabase/migrations/00004_billing_invoicing.sql` with complete schema
- `npx tsc --noEmit` passes (all types consistent)
- `npm ls @react-pdf/renderer resend @react-email/components` shows installed packages
- Drizzle schema, database types, union types, and validation schemas are all consistent
</verification>

<success_criteria>
- payment_status enum defined in SQL, Drizzle, and TypeScript type system
- payments table with RLS and tenant isolation
- Order interface has payment_status, invoice_date, amount_paid fields
- Tenant interface has address, city, state, zip, phone fields
- Payment validation schema ready for form binding
- All three npm packages installed
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/04-billing-invoicing/04-01-SUMMARY.md`
</output>
