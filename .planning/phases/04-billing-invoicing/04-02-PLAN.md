---
phase: 04-billing-invoicing
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/lib/pdf/invoice-template.tsx
  - src/lib/resend/client.ts
  - src/components/email/invoice-email.tsx
  - src/app/api/invoices/[orderId]/pdf/route.ts
  - src/app/api/invoices/[orderId]/send/route.ts
autonomous: true

must_haves:
  truths:
    - "Invoice PDF generates with company header, broker info, vehicle details, locations, and carrier pay"
    - "Invoice PDF is downloadable via GET /api/invoices/[orderId]/pdf"
    - "Invoice email sends via Resend with PDF attachment to broker's email"
    - "Sending invoice sets order payment_status to 'invoiced' and records invoice_date"
  artifacts:
    - path: "src/lib/pdf/invoice-template.tsx"
      provides: "React-PDF invoice document component"
      contains: "InvoiceDocument"
    - path: "src/lib/resend/client.ts"
      provides: "Resend client singleton"
      contains: "new Resend"
    - path: "src/components/email/invoice-email.tsx"
      provides: "React Email template for invoice notification"
      contains: "InvoiceEmail"
    - path: "src/app/api/invoices/[orderId]/pdf/route.ts"
      provides: "GET handler returning PDF buffer"
      exports: ["GET"]
    - path: "src/app/api/invoices/[orderId]/send/route.ts"
      provides: "POST handler generating PDF and sending via Resend"
      exports: ["POST"]
  key_links:
    - from: "src/app/api/invoices/[orderId]/pdf/route.ts"
      to: "src/lib/pdf/invoice-template.tsx"
      via: "renderToBuffer with InvoiceDocument component"
      pattern: "renderToBuffer.*InvoiceDocument"
    - from: "src/app/api/invoices/[orderId]/send/route.ts"
      to: "src/lib/resend/client.ts"
      via: "resend.emails.send with PDF attachment"
      pattern: "resend\\.emails\\.send"
    - from: "src/app/api/invoices/[orderId]/send/route.ts"
      to: "src/components/email/invoice-email.tsx"
      via: "React Email template as email body"
      pattern: "InvoiceEmail"
---

<objective>
Build the invoice generation and delivery pipeline: PDF template with @react-pdf/renderer, email template with React Email, Resend client, and two API route handlers (PDF download + send invoice email).

Purpose: This creates the invoice infrastructure that the order detail page (Plan 04) and billing page (Plan 05) will use. Separating it allows parallel development of the payment data layer (Plan 03).

Output: Invoice PDF template, email template, Resend client, and two API routes at `/api/invoices/[orderId]/pdf` (GET) and `/api/invoices/[orderId]/send` (POST).
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-billing-invoicing/04-CONTEXT.md
@.planning/phases/04-billing-invoicing/04-RESEARCH.md
@.planning/phases/04-billing-invoicing/04-01-SUMMARY.md
@src/types/database.ts
@src/lib/supabase/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create invoice PDF template and Resend client</name>
  <files>
    src/lib/pdf/invoice-template.tsx
    src/lib/resend/client.ts
    src/components/email/invoice-email.tsx
  </files>
  <action>
    **Step 1: Create `src/lib/resend/client.ts`**

    Simple singleton pattern:
    ```typescript
    import { Resend } from 'resend'

    export const resend = new Resend(process.env.RESEND_API_KEY)
    ```

    **Step 2: Create `src/lib/pdf/invoice-template.tsx`**

    Build the invoice PDF using @react-pdf/renderer components. The document must display:

    1. **Company Header (top-left):** Tenant name, address, city/state/zip, phone (from tenant table). No logo for MVP.
    2. **Invoice Info (top-right):** "INVOICE" title, invoice number (format: `INV-{numeric_part_of_order_number}` — extract digits from `ORD-000123` to get `INV-000123`), current date.
    3. **Bill To:** Broker name and email.
    4. **Line Items Table:** Headers: Description | Details | Amount. Row: vehicle year/make/model | pickup city,state -> delivery city,state | carrier pay. Second row if VIN exists: VIN number.
    5. **Total:** Bold total due line = carrier pay.
    6. **Footer:** "Thank you for your business" message.

    Use `StyleSheet.create()` for all styles. Use `Helvetica` font family (built-in, no font loading needed). Page size: `LETTER`. Padding: 40pt.

    Define the props interface:
    ```typescript
    interface InvoiceDocumentProps {
      order: {
        order_number: string | null
        carrier_pay: string
        vehicle_vin: string | null
        vehicle_year: number | null
        vehicle_make: string | null
        vehicle_model: string | null
        pickup_city: string | null
        pickup_state: string | null
        delivery_city: string | null
        delivery_state: string | null
        broker: { name: string; email: string | null } | null
      }
      tenant: {
        name: string
        address: string | null
        city: string | null
        state: string | null
        zip: string | null
        phone: string | null
      }
    }
    ```

    Follow the layout from the research file's code example but add the footer.

    **Step 3: Create `src/components/email/invoice-email.tsx`**

    Build using `@react-email/components` (Html, Head, Preview, Body, Container, Heading, Text, Hr, Section). The email body:
    - Preview text: "Invoice from {tenant.name}"
    - Heading: "Invoice {INV-number}"
    - Body: "Please find attached the invoice for order {order_number}."
    - Amount due: bold formatted carrier pay
    - Footer: "This invoice was sent by {tenant.name}."

    Style with inline styles (email-safe, no Tailwind). Background: #f9fafb, max-width: 600px.

    Define props interface matching what the send route will pass.
  </action>
  <verify>
    - `npx tsc --noEmit` compiles without errors
    - `grep 'InvoiceDocument' src/lib/pdf/invoice-template.tsx` returns match
    - `grep 'Resend' src/lib/resend/client.ts` returns match
    - `grep 'InvoiceEmail' src/components/email/invoice-email.tsx` returns match
  </verify>
  <done>Invoice PDF template renders company header, bill-to, line items with VIN/locations/carrier pay, total, and footer. Resend client singleton exports `resend`. Invoice email template ready for React Email rendering.</done>
</task>

<task type="auto">
  <name>Task 2: Create API route handlers for PDF generation and invoice sending</name>
  <files>
    src/app/api/invoices/[orderId]/pdf/route.ts
    src/app/api/invoices/[orderId]/send/route.ts
  </files>
  <action>
    **Step 1: Create `src/app/api/invoices/[orderId]/pdf/route.ts`**

    GET handler that:
    1. Extracts `orderId` from `params` (Next.js 16: `params` is a Promise, so `await params`).
    2. Creates Supabase server client via `createClient()`.
    3. Fetches order with broker relation: `.from('orders').select('*, broker:brokers(id, name, email)').eq('id', orderId).single()`
    4. Fetches tenant: `.from('tenants').select('name, address, city, state, zip, phone').single()`
    5. Returns 404 if order not found.
    6. Calls `renderToBuffer(<InvoiceDocument order={order} tenant={tenant} />)` — import from `@react-pdf/renderer`.
    7. Returns `new Response(pdfBuffer, { headers: { 'Content-Type': 'application/pdf', 'Content-Disposition': 'inline; filename="INV-{order_number}.pdf"' } })`.

    **IMPORTANT:** In Next.js 16, route handler params are: `{ params }: { params: Promise<{ orderId: string }> }`. Must `await params`.

    **Step 2: Create `src/app/api/invoices/[orderId]/send/route.ts`**

    POST handler that:
    1. Extracts `orderId` from params (same Promise pattern).
    2. Creates Supabase server client.
    3. Fetches order with broker relation (same as PDF route).
    4. Fetches tenant (same as PDF route).
    5. Validates broker has email — return 400 if no broker or no broker email.
    6. Generates PDF buffer via `renderToBuffer(<InvoiceDocument ... />)`.
    7. Computes invoice number: extract numeric part from order_number (e.g., `ORD-000123` -> `INV-000123`). Fallback to order ID first 8 chars if no order_number.
    8. Sends email via Resend:
    ```typescript
    const fromEmail = process.env.RESEND_FROM_EMAIL || 'onboarding@resend.dev'
    const { data, error } = await resend.emails.send({
      from: `${tenant.name} <${fromEmail}>`,
      to: [order.broker.email],
      subject: `Invoice ${invoiceNumber}`,
      react: InvoiceEmail({ order, tenant }),
      attachments: [{
        filename: `${invoiceNumber}.pdf`,
        content: Buffer.from(pdfBuffer),
      }],
    })
    ```
    9. If email sends successfully, update the order:
       - Set `payment_status` to `'invoiced'` (only if currently `'unpaid'`)
       - Set `invoice_date` to `new Date().toISOString()` (only if not already set — don't overwrite on re-send)
       - Set `status` to `'invoiced'` (only if currently `'delivered'` — advance the order status)
    10. Return `{ success: true, emailId: data?.id }` on success, or `{ error: ... }` on failure.

    **Error handling:** Wrap Resend call in try/catch. Return 500 with error message on failure. Do NOT update order status if email fails.
  </action>
  <verify>
    - `npx tsc --noEmit` compiles without errors
    - `grep 'renderToBuffer' src/app/api/invoices/*/pdf/route.ts` returns match
    - `grep 'resend.emails.send' src/app/api/invoices/*/send/route.ts` returns match
    - `grep 'payment_status' src/app/api/invoices/*/send/route.ts` returns match (status update on send)
    - Both files export the correct HTTP method handler (GET and POST respectively)
  </verify>
  <done>GET /api/invoices/[orderId]/pdf returns a downloadable PDF. POST /api/invoices/[orderId]/send generates PDF, emails it to broker via Resend, and updates order payment_status to 'invoiced' with invoice_date set. Re-sending doesn't overwrite the original invoice_date.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- Invoice PDF template uses @react-pdf/renderer with Document/Page/View/Text components
- API routes use Next.js 16 `params: Promise<>` pattern
- Send route updates payment_status and invoice_date on successful email
- Resend client uses env var with fallback for from-email
</verification>

<success_criteria>
- Invoice PDF renders with company header, broker info, vehicle details, route, and carrier pay total
- GET /api/invoices/[orderId]/pdf returns PDF buffer with correct Content-Type
- POST /api/invoices/[orderId]/send emails invoice to broker and updates order status
- Email includes PDF attachment and React Email body
- All TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/04-billing-invoicing/04-02-SUMMARY.md`
</output>
