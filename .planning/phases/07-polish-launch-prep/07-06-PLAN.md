---
phase: 07-polish-launch-prep
plan: 06
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/app/(dashboard)/drivers/[id]/page.tsx
  - src/app/(dashboard)/drivers/[id]/_components/driver-earnings.tsx
  - src/app/(dashboard)/drivers/[id]/_components/driver-documents.tsx
  - src/app/(dashboard)/orders/_components/order-detail.tsx
  - src/app/(dashboard)/orders/_components/order-attachments.tsx
autonomous: true

must_haves:
  truths:
    - "Driver detail page shows trip-by-trip earnings breakdown table"
    - "Driver detail page shows document upload section for CDL/medical card"
    - "Order detail page shows attachments section for uploading photos/rate confirmations"
    - "Uploaded documents and attachments are tenant-scoped in Supabase Storage"
  artifacts:
    - path: "src/app/(dashboard)/drivers/[id]/_components/driver-earnings.tsx"
      provides: "Driver earnings table with trip-by-trip pay breakdown"
      min_lines: 60
    - path: "src/app/(dashboard)/drivers/[id]/_components/driver-documents.tsx"
      provides: "Driver document upload and management"
      min_lines: 50
    - path: "src/app/(dashboard)/orders/_components/order-attachments.tsx"
      provides: "Order attachment upload and display"
      min_lines: 50
  key_links:
    - from: "src/app/(dashboard)/drivers/[id]/_components/driver-earnings.tsx"
      to: "src/lib/queries/trips.ts"
      via: "fetchTrips with driverId filter"
      pattern: "fetchTrips.*driverId"
    - from: "src/app/(dashboard)/drivers/[id]/_components/driver-documents.tsx"
      to: "src/app/actions/documents.ts"
      via: "createDocument/deleteDocument with entityType='driver'"
      pattern: "createDocument.*driver"
    - from: "src/app/(dashboard)/orders/_components/order-attachments.tsx"
      to: "src/lib/storage.ts"
      via: "uploadFile for attachment storage"
      pattern: "uploadFile"
---

<objective>
Build driver earnings view (DRV-5), driver document uploads (DRV-6), and order attachments web UI (ORD-8). These complete the remaining P1 feature requirements on the web dashboard.

Purpose: Carriers need to see driver pay breakdowns, store driver compliance documents (CDL, medical card), and attach rate confirmations/photos to orders. These features are critical for day-to-day TMS operations.

Output: 3 new components on driver detail and order detail pages. Reuses document actions from Plan 04 for driver documents.
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md

# Foundation from Plan 01
@src/db/schema.ts
@src/types/index.ts
@src/lib/storage.ts
@src/lib/validations/document.ts

# Document actions from Plan 04
@src/app/actions/documents.ts
@src/lib/queries/documents.ts

# Existing patterns
@src/app/(dashboard)/drivers/[id]/page.tsx
@src/app/(dashboard)/drivers/_components/driver-card.tsx
@src/lib/queries/trips.ts
@src/hooks/use-trips.ts
@src/app/(dashboard)/orders/_components/order-detail.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Driver earnings view + driver documents</name>
  <files>
    src/app/(dashboard)/drivers/[id]/page.tsx
    src/app/(dashboard)/drivers/[id]/_components/driver-earnings.tsx
    src/app/(dashboard)/drivers/[id]/_components/driver-documents.tsx
  </files>
  <action>
    Create `src/app/(dashboard)/drivers/[id]/_components/driver-earnings.tsx`:
    - 'use client' component
    - Props: driverId (string)
    - Fetch completed trips for this driver using existing fetchTrips with driverId filter and status 'completed'
    - Use TanStack Query: `useQuery({ queryKey: ['driver-earnings', driverId], queryFn: ... })`
    - Display summary card at top:
      - Total Earnings (sum of driver_pay across completed trips)
      - Total Trips (count)
      - Average Per Trip (total / count)
    - Display earnings table below (using shadcn/ui Table):
      - Columns: Trip Number, Date Range (start - end), Orders (count), Revenue, Driver Pay, Status
      - Sort by most recent first (end_date DESC)
      - Pagination if > 20 trips
    - Empty state: "No completed trips yet" with muted text
    - Use Card wrapper for the section

    Create `src/app/(dashboard)/drivers/[id]/_components/driver-documents.tsx`:
    - 'use client' component
    - Props: driverId, tenantId
    - Reuse fetchDocuments from src/lib/queries/documents.ts with entityType='driver'
    - Use TanStack Query for fetching document list
    - Same pattern as TruckDocuments from Plan 04 but with driver document types:
      - document_type options: CDL, Medical Card, MVR, Other (using DRIVER_DOCUMENT_TYPE_LABELS)
    - Upload dialog with: document_type select, expires_at date (optional), file input (.pdf,.jpg,.png)
    - Upload flow: uploadFile(supabase, 'driver-documents', tenantId, driverId, file) -> createDocument('driver', driverId, ...)
    - Document list: file_name, type label, expiry date (with warning if expired/expiring soon), upload date
    - Download via getSignedUrl, delete via deleteDocument
    - Expiry warning: if expires_at is within 30 days, show amber badge "Expiring Soon". If past, show red badge "Expired".

    Update `src/app/(dashboard)/drivers/[id]/page.tsx`:
    - Expand the driver detail page to include:
      - Existing driver info section
      - DriverEarnings section
      - DriverDocuments section
    - Use useDriver hook for driver data, pass driverId and tenantId to child components
    - The page may need to be converted from Server Component to Client Component (or use a client wrapper) to use hooks. Follow existing truck detail pattern.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Driver detail page renders earnings and documents sections
    - Earnings table shows trip data for the driver
    - Document upload/list/delete works with driver-documents bucket
  </verify>
  <done>
    Driver detail page has two new sections: DriverEarnings (trip-by-trip pay table with summary card) and DriverDocuments (upload/list/download/delete CDL, medical card, MVR). Document expiry warnings shown.
  </done>
</task>

<task type="auto">
  <name>Task 2: Order attachments web UI</name>
  <files>
    src/app/(dashboard)/orders/_components/order-attachments.tsx
    src/app/(dashboard)/orders/_components/order-detail.tsx
  </files>
  <action>
    Create `src/app/(dashboard)/orders/_components/order-attachments.tsx`:
    - 'use client' component
    - Props: orderId, tenantId
    - Fetch existing attachments from order_attachments table via Supabase query
    - Use TanStack Query: queryKey ['order-attachments', orderId]
    - Display as a grid of attachment cards (not a table -- more visual for photos/documents):
      - For images (jpg, png, gif, webp): show thumbnail preview using getSignedUrl
      - For documents (pdf, doc, docx): show file icon with FileText from lucide-react
      - Show file_name below each card, file_size, upload date
    - "Upload" button opens a dialog:
      - attachment_type select: 'rate_confirmation', 'photo', 'document', 'other'
      - Optional notes/description text input
      - File input (accept common formats: .pdf,.jpg,.png,.doc,.docx,.xlsx)
      - Max 10MB per file
    - Upload flow:
      1. uploadFile(supabase, 'order-attachments', tenantId, orderId, file)
      2. Insert record into order_attachments table via Supabase (not server action -- direct browser client insert since RLS handles auth)
    - Delete: click attachment -> confirm dialog -> delete from order_attachments + deleteFile from storage
    - Download: click download icon -> getSignedUrl -> open in new tab
    - Empty state: "No attachments yet"

    Update `src/app/(dashboard)/orders/_components/order-detail.tsx`:
    - Add OrderAttachments component as a new section on the order detail page
    - Place it after the billing section (or after the timeline section if billing isn't shown)
    - Pass orderId and tenantId as props
    - Only show for orders that exist (not in creation mode)

    Note: The order_attachments table already exists in migration 00006. The Drizzle schema entry was added in Plan 01. This task just builds the web UI.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Order detail page shows attachments section
    - Can upload files to order-attachments bucket
    - Attachments display as grid with thumbnails for images
    - Delete removes both DB record and storage file
  </verify>
  <done>
    Order detail page has attachments section with visual grid display (image thumbnails, file icons), upload dialog with type classification, download via signed URLs, delete with storage cleanup. Fulfills ORD-8.
  </done>
</task>

</tasks>

<verification>
- Driver detail page shows earnings table with trip-by-trip breakdown
- Driver detail page shows document management section
- Order detail page shows attachments section
- File uploads go to correct tenant-scoped buckets
- `npx tsc --noEmit` passes
</verification>

<success_criteria>
A dispatcher can: (1) view a driver's trip-by-trip earnings with totals, (2) upload and manage driver compliance documents with expiry tracking, (3) upload and view order attachments (rate confirmations, photos) with thumbnail previews.
</success_criteria>

<output>
After completion, create `.planning/phases/07-polish-launch-prep/07-06-SUMMARY.md`
</output>
