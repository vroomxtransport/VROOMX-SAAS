---
phase: 07-polish-launch-prep
plan: 10
type: execute
wave: 4
depends_on: ["07-02", "07-08"]
files_modified:
  - src/app/layout.tsx
  - src/app/(dashboard)/layout.tsx
  - scripts/security-audit.ts
  - scripts/perf-audit.ts
  - LAUNCH-CHECKLIST.md
autonomous: false

must_haves:
  truths:
    - "Core Web Vitals targets are documented and metadata optimized (LCP < 2.5s, INP < 200ms, CLS < 0.1)"
    - "Security audit script checks RLS coverage, exposed keys, and auth verification"
    - "No NEXT_PUBLIC_ variables contain secrets"
    - "All server actions verify getUser() before database operations"
    - "Launch checklist covers deployment, environment, and verification steps"
  artifacts:
    - path: "scripts/security-audit.ts"
      provides: "Automated security checks"
      min_lines: 40
    - path: "scripts/perf-audit.ts"
      provides: "Performance check script"
      min_lines: 20
    - path: "LAUNCH-CHECKLIST.md"
      provides: "Pre-launch verification document"
      min_lines: 40
  key_links:
    - from: "scripts/security-audit.ts"
      to: "src/app/actions/*.ts"
      via: "Grep for auth verification patterns"
      pattern: "getUser"
    - from: "src/app/layout.tsx"
      to: "next/font"
      via: "Font optimization for LCP"
      pattern: "next/font"
---

<objective>
Perform performance optimizations and security audit. Create automated audit scripts and a launch checklist. Apply quick performance wins (font optimization, metadata, image optimization hints).

Purpose: Before launching to real customers, verify that the application is secure (no exposed keys, RLS on all tables, auth checks everywhere) and performant (meets Core Web Vitals targets). This is the final quality gate.

Output: Security audit script, performance check script, optimized layouts, and launch checklist document.
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/07-polish-launch-prep/07-RESEARCH.md

# Layouts and config
@src/app/layout.tsx
@src/app/(dashboard)/layout.tsx
@src/app/(marketing)/layout.tsx

# Webhook security
@src/app/api/webhooks/stripe/route.ts

# Server actions
@src/app/actions/auth.ts
@src/app/actions/orders.ts
@src/app/actions/trips.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Performance optimizations + security audit script</name>
  <files>
    src/app/layout.tsx
    scripts/security-audit.ts
    scripts/perf-audit.ts
  </files>
  <action>
    **Performance optimizations in root layout:**
    1. Ensure `next/font/google` is used for font loading (Inter or system font) with `display: 'swap'` for LCP optimization
    2. Add viewport metadata if not present
    3. Add default metadata export with:
       - title: { default: 'VroomX TMS', template: '%s | VroomX' }
       - description: 'Modern TMS for vehicle transport carriers'
       - robots: { index: true, follow: true }
    4. Verify Tailwind CSS is loaded efficiently (should be via globals.css import)

    **Create `scripts/security-audit.ts`:**
    A Node.js script that performs automated security checks:

    ```typescript
    #!/usr/bin/env npx tsx
    import { readFileSync, readdirSync } from 'fs'
    import { join } from 'path'

    const checks: { name: string; pass: boolean; detail: string }[] = []

    // Check 1: No secrets in NEXT_PUBLIC_ env vars
    // Scan .env.local.example or .env for NEXT_PUBLIC_ containing 'secret', 'sk_'
    function checkEnvVars() { ... }

    // Check 2: All server actions verify getUser()
    // Scan src/app/actions/*.ts for getUser() call
    function checkAuthInActions() {
      const actionsDir = 'src/app/actions'
      const files = readdirSync(actionsDir).filter(f => f.endsWith('.ts'))
      for (const file of files) {
        const content = readFileSync(join(actionsDir, file), 'utf-8')
        const exportedFunctions = content.match(/export\s+async\s+function\s+\w+/g) || []
        const hasGetUser = content.includes('getUser')
        if (exportedFunctions.length > 0 && !hasGetUser) {
          checks.push({ name: `Auth in ${file}`, pass: false, detail: 'No getUser() call found' })
        } else {
          checks.push({ name: `Auth in ${file}`, pass: true, detail: `${exportedFunctions.length} actions, auth verified` })
        }
      }
    }

    // Check 3: Stripe webhook verifies signature
    function checkWebhookSignature() {
      const content = readFileSync('src/app/api/webhooks/stripe/route.ts', 'utf-8')
      const verifiesSignature = content.includes('stripe-signature') || content.includes('constructEvent')
      checks.push({ name: 'Webhook signature', pass: verifiesSignature, detail: verifiesSignature ? 'Signature verified' : 'MISSING signature verification!' })
    }

    // Check 4: No sk_ or secret keys in src/ directory
    function checkExposedKeys() {
      // Recursively scan src/ for patterns like sk_live, sk_test, SUPABASE_SECRET
      // Exclude node_modules
    }

    // Check 5: RLS coverage - verify all migration files enable RLS
    function checkRLS() {
      const migrations = readdirSync('supabase/migrations').filter(f => f.endsWith('.sql'))
      for (const file of migrations) {
        const content = readFileSync(join('supabase/migrations', file), 'utf-8')
        const tables = content.match(/CREATE TABLE public\.(\w+)/g) || []
        const rlsEnabled = content.match(/ENABLE ROW LEVEL SECURITY/g) || []
        // Compare counts
      }
    }

    // Run all checks and print report
    checkEnvVars()
    checkAuthInActions()
    checkWebhookSignature()
    checkExposedKeys()
    checkRLS()

    console.log('\n=== Security Audit Report ===\n')
    for (const check of checks) {
      console.log(`${check.pass ? '✓' : '✗'} ${check.name}: ${check.detail}`)
    }
    const failures = checks.filter(c => !c.pass)
    console.log(`\n${checks.length - failures.length}/${checks.length} checks passed`)
    if (failures.length > 0) process.exit(1)
    ```

    **Create `scripts/perf-audit.ts`:**
    A simpler script that checks for performance best practices:
    - Verify next/font usage in root layout
    - Check for explicit width/height on images (grep for next/image usage)
    - Verify no barrel imports from lucide-react (should be `import { Icon } from 'lucide-react'`, not `import * as icons`)
    - Check bundle: count total files in src/ as a rough complexity metric
    - Output: checklist of performance practices found/missing

    Add npm script: `"audit:security": "npx tsx scripts/security-audit.ts"`
    Add npm script: `"audit:perf": "npx tsx scripts/perf-audit.ts"`
  </action>
  <verify>
    - `npx tsx scripts/security-audit.ts` runs and produces a report
    - `npx tsx scripts/perf-audit.ts` runs and produces a report
    - Root layout has font optimization and default metadata
    - `npx tsc --noEmit` passes
  </verify>
  <done>
    Security audit script checks: auth in actions, webhook signatures, exposed keys, RLS coverage, env var safety. Performance audit script checks font optimization and common patterns. Root layout optimized with proper font loading and metadata.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 7 Polish & Launch Prep:
    - Error boundaries and loading states on all routes
    - Magic link login option
    - Trailer assignment, truck/driver documents, order attachments
    - CSV order import wizard
    - Driver earnings view
    - Sample data seeding and in-app help tooltips
    - Marketing landing page and pricing page
    - E2E tests for critical flows
    - Security and performance audit scripts

    Plus a LAUNCH-CHECKLIST.md with all pre-launch verification items.
  </what-built>
  <how-to-verify>
    1. Run `npm run build` - should complete without errors
    2. Run `npx tsx scripts/security-audit.ts` - review security report
    3. Visit http://localhost:3000 - verify landing page loads
    4. Visit http://localhost:3000/pricing - verify pricing page
    5. Visit http://localhost:3000/login - verify magic link tab exists
    6. Log in and check:
       a. Navigate to /orders - "Import CSV" button visible
       b. Navigate to a truck detail - trailer section and documents section visible
       c. Navigate to a driver detail - earnings and documents sections visible
       d. Navigate to an order detail - attachments section visible
       e. Navigate to /settings - "Sample Data" section visible for owners
    7. Visit http://localhost:3000/nonexistent - verify 404 page
    8. Run `npm run test:e2e -- --list` - verify E2E tests are enumerated
    9. Review LAUNCH-CHECKLIST.md for completeness
  </how-to-verify>
  <resume-signal>Type "approved" to confirm launch readiness, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
- Security audit script runs and reports on all checks
- Performance audit script runs and reports on optimizations
- Root layout has optimized font loading and default metadata
- LAUNCH-CHECKLIST.md provides comprehensive pre-launch guide
- `npm run build` succeeds
</verification>

<success_criteria>
The security audit passes with no critical failures. Performance optimizations are applied. A comprehensive launch checklist exists for the final deployment. The user has verified the full application works end-to-end across all Phase 7 features.
</success_criteria>

<output>
After completion, create `.planning/phases/07-polish-launch-prep/07-10-SUMMARY.md`
</output>
