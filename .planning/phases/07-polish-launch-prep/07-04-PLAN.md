---
phase: 07-polish-launch-prep
plan: 04
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/app/actions/trailers.ts
  - src/app/actions/documents.ts
  - src/lib/queries/trailers.ts
  - src/lib/queries/documents.ts
  - src/hooks/use-trailers.ts
  - src/app/(dashboard)/trucks/[id]/page.tsx
  - src/app/(dashboard)/trucks/[id]/_components/trailer-section.tsx
  - src/app/(dashboard)/trucks/[id]/_components/truck-documents.tsx
  - src/app/(dashboard)/trucks/_components/truck-form.tsx
autonomous: true

must_haves:
  truths:
    - "User can create/edit/delete trailers inline on truck detail page"
    - "User can assign a trailer to a truck via dropdown on truck detail"
    - "User can upload truck documents (registration, insurance) on truck detail"
    - "User can view and delete uploaded truck documents"
    - "Uploaded files are tenant-scoped in Supabase Storage"
  artifacts:
    - path: "src/app/actions/trailers.ts"
      provides: "Trailer CRUD server actions"
      exports: ["createTrailer", "updateTrailer", "deleteTrailer"]
    - path: "src/app/actions/documents.ts"
      provides: "Document CRUD server actions for trucks and drivers"
      exports: ["createDocument", "deleteDocument"]
    - path: "src/app/(dashboard)/trucks/[id]/_components/trailer-section.tsx"
      provides: "Inline trailer management on truck detail"
      min_lines: 40
    - path: "src/app/(dashboard)/trucks/[id]/_components/truck-documents.tsx"
      provides: "Truck document upload and list"
      min_lines: 50
  key_links:
    - from: "src/app/(dashboard)/trucks/[id]/_components/trailer-section.tsx"
      to: "src/app/actions/trailers.ts"
      via: "Server action calls for trailer CRUD"
      pattern: "createTrailer|updateTrailer|deleteTrailer"
    - from: "src/app/(dashboard)/trucks/[id]/_components/truck-documents.tsx"
      to: "src/lib/storage.ts"
      via: "uploadFile for document storage"
      pattern: "uploadFile"
---

<objective>
Build trailer assignment (FLT-4) and truck document uploads (FLT-5) on the truck detail page. Trailers are managed inline on the truck detail page (no separate route). Documents are uploaded to tenant-scoped Supabase Storage.

Purpose: Carriers need to pair trucks with trailers and keep registration/insurance documents on file. These are required P1 features for launch.

Output: Trailer CRUD server actions + inline UI on truck detail. Document upload server actions + UI on truck detail. Shared document action module reusable for driver documents in Plan 06's scope.
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md

# Foundation from Plan 01
@src/db/schema.ts
@src/types/index.ts
@src/lib/storage.ts
@src/lib/validations/trailer.ts
@src/lib/validations/document.ts

# Existing truck patterns
@src/app/(dashboard)/trucks/[id]/page.tsx
@src/app/(dashboard)/trucks/_components/truck-form.tsx
@src/app/actions/trucks.ts
@src/lib/queries/trucks.ts
@src/hooks/use-trucks.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Trailer + document server actions, queries, hooks</name>
  <files>
    src/app/actions/trailers.ts
    src/app/actions/documents.ts
    src/lib/queries/trailers.ts
    src/lib/queries/documents.ts
    src/hooks/use-trailers.ts
  </files>
  <action>
    Create `src/app/actions/trailers.ts`:
    - `createTrailer(formData)`: Validate with trailerSchema, get tenant_id from JWT app_metadata, insert into trailers table, revalidatePath('/trucks')
    - `updateTrailer(id, formData)`: Validate, update by id with tenant_id guard, revalidatePath
    - `deleteTrailer(id)`: Delete by id with tenant_id guard, revalidatePath
    - `assignTrailerToTruck(truckId, trailerId)`: Update trucks.trailer_id, revalidatePath('/trucks')
    - `unassignTrailerFromTruck(truckId)`: Set trucks.trailer_id = null, revalidatePath
    - Follow exact same patterns as src/app/actions/trucks.ts (getUser, tenant_id extraction, error handling)

    Create `src/app/actions/documents.ts`:
    - `createDocument(entityType: 'driver' | 'truck', entityId, data)`: Insert into driver_documents or truck_documents based on entityType. Fields: document_type, file_name, storage_path, file_size, expires_at, uploaded_by = user.id. Validate with documentSchema.
    - `deleteDocument(entityType: 'driver' | 'truck', documentId)`: Delete from appropriate table by id + tenant_id guard. Also call deleteFile from storage.ts to remove the actual file from Supabase Storage.
    - This is intentionally generic to serve both truck and driver documents.

    Create `src/lib/queries/trailers.ts`:
    - `fetchTrailers(supabase, filters?)`: Fetch trailers for tenant with optional status filter. Returns Trailer[].
    - `fetchTrailer(supabase, id)`: Fetch single trailer by id.

    Create `src/lib/queries/documents.ts`:
    - `fetchDocuments(supabase, entityType: 'driver' | 'truck', entityId)`: Fetch documents for a given entity. Returns DriverDocument[] or TruckDocument[].
    - Generic function for both entity types.

    Create `src/hooks/use-trailers.ts`:
    - `useTrailers(filters?)`: TanStack Query hook wrapping fetchTrailers. Key: ['trailers', filters]. Realtime subscription on trailers table for auto-invalidation.
    - Follow exact pattern from use-trucks.ts.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - All 5 files export their respective functions
    - Server actions use createClient() from supabase/server
    - Document actions handle both 'driver' and 'truck' entity types
  </verify>
  <done>
    Trailer CRUD actions (create/update/delete/assign/unassign), document CRUD actions (generic for driver+truck), query functions, and TanStack Query hooks with Realtime all created.
  </done>
</task>

<task type="auto">
  <name>Task 2: Truck detail page: trailer section + document uploads</name>
  <files>
    src/app/(dashboard)/trucks/[id]/page.tsx
    src/app/(dashboard)/trucks/[id]/_components/trailer-section.tsx
    src/app/(dashboard)/trucks/[id]/_components/truck-documents.tsx
    src/app/(dashboard)/trucks/_components/truck-form.tsx
  </files>
  <action>
    The truck detail page at `src/app/(dashboard)/trucks/[id]/page.tsx` currently exists but is minimal. Expand it to a full detail page with sections.

    Create `src/app/(dashboard)/trucks/[id]/_components/trailer-section.tsx`:
    - 'use client' component
    - Shows currently assigned trailer (if any) with trailer number, type, status
    - "Assign Trailer" button opens a dialog/popover with:
      - Dropdown select of available trailers (from useTrailers with status: 'active')
      - "Assign" button calls assignTrailerToTruck
    - "Unassign" button calls unassignTrailerFromTruck
    - "Add New Trailer" inline form within a collapsible section:
      - Fields: trailer_number (required), trailer_type (select: open/enclosed/flatbed), year, make, model, vin, notes
      - Submit calls createTrailer, then assigns it to the truck
    - Edit and delete existing trailer via context actions
    - Use Card component for the section wrapper
    - Props: truckId, currentTrailerId (from truck data)

    Create `src/app/(dashboard)/trucks/[id]/_components/truck-documents.tsx`:
    - 'use client' component
    - Props: truckId, tenantId
    - Lists existing documents in a table/list: file_name, document_type label, expires_at (if set), uploaded date
    - "Upload Document" button that:
      1. Opens a dialog with: document_type select (registration/insurance/inspection_cert/other), expires_at date input (optional), file input (accept: .pdf,.jpg,.png,.doc,.docx)
      2. On submit: calls uploadFile from storage.ts with bucket='truck-documents', then calls createDocument server action with the storage path + metadata
    - Each document row has:
      - Download link (using getSignedUrl)
      - Delete button (calls deleteDocument which removes DB record + storage file)
    - Show file size in human-readable format
    - Empty state: "No documents uploaded yet"
    - Max file size: 10MB (validate client-side before upload)

    Update `src/app/(dashboard)/trucks/[id]/page.tsx`:
    - Convert to a richer detail page (if not already) with useTruck hook
    - Add TrailerSection and TruckDocuments as new sections below existing truck info
    - Pass truckId, tenantId, and currentTrailerId as props
    - Fetch truck data including the trailer relation (join trailers on trailer_id)

    Update `src/app/(dashboard)/trucks/_components/truck-form.tsx`:
    - Add optional trailer_id select field to the truck creation/edit form
    - Populate with available trailers from useTrailers hook
    - This allows assigning a trailer during truck creation (not just on detail page)
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Truck detail page renders trailer section and document section
    - TrailerSection shows assign/unassign/create trailer UI
    - TruckDocuments shows upload/list/delete document UI
    - Truck form includes optional trailer select
  </verify>
  <done>
    Truck detail page has 2 new sections: TrailerSection (inline CRUD + assign/unassign) and TruckDocuments (upload/list/download/delete with tenant-scoped storage). Truck form includes optional trailer assignment.
  </done>
</task>

</tasks>

<verification>
- Trailer CRUD server actions work (create/update/delete/assign/unassign)
- Document CRUD server actions work for trucks (create/delete with storage cleanup)
- Truck detail page shows trailer section and documents section
- File uploads go to truck-documents bucket with tenant-scoped paths
- `npx tsc --noEmit` passes
</verification>

<success_criteria>
A dispatcher can: (1) create trailers and assign them to trucks inline, (2) upload truck registration/insurance documents, (3) view and delete uploaded documents, (4) assign trailers during truck creation via the form dropdown.
</success_criteria>

<output>
After completion, create `.planning/phases/07-polish-launch-prep/07-04-SUMMARY.md`
</output>
