---
phase: 07-polish-launch-prep
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00007_phase7_polish.sql
  - src/db/schema.ts
  - src/types/index.ts
  - src/types/database.ts
  - src/lib/validations/trailer.ts
  - src/lib/validations/document.ts
  - src/lib/storage.ts
  - package.json
  - package-lock.json
autonomous: true

must_haves:
  truths:
    - "Trailers, driver_documents, and truck_documents tables exist in PostgreSQL with RLS"
    - "Drizzle schema exports trailers, driverDocuments, truckDocuments, orderAttachments tables"
    - "TypeScript types and Zod schemas exist for trailers and documents"
    - "Tenant-scoped storage upload helper is available for all file upload features"
    - "papaparse is installed and importable"
  artifacts:
    - path: "supabase/migrations/00007_phase7_polish.sql"
      provides: "trailers, driver_documents, truck_documents tables with RLS + trailer_id FK on trucks"
      contains: "CREATE TABLE public.trailers"
    - path: "src/db/schema.ts"
      provides: "Drizzle schema for trailers, driverDocuments, truckDocuments, orderAttachments"
      contains: "trailers"
    - path: "src/lib/storage.ts"
      provides: "Tenant-scoped file upload/delete/getUrl helpers"
      exports: ["uploadFile", "deleteFile", "getFileUrl"]
    - path: "src/lib/validations/trailer.ts"
      provides: "Trailer Zod validation schema"
      exports: ["trailerSchema"]
    - path: "src/lib/validations/document.ts"
      provides: "Document upload Zod validation schema"
      exports: ["documentSchema"]
  key_links:
    - from: "src/db/schema.ts"
      to: "supabase/migrations/00007_phase7_polish.sql"
      via: "Drizzle schema mirrors SQL tables"
      pattern: "trailers.*pgTable"
    - from: "src/lib/storage.ts"
      to: "supabase storage buckets"
      via: "Supabase storage client upload"
      pattern: "supabase\\.storage\\.from"
---

<objective>
Create the database foundation for Phase 7: trailers table, driver/truck document tables, Drizzle schema additions (including orderAttachments from migration 00006), Zod validations, TypeScript types, tenant-scoped storage upload helper, and install papaparse for CSV import.

Purpose: All subsequent Phase 7 plans depend on these tables, types, validations, and utilities. This is the horizontal infrastructure layer that enables parallel feature development in Wave 2.

Output: SQL migration, Drizzle schema updates, TypeScript types, Zod schemas, storage helper module, papaparse installed.
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-polish-launch-prep/07-RESEARCH.md

# DB foundation patterns from prior phases
@supabase/migrations/00006_driver_app_tables.sql
@src/db/schema.ts
@src/types/index.ts
@src/types/database.ts
@src/lib/validations/truck.ts
@src/lib/validations/driver.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: SQL migration + Drizzle schema + types</name>
  <files>
    supabase/migrations/00007_phase7_polish.sql
    src/db/schema.ts
    src/types/index.ts
    src/types/database.ts
    src/lib/validations/trailer.ts
    src/lib/validations/document.ts
  </files>
  <action>
    Create SQL migration `00007_phase7_polish.sql`:

    1. **trailers table:**
       - id UUID PK, tenant_id UUID NOT NULL FK tenants(id) ON DELETE CASCADE
       - trailer_number TEXT NOT NULL, trailer_type TEXT NOT NULL DEFAULT 'open' (open, enclosed, flatbed)
       - status TEXT NOT NULL DEFAULT 'active' (active, inactive, maintenance)
       - year INTEGER, make TEXT, model TEXT, vin TEXT, notes TEXT
       - created_at TIMESTAMPTZ DEFAULT now(), updated_at TIMESTAMPTZ DEFAULT now()
       - Handle_updated_at trigger, indexes on tenant_id and (tenant_id, trailer_number)
       - RLS: SELECT/INSERT/UPDATE/DELETE following exact same pattern as trucks table in 00002
       - Enable Realtime: GRANT SELECT ON public.trailers TO supabase_realtime

    2. **driver_documents table:**
       - id UUID PK, tenant_id UUID NOT NULL FK tenants(id) ON DELETE CASCADE
       - driver_id UUID NOT NULL FK drivers(id) ON DELETE CASCADE
       - document_type TEXT NOT NULL (values: 'cdl', 'medical_card', 'mvr', 'other')
       - file_name TEXT NOT NULL, storage_path TEXT NOT NULL
       - file_size INTEGER, expires_at DATE (nullable)
       - uploaded_by UUID REFERENCES auth.users(id)
       - created_at TIMESTAMPTZ DEFAULT now()
       - Indexes on (tenant_id, driver_id), RLS policies matching other tables

    3. **truck_documents table:**
       - Same structure as driver_documents but truck_id instead of driver_id
       - document_type values: 'registration', 'insurance', 'inspection_cert', 'other'

    4. **Add trailer_id to trucks:**
       - ALTER TABLE public.trucks ADD COLUMN trailer_id UUID REFERENCES public.trailers(id) ON DELETE SET NULL;

    Update **Drizzle schema** (`src/db/schema.ts`):
    - Add `trailers` table definition with all columns
    - Add `driverDocuments` table definition
    - Add `truckDocuments` table definition
    - Add `orderAttachments` table definition (already in SQL migration 00006 but missing from Drizzle)
    - Add `trailerId` column to existing trucks table
    - Follow exact naming patterns from existing schema (camelCase JS, snake_case DB)

    Update **TypeScript types** (`src/types/index.ts` and `src/types/database.ts`):
    - Add TrailerType union: 'open' | 'enclosed' | 'flatbed'
    - Add TrailerStatus union: 'active' | 'inactive' | 'maintenance'
    - Add TRAILER_TYPE_LABELS, TRAILER_STATUS_LABELS, TRAILER_STATUS_COLORS maps
    - Add DriverDocumentType union: 'cdl' | 'medical_card' | 'mvr' | 'other'
    - Add TruckDocumentType union: 'registration' | 'insurance' | 'inspection_cert' | 'other'
    - Add DRIVER_DOCUMENT_TYPE_LABELS, TRUCK_DOCUMENT_TYPE_LABELS maps
    - Add Trailer, DriverDocument, TruckDocument, OrderAttachment database interfaces

    Create **Zod validations**:
    - `src/lib/validations/trailer.ts`: trailerSchema with trailer_number required, trailer_type, status, optional year/make/model/vin/notes
    - `src/lib/validations/document.ts`: documentSchema with document_type required, file_name required, storage_path required, optional file_size, expires_at
  </action>
  <verify>
    - `cat supabase/migrations/00007_phase7_polish.sql` shows all 3 tables with RLS
    - `npx tsc --noEmit` passes with no type errors
    - Drizzle schema exports trailers, driverDocuments, truckDocuments, orderAttachments
  </verify>
  <done>
    trailers, driver_documents, truck_documents tables defined in SQL and Drizzle. orderAttachments added to Drizzle. All types, unions, label maps, and Zod schemas created. trucks table has trailer_id FK.
  </done>
</task>

<task type="auto">
  <name>Task 2: Storage upload helper + install papaparse</name>
  <files>
    src/lib/storage.ts
    package.json
  </files>
  <action>
    Install papaparse:
    ```bash
    npm install papaparse @types/papaparse
    ```

    Create `src/lib/storage.ts` with tenant-scoped upload helpers:

    ```typescript
    import { SupabaseClient } from '@supabase/supabase-js'

    export async function uploadFile(
      supabase: SupabaseClient,
      bucket: string,
      tenantId: string,
      entityId: string,
      file: File,
    ): Promise<{ path: string; error: string | null }> {
      const ext = file.name.split('.').pop()?.toLowerCase() ?? 'bin'
      const fileName = `${crypto.randomUUID()}.${ext}`
      const storagePath = `${tenantId}/${entityId}/${fileName}`

      const { error } = await supabase.storage
        .from(bucket)
        .upload(storagePath, file, {
          cacheControl: '3600',
          upsert: false,
        })

      if (error) return { path: '', error: error.message }
      return { path: storagePath, error: null }
    }

    export async function deleteFile(
      supabase: SupabaseClient,
      bucket: string,
      storagePath: string,
    ): Promise<{ error: string | null }> {
      const { error } = await supabase.storage
        .from(bucket)
        .remove([storagePath])
      if (error) return { error: error.message }
      return { error: null }
    }

    export function getFileUrl(
      supabase: SupabaseClient,
      bucket: string,
      storagePath: string,
    ): string {
      const { data } = supabase.storage
        .from(bucket)
        .getPublicUrl(storagePath)
      return data.publicUrl
    }

    export function getSignedUrl(
      supabase: SupabaseClient,
      bucket: string,
      storagePath: string,
      expiresIn: number = 3600,
    ): Promise<{ url: string; error: string | null }> {
      return supabase.storage
        .from(bucket)
        .createSignedUrl(storagePath, expiresIn)
        .then(({ data, error }) => ({
          url: data?.signedUrl ?? '',
          error: error?.message ?? null,
        }))
    }
    ```

    Storage path convention (documented in JSDoc comments):
    - Driver documents: `driver-documents` bucket, path `{tenantId}/{driverId}/{uuid}.{ext}`
    - Truck documents: `truck-documents` bucket, path `{tenantId}/{truckId}/{uuid}.{ext}`
    - Order attachments: `order-attachments` bucket, path `{tenantId}/{orderId}/{uuid}.{ext}`

    Also add storage RLS policies to the migration (00007):
    - For each new bucket (driver-documents, truck-documents, order-attachments), add SELECT/INSERT/DELETE policies on storage.objects checking `(storage.foldername(name))[1] = (SELECT public.get_tenant_id()::text)` AND matching bucket_id
  </action>
  <verify>
    - `npm ls papaparse` shows papaparse installed
    - `npx tsc --noEmit` passes
    - `src/lib/storage.ts` exports uploadFile, deleteFile, getFileUrl, getSignedUrl
  </verify>
  <done>
    papaparse installed. Tenant-scoped storage helper with upload/delete/getUrl/getSignedUrl available at `src/lib/storage.ts`. Storage RLS policies for new buckets included in migration.
  </done>
</task>

</tasks>

<verification>
- SQL migration file exists with all 3 new tables, trailer_id FK on trucks, and storage RLS policies
- Drizzle schema updated with 4 new table definitions + trailerId on trucks
- TypeScript types and label maps for trailers and documents
- Zod schemas for trailer and document validation
- Storage helper module with 4 exported functions
- papaparse + @types/papaparse in package.json
- `npx tsc --noEmit` passes
</verification>

<success_criteria>
All Wave 2 plans (04, 05, 06) can reference trailers/document types, use storage helper, and import papaparse without any additional setup.
</success_criteria>

<output>
After completion, create `.planning/phases/07-polish-launch-prep/07-01-SUMMARY.md`
</output>
