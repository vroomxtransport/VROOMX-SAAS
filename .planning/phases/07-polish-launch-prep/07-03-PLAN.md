---
phase: 07-polish-launch-prep
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(auth)/login/page.tsx
  - src/app/actions/auth.ts
autonomous: true

must_haves:
  truths:
    - "User can switch between password login and magic link login on the login page"
    - "Entering an email and clicking Send Magic Link calls signInWithOtp and shows a success message"
    - "Magic link only works for existing users (shouldCreateUser: false)"
    - "Existing password login flow is unaffected"
  artifacts:
    - path: "src/app/(auth)/login/page.tsx"
      provides: "Login page with password and magic link tabs"
      contains: "magic"
    - path: "src/app/actions/auth.ts"
      provides: "magicLinkAction server action"
      contains: "signInWithOtp"
  key_links:
    - from: "src/app/(auth)/login/page.tsx"
      to: "src/app/actions/auth.ts"
      via: "form action binding to magicLinkAction"
      pattern: "magicLinkAction"
    - from: "src/app/actions/auth.ts"
      to: "supabase.auth.signInWithOtp"
      via: "Supabase Auth OTP"
      pattern: "signInWithOtp"
---

<objective>
Add magic link (passwordless) login as a secondary auth option on the login page (AUTH-8).

Purpose: Some users prefer passwordless login. Magic links are a low-friction way to authenticate, especially for users who frequently forget passwords. Supabase has built-in support via `signInWithOtp`.

Output: Updated login page with tab-based toggle between password and magic link modes. New `magicLinkAction` server action.
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/07-polish-launch-prep/07-RESEARCH.md

# Existing auth implementation
@src/app/(auth)/login/page.tsx
@src/app/actions/auth.ts
@src/app/(auth)/auth-confirm/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add magicLinkAction server action</name>
  <files>src/app/actions/auth.ts</files>
  <action>
    Add a new `magicLinkAction` server action to the existing `src/app/actions/auth.ts` file:

    ```typescript
    export async function magicLinkAction(prevState: any, formData: FormData) {
      const email = formData.get('email') as string
      if (!email || !email.includes('@')) {
        return { error: 'Please enter a valid email address' }
      }

      const supabase = await createClient()
      const { error } = await supabase.auth.signInWithOtp({
        email,
        options: {
          shouldCreateUser: false, // Only existing users - prevents orphaned accounts
          emailRedirectTo: `${process.env.NEXT_PUBLIC_APP_URL}/auth-confirm`,
        },
      })

      if (error) {
        // Supabase returns "Signups not allowed for otp" when user doesn't exist
        if (error.message.includes('Signups not allowed')) {
          return { error: 'No account found with this email. Please sign up first.' }
        }
        return { error: error.message }
      }

      return { success: true, message: 'Check your email for the login link. It expires in 1 hour.' }
    }
    ```

    Key details:
    - `shouldCreateUser: false` prevents creating new users via magic link (they must sign up first with password + plan selection)
    - Redirect to existing `/auth-confirm` route which already handles PKCE + OTP callback flows
    - Friendly error message when user doesn't exist
    - Uses the existing `createClient` import pattern from the file
    - Do NOT add invite_token handling to magic link (magic links are for returning users, not invites)
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - magicLinkAction is exported from auth.ts
  </verify>
  <done>
    magicLinkAction server action exists in auth.ts, calls signInWithOtp with shouldCreateUser:false, redirects to existing auth-confirm route.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update login page with magic link tab</name>
  <files>src/app/(auth)/login/page.tsx</files>
  <action>
    Update the login page to add a tab-based toggle between "Password" and "Magic Link" modes:

    1. Import `magicLinkAction` from '@/app/actions/auth'
    2. Import `Tabs, TabsContent, TabsList, TabsTrigger` from '@/components/ui/tabs'
    3. The page is already a client component (uses useActionState)

    Add a second form state for magic link:
    ```typescript
    const [magicState, magicAction, magicPending] = useActionState(magicLinkAction, null)
    ```

    Wrap the existing login form in a Tabs component:
    ```tsx
    <Tabs defaultValue="password" className="w-full">
      <TabsList className="grid w-full grid-cols-2">
        <TabsTrigger value="password">Password</TabsTrigger>
        <TabsTrigger value="magic-link">Magic Link</TabsTrigger>
      </TabsList>

      <TabsContent value="password">
        {/* Existing password login form - move it here unchanged */}
      </TabsContent>

      <TabsContent value="magic-link">
        {/* New magic link form */}
        <form action={magicAction} className="space-y-4">
          <div className="space-y-2">
            <Label htmlFor="magic-email">Email</Label>
            <Input id="magic-email" name="email" type="email" placeholder="you@company.com" required />
          </div>

          {magicState?.error && (
            <p className="text-sm text-destructive">{magicState.error}</p>
          )}

          {magicState?.success && (
            <div className="rounded-md bg-green-50 p-3 text-sm text-green-700 dark:bg-green-950 dark:text-green-300">
              {magicState.message}
            </div>
          )}

          <Button type="submit" className="w-full" disabled={magicPending}>
            {magicPending ? 'Sending...' : 'Send Magic Link'}
          </Button>
        </form>
      </TabsContent>
    </Tabs>
    ```

    Preserve:
    - All existing invite_token handling
    - Error display from URL searchParams
    - Link to signup page
    - Any existing invite banner
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Login page renders without errors
    - Both "Password" and "Magic Link" tabs visible
    - Existing password form still works
  </verify>
  <done>
    Login page has two tabs: Password (existing flow, unchanged) and Magic Link (email-only form calling magicLinkAction). Success message shown after magic link sent. Error shown if account doesn't exist.
  </done>
</task>

</tasks>

<verification>
- Login page loads with two tabs
- Password tab contains the existing login form (unchanged behavior)
- Magic Link tab has email input + submit button
- magicLinkAction calls supabase.auth.signInWithOtp with shouldCreateUser: false
- Success state shows "Check your email" message
- Error state shows friendly message for non-existent users
- `npx tsc --noEmit` passes
</verification>

<success_criteria>
Existing users can choose to log in via magic link email. Password login remains the default and is completely unaffected. New users are directed to sign up if they try magic link without an account.
</success_criteria>

<output>
After completion, create `.planning/phases/07-polish-launch-prep/07-03-SUMMARY.md`
</output>
