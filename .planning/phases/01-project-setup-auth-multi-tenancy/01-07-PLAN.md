---
phase: 01-project-setup-auth-multi-tenancy
plan: 07
type: execute
wave: 5
depends_on: ["01-06"]
files_modified:
  - src/app/(dashboard)/layout.tsx
  - src/app/(dashboard)/dashboard/page.tsx
  - src/app/(dashboard)/dashboard/setup-complete-banner.tsx
  - src/components/layout/sidebar.tsx
  - src/components/layout/header.tsx
  - src/components/layout/user-menu.tsx
  - src/stores/sidebar-store.ts
  - src/lib/tier.ts
autonomous: true

must_haves:
  truths:
    - "Authenticated user with tenant sees the dashboard with sidebar navigation"
    - "Sidebar shows navigation links for all major TMS sections"
    - "User menu shows user name, email, tenant name, role, and logout button"
    - "Dashboard page shows a welcome message with tenant/plan info"
    - "Returning from Stripe Checkout (?setup=complete) shows success banner"
    - "Sidebar collapses on mobile and can be toggled"
    - "Role-based navigation hides admin-only links for non-admin users"
  artifacts:
    - path: "src/app/(dashboard)/layout.tsx"
      provides: "Dashboard layout with sidebar + header"
      min_lines: 30
    - path: "src/app/(dashboard)/dashboard/page.tsx"
      provides: "Empty dashboard page with welcome info"
      min_lines: 20
    - path: "src/components/layout/sidebar.tsx"
      provides: "Sidebar navigation component"
      min_lines: 50
    - path: "src/components/layout/header.tsx"
      provides: "Dashboard header with user menu"
      min_lines: 20
    - path: "src/components/layout/user-menu.tsx"
      provides: "User dropdown with profile info and logout"
      min_lines: 30
    - path: "src/stores/sidebar-store.ts"
      provides: "Zustand store for sidebar state"
      exports: ["useSidebarStore"]
    - path: "src/lib/tier.ts"
      provides: "Tier display and feature gating helpers"
      exports: ["getTierDisplayName", "canAccess"]
  key_links:
    - from: "src/app/(dashboard)/layout.tsx"
      to: "src/lib/supabase/server.ts"
      via: "getUser() for session"
      pattern: "supabase.auth.getUser"
    - from: "src/app/(dashboard)/layout.tsx"
      to: "src/components/layout/sidebar.tsx"
      via: "renders Sidebar"
      pattern: "<Sidebar"
    - from: "src/components/layout/user-menu.tsx"
      to: "src/app/actions/logout.ts"
      via: "logout button"
      pattern: "logoutAction"
---

<objective>
Build the protected dashboard layout with sidebar navigation, header, user menu, and an empty dashboard page. This is the "shell" that all future TMS pages render inside. Includes role-based navigation visibility and tier display helpers.

Purpose: After signup and login, users land here. This layout wraps every dashboard page in Phase 2+. Getting it right now means every future page "just works" inside it.
Output: A working dashboard shell with sidebar, header, user info, and logout.
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/reepsy/Desktop/VROOMX_SAAS/.planning/PROJECT.md
@/Users/reepsy/Desktop/VROOMX_SAAS/.planning/ROADMAP.md
@/Users/reepsy/Desktop/VROOMX_SAAS/.planning/phases/01-project-setup-auth-multi-tenancy/01-RESEARCH.md

Prior plan outputs needed:
@.planning/phases/01-project-setup-auth-multi-tenancy/01-03-SUMMARY.md
@.planning/phases/01-project-setup-auth-multi-tenancy/01-06-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sidebar, header, user menu components and sidebar store</name>
  <files>
    src/components/layout/sidebar.tsx
    src/components/layout/header.tsx
    src/components/layout/user-menu.tsx
    src/stores/sidebar-store.ts
    src/lib/tier.ts
  </files>
  <action>
    1. Create `src/stores/sidebar-store.ts` (Zustand store for sidebar open/close state):
    ```typescript
    import { create } from 'zustand'

    interface SidebarStore {
      isOpen: boolean
      toggle: () => void
      open: () => void
      close: () => void
    }

    export const useSidebarStore = create<SidebarStore>((set) => ({
      isOpen: true,
      toggle: () => set((state) => ({ isOpen: !state.isOpen })),
      open: () => set({ isOpen: true }),
      close: () => set({ isOpen: false }),
    }))
    ```

    2. Create `src/lib/tier.ts` (tier display and feature gating):
    ```typescript
    import { type TenantRole } from '@/types'

    export function getTierDisplayName(plan: string): string {
      const names: Record<string, string> = {
        trial: 'Free Trial',
        starter: 'Starter',
        pro: 'Pro',
        enterprise: 'Enterprise',
      }
      return names[plan] || plan
    }

    export function getStatusBadgeColor(status: string): string {
      const colors: Record<string, string> = {
        trialing: 'bg-blue-100 text-blue-700',
        active: 'bg-green-100 text-green-700',
        past_due: 'bg-amber-100 text-amber-700',
        canceled: 'bg-red-100 text-red-700',
        unpaid: 'bg-red-100 text-red-700',
      }
      return colors[status] || 'bg-gray-100 text-gray-700'
    }

    // Role hierarchy: owner > admin > dispatcher > viewer
    const ROLE_LEVEL: Record<string, number> = {
      viewer: 0,
      dispatcher: 1,
      admin: 2,
      owner: 3,
    }

    export function hasMinRole(userRole: string, requiredRole: TenantRole): boolean {
      return (ROLE_LEVEL[userRole] ?? 0) >= (ROLE_LEVEL[requiredRole] ?? 0)
    }
    ```

    3. Create `src/components/layout/sidebar.tsx` (client component):
    ```tsx
    'use client'

    import Link from 'next/link'
    import { usePathname } from 'next/navigation'
    import { useSidebarStore } from '@/stores/sidebar-store'
    import { hasMinRole } from '@/lib/tier'
    import {
      LayoutDashboard,
      Truck,
      Package,
      Route,
      Users,
      Building2,
      Receipt,
      Settings,
      X,
    } from 'lucide-react'
    ```

    Install lucide-react first: `npm install lucide-react`

    Define navigation items array:
    ```typescript
    const navItems = [
      { href: '/dashboard', label: 'Dashboard', icon: LayoutDashboard, minRole: 'viewer' as const },
      { href: '/dashboard/orders', label: 'Orders', icon: Package, minRole: 'viewer' as const },
      { href: '/dashboard/trips', label: 'Trips', icon: Route, minRole: 'viewer' as const },
      { href: '/dashboard/drivers', label: 'Drivers', icon: Users, minRole: 'viewer' as const },
      { href: '/dashboard/trucks', label: 'Trucks', icon: Truck, minRole: 'viewer' as const },
      { href: '/dashboard/brokers', label: 'Brokers', icon: Building2, minRole: 'viewer' as const },
      { href: '/dashboard/billing', label: 'Billing', icon: Receipt, minRole: 'dispatcher' as const },
      { href: '/dashboard/settings', label: 'Settings', icon: Settings, minRole: 'admin' as const },
    ]
    ```

    The sidebar component receives `userRole` as a prop and filters nav items using `hasMinRole()`.

    Layout:
    - Fixed left sidebar (w-64 on desktop, overlay on mobile)
    - VroomX logo/branding at top
    - Navigation links with icons and active state highlighting
    - Current path detection via `usePathname()`
    - Mobile: sidebar overlays content with backdrop, close button
    - Desktop: sidebar is always visible when `isOpen` is true
    - Use Tailwind responsive classes: `hidden md:flex` for desktop, overlay for mobile via Zustand toggle

    4. Create `src/components/layout/header.tsx` (client component):
    - Horizontal header bar at top of main content area
    - Left side: hamburger menu button (toggles sidebar on mobile, or toggles collapse on desktop)
    - Right side: UserMenu component
    - Uses `useSidebarStore` for the toggle button

    5. Create `src/components/layout/user-menu.tsx` (client component):
    - Uses shadcn/ui DropdownMenu (install: `npx shadcn@latest add dropdown-menu avatar`)
    - Shows user avatar placeholder (initials circle) + user name
    - Dropdown shows: user name, email, tenant name, role badge, plan badge
    - Separator
    - "Settings" link
    - "Logout" button that calls `logoutAction`
    - Receives user info as props: `{ name, email, tenantName, role, plan, subscriptionStatus }`

    ```tsx
    'use client'

    import { logoutAction } from '@/app/actions/logout'
    import { getTierDisplayName, getStatusBadgeColor } from '@/lib/tier'
    // ... shadcn DropdownMenu imports
    ```

    IMPORTANT: Install lucide-react for icons: `npm install lucide-react`
    IMPORTANT: Install shadcn dropdown-menu and avatar: `npx shadcn@latest add dropdown-menu avatar`
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify all components compile.
    Verify lucide-react is installed: `npm ls lucide-react`
    Verify dropdown-menu component exists: `ls src/components/ui/dropdown-menu.tsx`
    Verify sidebar has all 8 navigation links.
    Verify user-menu imports logoutAction.
    Verify tier.ts exports hasMinRole, getTierDisplayName, getStatusBadgeColor.
  </verify>
  <done>
    Sidebar component with 8 nav links (dashboard, orders, trips, drivers, trucks, brokers, billing, settings), role-based filtering, active state, responsive design. Header with sidebar toggle. User menu dropdown with profile info, role/plan badges, and logout. Zustand store for sidebar state. Tier helpers for display and role checks.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create dashboard layout and empty dashboard page</name>
  <files>
    src/app/(dashboard)/layout.tsx
    src/app/(dashboard)/dashboard/page.tsx
  </files>
  <action>
    1. Create `src/app/(dashboard)/layout.tsx` (Server Component):

    This layout wraps ALL dashboard pages. It:
    a. Fetches the current user via `supabase.auth.getUser()`
    b. Fetches the tenant info from the `tenants` table
    c. Redirects to /login if no user
    d. Redirects to /onboarding if no tenant_id in app_metadata
    e. Passes user + tenant info to Sidebar and Header as props

    ```tsx
    import { createClient } from '@/lib/supabase/server'
    import { redirect } from 'next/navigation'
    import { Sidebar } from '@/components/layout/sidebar'
    import { Header } from '@/components/layout/header'

    export default async function DashboardLayout({ children }: { children: React.ReactNode }) {
      const supabase = await createClient()
      const { data: { user } } = await supabase.auth.getUser()

      if (!user) {
        redirect('/login')
      }

      const tenantId = user.app_metadata?.tenant_id
      if (!tenantId) {
        redirect('/onboarding')
      }

      // Fetch tenant info for display
      const { data: tenant } = await supabase
        .from('tenants')
        .select('name, plan, subscription_status')
        .eq('id', tenantId)
        .single()

      const userRole = user.app_metadata?.role || 'viewer'
      const userName = user.user_metadata?.full_name || user.email || 'User'

      const layoutProps = {
        userName,
        userEmail: user.email || '',
        tenantName: tenant?.name || 'Organization',
        userRole,
        plan: tenant?.plan || 'trial',
        subscriptionStatus: tenant?.subscription_status || 'trialing',
      }

      return (
        <div className="flex h-screen overflow-hidden bg-background">
          <Sidebar userRole={userRole} />
          <div className="flex flex-1 flex-col overflow-hidden">
            <Header {...layoutProps} />
            <main className="flex-1 overflow-y-auto p-6">
              {children}
            </main>
          </div>
        </div>
      )
    }
    ```

    IMPORTANT: The layout is a Server Component -- it can `await createClient()` and fetch data directly. The child components (Sidebar, Header, UserMenu) are client components that receive data as props.

    IMPORTANT: Double-check redirects align with proxy.ts:
    - No user -> /login (proxy does this too, but layout is a safety net)
    - No tenant_id -> /onboarding (proxy does this too)

    2. Create `src/app/(dashboard)/dashboard/page.tsx`:

    An empty dashboard page that welcomes the user and shows their plan status. This is the landing page after login. It also handles the `?setup=complete` query param that Stripe Checkout redirects back to after successful subscription signup.

    ```tsx
    import { createClient } from '@/lib/supabase/server'
    import { redirect } from 'next/navigation'
    import { getTierDisplayName, getStatusBadgeColor } from '@/lib/tier'
    import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'
    import { SetupCompleteBanner } from './setup-complete-banner'

    export default async function DashboardPage({
      searchParams,
    }: {
      searchParams: Promise<{ setup?: string }>
    }) {
      const params = await searchParams
      const showSetupComplete = params.setup === 'complete'
      const supabase = await createClient()
      const { data: { user } } = await supabase.auth.getUser()

      if (!user) redirect('/login')

      const tenantId = user.app_metadata?.tenant_id
      const { data: tenant } = await supabase
        .from('tenants')
        .select('*')
        .eq('id', tenantId)
        .single()

      const plan = tenant?.plan || 'trial'
      const status = tenant?.subscription_status || 'trialing'
      const trialEndsAt = tenant?.trial_ends_at
      const daysLeft = trialEndsAt
        ? Math.max(0, Math.ceil((new Date(trialEndsAt).getTime() - Date.now()) / (1000 * 60 * 60 * 24)))
        : null

      return (
        <div className="space-y-6">
          {showSetupComplete && <SetupCompleteBanner />}

          <div>
            <h1 className="text-3xl font-bold">Dashboard</h1>
            <p className="text-muted-foreground">
              Welcome to VroomX, {user.user_metadata?.full_name || 'there'}
            </p>
          </div>

          <div className="grid gap-4 md:grid-cols-3">
            {/* Plan card */}
            <Card>
              <CardHeader className="pb-2">
                <CardDescription>Current Plan</CardDescription>
                <CardTitle className="text-2xl">{getTierDisplayName(plan)}</CardTitle>
              </CardHeader>
              <CardContent>
                <span className={`inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${getStatusBadgeColor(status)}`}>
                  {status}
                </span>
                {daysLeft !== null && status === 'trialing' && (
                  <p className="mt-2 text-sm text-muted-foreground">
                    {daysLeft} days left in trial
                  </p>
                )}
              </CardContent>
            </Card>

            {/* Organization card */}
            <Card>
              <CardHeader className="pb-2">
                <CardDescription>Organization</CardDescription>
                <CardTitle className="text-2xl">{tenant?.name}</CardTitle>
              </CardHeader>
              <CardContent>
                <p className="text-sm text-muted-foreground">
                  Role: {user.app_metadata?.role || 'viewer'}
                </p>
              </CardContent>
            </Card>

            {/* Quick start card */}
            <Card>
              <CardHeader className="pb-2">
                <CardDescription>Getting Started</CardDescription>
                <CardTitle className="text-2xl">Quick Start</CardTitle>
              </CardHeader>
              <CardContent>
                <p className="text-sm text-muted-foreground">
                  Start by adding your first driver and truck to begin dispatching.
                </p>
              </CardContent>
            </Card>
          </div>

          {/* Placeholder for future dashboard content */}
          <Card>
            <CardContent className="flex items-center justify-center py-12">
              <p className="text-muted-foreground">
                Your dispatch overview will appear here once you start adding orders.
              </p>
            </CardContent>
          </Card>
        </div>
      )
    }
    ```

    3. Create `src/app/(dashboard)/dashboard/setup-complete-banner.tsx` (client component):
    ```tsx
    'use client'

    import { useState } from 'react'
    import { X } from 'lucide-react'

    export function SetupCompleteBanner() {
      const [visible, setVisible] = useState(true)
      if (!visible) return null

      return (
        <div className="flex items-center justify-between rounded-lg border border-green-200 bg-green-50 px-4 py-3 text-green-800 dark:border-green-800 dark:bg-green-950 dark:text-green-200">
          <p className="text-sm font-medium">
            Setup complete! Your subscription is active with a 14-day free trial. Start by adding your first driver and truck.
          </p>
          <button onClick={() => setVisible(false)} className="ml-4 shrink-0">
            <X className="h-4 w-4" />
          </button>
        </div>
      )
    }
    ```

    IMPORTANT: The dashboard page also fetches user/tenant data for display. Yes, the layout already fetches it -- but Server Components don't pass data to children via context. Each Server Component fetches what it needs. Supabase client caches the user session within a request, so `getUser()` is not a duplicate network call.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify both files compile.
    Start dev server and:
    - Verify /dashboard redirects to /login if not authenticated
    - If authenticated: verify sidebar appears with navigation links
    - If authenticated: verify header appears with user menu
    - If authenticated: verify dashboard shows plan card, org card, quick start card
    - Verify sidebar navigation links are present (even though target pages don't exist yet, links should render)
  </verify>
  <done>
    Dashboard layout wraps all dashboard pages with sidebar + header. Fetches user and tenant info server-side, passes to client components as props. Dashboard page shows welcome message, plan status with trial days remaining, organization info, and quick start guidance. Role-based sidebar filtering active. Layout redirects to /login or /onboarding if auth state is incomplete.
  </done>
</task>

</tasks>

<verification>
- All files compile with `npx tsc --noEmit`
- Dashboard layout fetches user + tenant info and passes to components
- Sidebar shows 8 navigation links, filtered by user role
- Header shows sidebar toggle and user menu
- User menu shows profile info with role/plan badges and logout button
- Dashboard page shows plan status, org name, trial days remaining
- Unauthenticated access redirects to /login
- Users without tenant redirect to /onboarding
</verification>

<success_criteria>
- Protected dashboard shell with sidebar navigation
- 8 navigation links with role-based visibility
- User menu with profile info and logout
- Empty dashboard with plan/org/quickstart cards
- Responsive sidebar (collapsible on mobile)
- Tier display helpers (plan names, status colors, role checks)
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-setup-auth-multi-tenancy/01-07-SUMMARY.md`
</output>
