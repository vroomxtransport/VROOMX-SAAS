---
phase: 01-project-setup-auth-multi-tenancy
plan: 08
type: execute
wave: 5
depends_on: ["01-06"]
files_modified:
  - instrumentation-client.ts
  - sentry.server.config.ts
  - sentry.edge.config.ts
  - instrumentation.ts
  - src/app/global-error.tsx
  - next.config.ts
  - src/app/providers.tsx
  - src/app/layout.tsx
  - .sentryclirc
autonomous: true

user_setup:
  - service: sentry
    why: "Error monitoring and alerting"
    env_vars:
      - name: SENTRY_DSN
        source: "Sentry Dashboard -> Project Settings -> Client Keys (DSN)"
      - name: SENTRY_AUTH_TOKEN
        source: "Sentry Dashboard -> Settings -> Auth Tokens -> Create New Token (project:releases, org:read scopes)"
    dashboard_config:
      - task: "Create a Sentry project"
        location: "Sentry Dashboard -> Projects -> Create Project -> Next.js"
  - service: posthog
    why: "Product analytics, feature flags, session replay"
    env_vars:
      - name: NEXT_PUBLIC_POSTHOG_KEY
        source: "PostHog Dashboard -> Settings -> Project API Key"
    dashboard_config:
      - task: "Create a PostHog project"
        location: "PostHog Dashboard -> Organization Settings -> Projects -> Create Project"
  - service: vercel
    why: "Hosting and CI/CD"
    dashboard_config:
      - task: "Connect GitHub repo for auto-deploy"
        location: "Vercel Dashboard -> New Project -> Import Git Repository"

must_haves:
  truths:
    - "Sentry captures unhandled errors in browser and server"
    - "PostHog tracks page views for authenticated users"
    - "PostHog uses reverse proxy (/ingest) to bypass ad blockers"
    - "Global error boundary catches React rendering errors"
    - "Source maps are uploaded to Sentry during build"
  artifacts:
    - path: "instrumentation-client.ts"
      provides: "Browser-side Sentry init"
      contains: "Sentry.init"
    - path: "sentry.server.config.ts"
      provides: "Server-side Sentry init"
      contains: "Sentry.init"
    - path: "src/app/global-error.tsx"
      provides: "React error boundary"
      contains: "captureException"
    - path: "src/app/providers.tsx"
      provides: "PostHog provider for client-side analytics"
      contains: "PostHogProvider"
    - path: "next.config.ts"
      provides: "Sentry + PostHog config"
      contains: "withSentryConfig"
  key_links:
    - from: "src/app/layout.tsx"
      to: "src/app/providers.tsx"
      via: "wraps children with providers"
      pattern: "<Providers"
    - from: "next.config.ts"
      to: "@sentry/nextjs"
      via: "withSentryConfig wrapper"
      pattern: "withSentryConfig"
    - from: "src/app/providers.tsx"
      to: "/ingest"
      via: "PostHog reverse proxy"
      pattern: "api_host.*ingest"
---

<objective>
Integrate Sentry for error monitoring and PostHog for product analytics. Run the Sentry wizard to auto-generate config files, then create the PostHog provider component and wire both into the app.

Purpose: Without observability, bugs and user behavior are invisible. Sentry catches errors before users report them. PostHog shows what features people actually use.
Output: Sentry capturing errors, PostHog tracking page views, global error boundary, source maps uploaded on build.
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/reepsy/Desktop/VROOMX_SAAS/.planning/PROJECT.md
@/Users/reepsy/Desktop/VROOMX_SAAS/.planning/ROADMAP.md
@/Users/reepsy/Desktop/VROOMX_SAAS/.planning/phases/01-project-setup-auth-multi-tenancy/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run Sentry wizard and configure error monitoring</name>
  <files>
    instrumentation-client.ts
    sentry.server.config.ts
    sentry.edge.config.ts
    instrumentation.ts
    src/app/global-error.tsx
    next.config.ts
    .sentryclirc
  </files>
  <action>
    1. Run the Sentry wizard:
    ```bash
    npx @sentry/wizard@latest -i nextjs --org YOUR_ORG --project YOUR_PROJECT
    ```

    The wizard will:
    - Create `instrumentation-client.ts` (browser Sentry init)
    - Create `sentry.server.config.ts` (server Sentry init)
    - Create `sentry.edge.config.ts` (edge runtime Sentry init)
    - Create/update `instrumentation.ts` (registers server + edge configs)
    - Create `src/app/global-error.tsx` (React error boundary)
    - Wrap `next.config.ts` with `withSentryConfig()`
    - May create `.sentryclirc` with auth token

    NOTE: If the Sentry wizard prompts interactively and cannot run non-interactively, manually create the files based on the Sentry Next.js docs. The key files and their content:

    2. If wizard fails or needs manual setup, create files manually:

    **instrumentation-client.ts** (project root):
    ```typescript
    import * as Sentry from '@sentry/nextjs'

    Sentry.init({
      dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
      tracesSampleRate: 1.0,
      replaysSessionSampleRate: 0.1,
      replaysOnErrorSampleRate: 1.0,
      integrations: [
        Sentry.replayIntegration(),
      ],
    })
    ```

    **sentry.server.config.ts** (project root):
    ```typescript
    import * as Sentry from '@sentry/nextjs'

    Sentry.init({
      dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
      tracesSampleRate: 1.0,
    })
    ```

    **sentry.edge.config.ts** (project root):
    ```typescript
    import * as Sentry from '@sentry/nextjs'

    Sentry.init({
      dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
      tracesSampleRate: 1.0,
    })
    ```

    **instrumentation.ts** (project root):
    ```typescript
    export async function register() {
      if (process.env.NEXT_RUNTIME === 'nodejs') {
        await import('./sentry.server.config')
      }
      if (process.env.NEXT_RUNTIME === 'edge') {
        await import('./sentry.edge.config')
      }
    }

    export const onRequestError = (await import('@sentry/nextjs')).captureRequestError
    ```
    NOTE: The `onRequestError` export may need adjustment based on the actual @sentry/nextjs API. Check the installed version.

    **src/app/global-error.tsx**:
    ```tsx
    'use client'

    import * as Sentry from '@sentry/nextjs'
    import { useEffect } from 'react'

    export default function GlobalError({
      error,
      reset,
    }: {
      error: Error & { digest?: string }
      reset: () => void
    }) {
      useEffect(() => {
        Sentry.captureException(error)
      }, [error])

      return (
        <html>
          <body>
            <div className="flex min-h-screen items-center justify-center">
              <div className="text-center">
                <h2 className="text-2xl font-bold">Something went wrong</h2>
                <p className="mt-2 text-muted-foreground">
                  An unexpected error occurred. Our team has been notified.
                </p>
                <button
                  onClick={reset}
                  className="mt-4 rounded-md bg-primary px-4 py-2 text-primary-foreground"
                >
                  Try again
                </button>
              </div>
            </div>
          </body>
        </html>
      )
    }
    ```

    3. Update `next.config.ts` to wrap with Sentry AND keep PostHog rewrites:
    ```typescript
    import { withSentryConfig } from '@sentry/nextjs'
    import type { NextConfig } from 'next'

    const nextConfig: NextConfig = {
      async rewrites() {
        return [
          {
            source: '/ingest/:path*',
            destination: 'https://us.i.posthog.com/:path*',
          },
        ]
      },
    }

    export default withSentryConfig(nextConfig, {
      // Sentry organization and project
      org: process.env.SENTRY_ORG,
      project: process.env.SENTRY_PROJECT,

      // Suppress source map upload logs in CI
      silent: !process.env.CI,

      // Upload source maps to Sentry
      widenClientFileUpload: true,

      // Tunnel Sentry events through Next.js to avoid ad blockers
      tunnelRoute: '/monitoring',

      // Disable Sentry logger
      disableLogger: true,

      // Automatically instrument server functions
      autoInstrumentServerFunctions: true,
      autoInstrumentMiddleware: true,
    })
    ```

    IMPORTANT: The PostHog rewrites MUST be preserved inside the nextConfig before wrapping with withSentryConfig.

    IMPORTANT: Add `NEXT_PUBLIC_SENTRY_DSN` to `.env.local.example` if not already present (it may be listed as `SENTRY_DSN` -- PostHog and Sentry both need their DSN accessible client-side via NEXT_PUBLIC_ prefix for browser error reporting).

    4. Add `.sentryclirc` to `.gitignore` (contains auth token -- should not be committed):
    Add this line to `.gitignore`: `.sentryclirc`
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify all Sentry files compile.
    Verify `next.config.ts` uses `withSentryConfig` wrapper AND contains PostHog rewrites.
    Verify `src/app/global-error.tsx` calls `Sentry.captureException`.
    Verify `instrumentation.ts` imports server and edge configs.
    Verify `.sentryclirc` is in `.gitignore`.
    Run `npm run build` (optional -- may fail without env vars, but should not have TypeScript errors).
  </verify>
  <done>
    Sentry integrated: browser/server/edge init files, global error boundary, source map upload via withSentryConfig, instrumentation hooks. next.config.ts wraps with Sentry while preserving PostHog rewrites. .sentryclirc gitignored.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PostHog provider and wire into root layout</name>
  <files>
    src/app/providers.tsx
    src/app/layout.tsx
  </files>
  <action>
    1. Create `src/app/providers.tsx` (client component that wraps the app with PostHog):
    ```tsx
    'use client'

    import posthog from 'posthog-js'
    import { PostHogProvider as PHProvider, usePostHog } from 'posthog-js/react'
    import { useEffect, Suspense } from 'react'
    import { usePathname, useSearchParams } from 'next/navigation'

    // Initialize PostHog (runs once on mount)
    function PostHogInit() {
      useEffect(() => {
        if (typeof window !== 'undefined' && process.env.NEXT_PUBLIC_POSTHOG_KEY) {
          posthog.init(process.env.NEXT_PUBLIC_POSTHOG_KEY!, {
            api_host: '/ingest', // Reverse proxy to avoid ad blockers
            person_profiles: 'identified_only',
            capture_pageview: false, // We capture manually below
            capture_pageleave: true,
          })
        }
      }, [])

      return null
    }

    // Capture page views on route change (App Router)
    function PostHogPageView() {
      const pathname = usePathname()
      const searchParams = useSearchParams()
      const posthogClient = usePostHog()

      useEffect(() => {
        if (pathname && posthogClient) {
          let url = window.origin + pathname
          if (searchParams.toString()) {
            url = url + '?' + searchParams.toString()
          }
          posthogClient.capture('$pageview', { $current_url: url })
        }
      }, [pathname, searchParams, posthogClient])

      return null
    }

    export function Providers({ children }: { children: React.ReactNode }) {
      return (
        <PHProvider client={posthog}>
          <PostHogInit />
          <Suspense fallback={null}>
            <PostHogPageView />
          </Suspense>
          {children}
        </PHProvider>
      )
    }
    ```

    IMPORTANT: `capture_pageview: false` is set because the App Router does not trigger full page loads on navigation. Instead, we manually capture `$pageview` events on pathname changes via the `PostHogPageView` component.

    IMPORTANT: `useSearchParams()` must be wrapped in `<Suspense>` in Next.js 16 (it's a client-side hook that can suspend).

    IMPORTANT: The `api_host: '/ingest'` routes PostHog requests through the Next.js rewrites defined in `next.config.ts`, which proxies to `https://us.i.posthog.com`. This avoids ad blockers that block direct PostHog requests.

    2. Update `src/app/layout.tsx` to wrap children with the Providers component:
    ```tsx
    import type { Metadata } from 'next'
    import { Inter } from 'next/font/google'
    import './globals.css'
    import { Providers } from './providers'

    const inter = Inter({ subsets: ['latin'] })

    export const metadata: Metadata = {
      title: 'VroomX TMS',
      description: 'Transportation Management System for Vehicle Transport Carriers',
    }

    export default function RootLayout({
      children,
    }: {
      children: React.ReactNode
    }) {
      return (
        <html lang="en" suppressHydrationWarning>
          <body className={inter.className}>
            <Providers>
              {children}
            </Providers>
          </body>
        </html>
      )
    }
    ```

    IMPORTANT: Keep the existing globals.css import. Keep any existing font setup from create-next-app (may use `next/font/google` or `next/font/local`). The key change is wrapping `{children}` with `<Providers>`.

    IMPORTANT: Read the existing layout.tsx first before modifying. Preserve what create-next-app generated, only add the Providers wrapper.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify all files compile.
    Start dev server and:
    - Open browser DevTools Network tab
    - Navigate to a page
    - Verify PostHog requests go to `/ingest/...` (not directly to posthog.com)
    - If NEXT_PUBLIC_POSTHOG_KEY is not set, verify no errors (graceful degradation)
    Verify `src/app/layout.tsx` wraps children with `<Providers>`.
    Verify `src/app/providers.tsx` uses `api_host: '/ingest'`.
  </verify>
  <done>
    PostHog provider created with: manual page view tracking for App Router, reverse proxy via /ingest to bypass ad blockers, identified_only person profiles. Root layout updated to wrap all pages with Providers. PostHog gracefully degrades if API key is not set (no errors).
  </done>
</task>

</tasks>

<verification>
- All files compile with `npx tsc --noEmit`
- Sentry init files exist for browser, server, and edge runtimes
- Global error boundary catches and reports React errors
- next.config.ts wraps with withSentryConfig and keeps PostHog rewrites
- PostHog provider in root layout with reverse proxy
- Manual page view tracking for App Router navigation
- .sentryclirc in .gitignore
</verification>

<success_criteria>
- Sentry captures unhandled errors (browser + server)
- PostHog tracks page views via reverse proxy (/ingest)
- Global error boundary shows user-friendly error page
- Source maps uploaded to Sentry on build
- Both tools degrade gracefully without API keys
- next.config.ts cleanly combines Sentry + PostHog configs
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-setup-auth-multi-tenancy/01-08-SUMMARY.md`
</output>
