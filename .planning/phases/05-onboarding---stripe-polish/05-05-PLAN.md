---
phase: 05-onboarding---stripe-polish
plan: 05
type: execute
wave: 3
depends_on: ["05-01", "05-03"]
files_modified:
  - src/app/(dashboard)/dashboard/page.tsx
  - src/app/(dashboard)/layout.tsx
  - src/app/(dashboard)/settings/billing-section.tsx
  - src/app/(dashboard)/settings/usage-section.tsx
  - src/app/(dashboard)/settings/page.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard shows onboarding wizard when entity counts are zero"
    - "Onboarding wizard links to create first driver, truck, and order"
    - "Settings page shows billing section with plan info and Manage Subscription button"
    - "Settings page shows usage section with current/limit for trucks and users"
    - "Grace period banner appears in dashboard layout when subscription is past_due"
    - "Suspended accounts see a suspension overlay blocking data mutation"
    - "Billing portal button redirects to Stripe"
  artifacts:
    - path: "src/app/(dashboard)/dashboard/page.tsx"
      provides: "Dashboard with smart onboarding CTA when entity counts are zero"
      contains: "onboarding"
    - path: "src/app/(dashboard)/layout.tsx"
      provides: "Layout with grace period banner and suspension check"
      contains: "grace_period_ends_at"
    - path: "src/app/(dashboard)/settings/billing-section.tsx"
      provides: "Billing section with plan info and portal link"
      contains: "createBillingPortalSession"
    - path: "src/app/(dashboard)/settings/usage-section.tsx"
      provides: "Usage dashboard showing current resource counts vs limits"
      contains: "TIER_LIMITS"
    - path: "src/app/(dashboard)/settings/page.tsx"
      provides: "Settings page with billing and usage sections added"
      contains: "BillingSection"
  key_links:
    - from: "src/app/(dashboard)/settings/billing-section.tsx"
      to: "src/app/actions/billing.ts"
      via: "form action calls createBillingPortalSession"
      pattern: "createBillingPortalSession"
    - from: "src/app/(dashboard)/layout.tsx"
      to: "tenants table"
      via: "Layout fetches grace_period_ends_at and is_suspended"
      pattern: "grace_period_ends_at|is_suspended"
---

<objective>
Build the onboarding wizard (as smart CTA on dashboard), billing/usage sections on settings page, and grace period/suspension UX in the dashboard layout.

Purpose: New users get guided through first setup. Existing users can manage subscriptions and see usage limits. Accounts with payment issues see clear messaging instead of being silently locked out.
Output: Enhanced dashboard with onboarding CTA, settings page with billing and usage, layout with dunning banners.
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@src/app/(dashboard)/dashboard/page.tsx
@src/app/(dashboard)/layout.tsx
@src/app/(dashboard)/settings/page.tsx
@src/app/actions/billing.ts
@src/lib/tier.ts
@src/types/index.ts
@.planning/phases/05-onboarding---stripe-polish/05-01-SUMMARY.md
@.planning/phases/05-onboarding---stripe-polish/05-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dashboard onboarding wizard and layout grace period/suspension banner</name>
  <files>src/app/(dashboard)/dashboard/page.tsx, src/app/(dashboard)/layout.tsx</files>
  <action>
**1. Update `src/app/(dashboard)/dashboard/page.tsx`:**

Replace the static Quick Start Guide card and hardcoded "0" stat cards with a smart onboarding section. The dashboard already fetches tenant data. Add entity count queries:

After the existing tenant fetch, add:
```typescript
// Fetch entity counts for onboarding detection and stat cards
const [trucksResult, driversResult, ordersResult] = await Promise.all([
  supabase.from('trucks').select('id', { count: 'exact', head: true }).eq('tenant_id', tenantId),
  supabase.from('drivers').select('id', { count: 'exact', head: true }).eq('tenant_id', tenantId),
  supabase.from('orders').select('id', { count: 'exact', head: true }).eq('tenant_id', tenantId),
])

const truckCount = trucksResult.count ?? 0
const driverCount = driversResult.count ?? 0
const orderCount = ordersResult.count ?? 0
const isNewUser = truckCount === 0 && driverCount === 0 && orderCount === 0
```

Replace the hardcoded "0" values in stat cards with actual counts.

Replace the Quick Start Guide card with a conditional onboarding section:

```typescript
{isNewUser ? (
  <Card className="border-blue-200 bg-blue-50/50">
    <CardHeader>
      <CardTitle>Get Started with VroomX</CardTitle>
      <CardDescription>Complete these steps to start dispatching loads.</CardDescription>
    </CardHeader>
    <CardContent>
      <div className="space-y-4">
        {/* Step 1: Add a driver */}
        <a href="/drivers" className="flex items-center gap-4 rounded-lg border bg-white p-4 transition-colors hover:border-blue-300 hover:bg-blue-50">
          <div className="flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-blue-100">
            <Users className="h-5 w-5 text-blue-600" />
          </div>
          <div className="flex-1">
            <p className="font-medium text-gray-900">Add Your First Driver</p>
            <p className="text-sm text-gray-500">Set up a driver with pay configuration</p>
          </div>
          <ChevronRight className="h-5 w-5 text-gray-400" />
        </a>

        {/* Step 2: Add a truck */}
        <a href="/trucks" className="flex items-center gap-4 rounded-lg border bg-white p-4 transition-colors hover:border-blue-300 hover:bg-blue-50">
          <div className="flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-blue-100">
            <Truck className="h-5 w-5 text-blue-600" />
          </div>
          <div className="flex-1">
            <p className="font-medium text-gray-900">Add Your First Truck</p>
            <p className="text-sm text-gray-500">Register a vehicle in your fleet</p>
          </div>
          <ChevronRight className="h-5 w-5 text-gray-400" />
        </a>

        {/* Step 3: Create an order */}
        <a href="/orders" className="flex items-center gap-4 rounded-lg border bg-white p-4 transition-colors hover:border-blue-300 hover:bg-blue-50">
          <div className="flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-blue-100">
            <Package className="h-5 w-5 text-blue-600" />
          </div>
          <div className="flex-1">
            <p className="font-medium text-gray-900">Create Your First Order</p>
            <p className="text-sm text-gray-500">Start managing vehicle transport loads</p>
          </div>
          <ChevronRight className="h-5 w-5 text-gray-400" />
        </a>
      </div>
    </CardContent>
  </Card>
) : (
  // Show the existing "Your Plan" and "Organization" cards for non-new users
  // (Keep the existing grid with plan and org cards)
)}
```

Import `ChevronRight` from `lucide-react`.

When `isNewUser` is false, show the existing plan/org cards. Keep the stat cards always visible (they now show real counts).

Also add revenue MTD calculation:
```typescript
// Fetch month-to-date revenue
const startOfMonth = new Date()
startOfMonth.setDate(1)
startOfMonth.setHours(0, 0, 0, 0)

const { data: revenueData } = await supabase
  .from('orders')
  .select('revenue')
  .eq('tenant_id', tenantId)
  .gte('created_at', startOfMonth.toISOString())

const monthlyRevenue = (revenueData || []).reduce(
  (sum, o) => sum + parseFloat(o.revenue || '0'), 0
)
```

Use `monthlyRevenue` in the Revenue (MTD) card with proper dollar formatting.

**2. Update `src/app/(dashboard)/layout.tsx`:**

Extend the tenant query to include `grace_period_ends_at` and `is_suspended`:

Change the select from:
```typescript
.select('name, plan, subscription_status')
```
to:
```typescript
.select('name, plan, subscription_status, grace_period_ends_at, is_suspended')
```

Add grace period/suspension banners inside the layout, above `{children}`:

```typescript
{/* Suspension overlay */}
{tenant.is_suspended && (
  <div className="mx-4 mb-4 rounded-lg border border-red-200 bg-red-50 p-4 lg:mx-6">
    <div className="flex items-center gap-3">
      <AlertTriangle className="h-5 w-5 text-red-600 shrink-0" />
      <div className="flex-1">
        <p className="text-sm font-medium text-red-900">Account Suspended</p>
        <p className="text-sm text-red-700">
          Your account has been suspended due to a failed payment. Please update your payment method to restore access.
          You can view existing data but cannot create new resources.
        </p>
      </div>
      <form action={async () => { 'use server'; const { createBillingPortalSession } = await import('@/app/actions/billing'); await createBillingPortalSession(); }}>
        <button type="submit" className="rounded-md bg-red-600 px-3 py-1.5 text-sm font-medium text-white hover:bg-red-700">
          Update Payment
        </button>
      </form>
    </div>
  </div>
)}

{/* Grace period warning */}
{!tenant.is_suspended && tenant.grace_period_ends_at && (
  <div className="mx-4 mb-4 rounded-lg border border-amber-200 bg-amber-50 p-4 lg:mx-6">
    <div className="flex items-center gap-3">
      <AlertTriangle className="h-5 w-5 text-amber-600 shrink-0" />
      <div className="flex-1">
        <p className="text-sm font-medium text-amber-900">Payment Issue</p>
        <p className="text-sm text-amber-700">
          Your recent payment failed. Please update your payment method by{' '}
          {new Date(tenant.grace_period_ends_at).toLocaleDateString()} to avoid service interruption.
        </p>
      </div>
      <form action={async () => { 'use server'; const { createBillingPortalSession } = await import('@/app/actions/billing'); await createBillingPortalSession(); }}>
        <button type="submit" className="rounded-md bg-amber-600 px-3 py-1.5 text-sm font-medium text-white hover:bg-amber-700">
          Update Payment
        </button>
      </form>
    </div>
  </div>
)}
```

Import `AlertTriangle` from `lucide-react`.

**Note on inline server actions in layout:** The `form action` pattern with an inline async function that imports the billing action is valid in Next.js Server Components. It avoids importing the billing action at the top level (which would always load Stripe code even when not needed).
  </action>
  <verify>Run `npx tsc --noEmit`. Verify dashboard shows real entity counts. Verify onboarding wizard appears when all counts are zero. Verify grace period banner appears in layout when grace_period_ends_at is set. Verify suspension banner appears when is_suspended is true. Verify "Update Payment" buttons trigger billing portal redirect.</verify>
  <done>Dashboard shows smart onboarding CTA when entity counts are zero, with clickable steps linking to drivers/trucks/orders pages. Stat cards show real counts. Layout shows amber grace period banner and red suspension banner with "Update Payment" buttons that redirect to Stripe Billing Portal.</done>
</task>

<task type="auto">
  <name>Task 2: Settings page billing and usage sections</name>
  <files>src/app/(dashboard)/settings/billing-section.tsx, src/app/(dashboard)/settings/usage-section.tsx, src/app/(dashboard)/settings/page.tsx</files>
  <action>
**1. Create `src/app/(dashboard)/settings/billing-section.tsx`:**

Client component showing plan info with Manage Subscription button:

```typescript
'use client'

import { createBillingPortalSession } from '@/app/actions/billing'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import { getTierDisplayName, getStatusBadgeColor } from '@/lib/tier'
import { TIER_PRICING, type SubscriptionPlan } from '@/types'
import { CreditCard } from 'lucide-react'
import { useState } from 'react'

interface BillingSectionProps {
  plan: string
  subscriptionStatus: string
  hasStripeCustomer: boolean
}

export function BillingSection({ plan, subscriptionStatus, hasStripeCustomer }: BillingSectionProps) {
  const [loading, setLoading] = useState(false)

  async function handleManageSubscription() {
    setLoading(true)
    try {
      await createBillingPortalSession()
    } catch {
      // redirect throws, which is caught by Next.js
    }
    setLoading(false)
  }

  const planKey = plan as SubscriptionPlan
  const price = TIER_PRICING[planKey]

  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <CreditCard className="h-5 w-5" />
          Billing
        </CardTitle>
        <CardDescription>Manage your subscription and payment method.</CardDescription>
      </CardHeader>
      <CardContent className="space-y-4">
        <div className="flex items-center justify-between">
          <span className="text-sm text-gray-600">Current Plan</span>
          <span className="font-medium">{getTierDisplayName(plan)}</span>
        </div>

        <div className="flex items-center justify-between">
          <span className="text-sm text-gray-600">Status</span>
          <Badge className={getStatusBadgeColor(subscriptionStatus)}>
            {subscriptionStatus}
          </Badge>
        </div>

        {price && (
          <div className="flex items-center justify-between">
            <span className="text-sm text-gray-600">Monthly Price</span>
            <span className="font-medium">${price}/mo</span>
          </div>
        )}

        {hasStripeCustomer && (
          <Button
            onClick={handleManageSubscription}
            disabled={loading}
            className="w-full"
            variant="outline"
          >
            {loading ? 'Opening...' : 'Manage Subscription'}
          </Button>
        )}
      </CardContent>
    </Card>
  )
}
```

**2. Create `src/app/(dashboard)/settings/usage-section.tsx`:**

Server-rendered component showing resource usage vs limits:

```typescript
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Progress } from '@/components/ui/progress'
import { TIER_LIMITS, type SubscriptionPlan } from '@/types'
import { BarChart3 } from 'lucide-react'

interface UsageSectionProps {
  plan: string
  truckCount: number
  userCount: number
}

export function UsageSection({ plan, truckCount, userCount }: UsageSectionProps) {
  const tierKey = (plan === 'trial' ? 'starter' : plan) as SubscriptionPlan
  const limits = TIER_LIMITS[tierKey] || TIER_LIMITS.starter

  const truckLimit = limits.trucks === Infinity ? -1 : limits.trucks
  const userLimit = limits.users === Infinity ? -1 : limits.users

  const truckPercent = truckLimit === -1 ? 0 : Math.min((truckCount / truckLimit) * 100, 100)
  const userPercent = userLimit === -1 ? 0 : Math.min((userCount / userLimit) * 100, 100)

  function getBarColor(percent: number): string {
    if (percent >= 90) return 'bg-red-500'
    if (percent >= 70) return 'bg-amber-500'
    return 'bg-blue-500'
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <BarChart3 className="h-5 w-5" />
          Usage
        </CardTitle>
        <CardDescription>Current resource usage against your plan limits.</CardDescription>
      </CardHeader>
      <CardContent className="space-y-6">
        {/* Trucks */}
        <div className="space-y-2">
          <div className="flex items-center justify-between text-sm">
            <span className="text-gray-600">Trucks</span>
            <span className="font-medium">
              {truckCount} / {truckLimit === -1 ? 'Unlimited' : truckLimit}
            </span>
          </div>
          {truckLimit !== -1 && (
            <div className="h-2 rounded-full bg-gray-100">
              <div
                className={`h-2 rounded-full transition-all ${getBarColor(truckPercent)}`}
                style={{ width: `${truckPercent}%` }}
              />
            </div>
          )}
        </div>

        {/* Users */}
        <div className="space-y-2">
          <div className="flex items-center justify-between text-sm">
            <span className="text-gray-600">Team Members</span>
            <span className="font-medium">
              {userCount} / {userLimit === -1 ? 'Unlimited' : userLimit}
            </span>
          </div>
          {userLimit !== -1 && (
            <div className="h-2 rounded-full bg-gray-100">
              <div
                className={`h-2 rounded-full transition-all ${getBarColor(userPercent)}`}
                style={{ width: `${userPercent}%` }}
              />
            </div>
          )}
        </div>

        {/* Upgrade CTA for non-enterprise plans */}
        {plan !== 'enterprise' && (truckPercent >= 70 || userPercent >= 70) && (
          <div className="rounded-lg bg-blue-50 p-3">
            <p className="text-sm text-blue-900">
              Approaching your plan limits.{' '}
              <a href="/settings" className="font-medium underline">Upgrade your plan</a> for more capacity.
            </p>
          </div>
        )}
      </CardContent>
    </Card>
  )
}
```

**3. Update `src/app/(dashboard)/settings/page.tsx`:**

Add billing and usage sections to the settings page. Import `BillingSection` and `UsageSection`.

Add data fetching for usage counts after the existing queries:

```typescript
// Fetch counts for usage section
const [trucksCount, membershipsCount] = await Promise.all([
  supabase.from('trucks').select('id', { count: 'exact', head: true }).eq('tenant_id', tenantId),
  admin.from('tenant_memberships').select('id', { count: 'exact', head: true }).eq('tenant_id', tenantId),
])
```

Add the sections to the JSX, BEFORE the TeamSection:

```typescript
import { BillingSection } from './billing-section'
import { UsageSection } from './usage-section'

// In the return JSX, after the heading and before TeamSection:
<div className="grid gap-6 md:grid-cols-2">
  <BillingSection
    plan={tenant.plan}
    subscriptionStatus={tenant.subscription_status}
    hasStripeCustomer={!!tenant.stripe_customer_id}
  />
  <UsageSection
    plan={tenant.plan}
    truckCount={trucksCount.count ?? 0}
    userCount={membershipsCount.count ?? 0}
  />
</div>
```

Add `subscription_status` to the tenant select query if not already included.
  </action>
  <verify>Run `npx tsc --noEmit`. Verify settings page shows billing section with plan info and Manage Subscription button. Verify usage section shows truck/user counts with progress bars. Verify progress bars change color at 70% and 90%. Verify upgrade CTA appears when approaching limits.</verify>
  <done>Settings page has Billing section (plan, status, price, Manage Subscription button linking to Stripe portal), Usage section (truck/user counts with colored progress bars, upgrade CTA at 70%+). Dashboard shows smart onboarding wizard for new users and real stat counts for existing users. Layout shows grace period and suspension banners with Update Payment buttons.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- Dashboard shows entity counts and onboarding wizard when all zero
- Dashboard shows plan/org cards when user has existing data
- Settings page shows billing section with Manage Subscription button
- Settings page shows usage bars with correct counts and limits
- Layout shows amber banner when grace_period_ends_at is set
- Layout shows red banner when is_suspended is true
- Update Payment buttons redirect to Stripe Billing Portal
- Progress bars are color-coded: blue (<70%), amber (70-90%), red (90%+)
</verification>

<success_criteria>
- New user sees onboarding wizard on dashboard with links to create first resources
- Existing user sees real stat counts on dashboard
- Settings page has functional billing management via Stripe portal
- Usage dashboard shows current/limit with visual progress bars
- Grace period warning visible during 14-day grace window
- Suspended account sees clear error with payment update link
- All existing functionality preserved (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/05-onboarding---stripe-polish/05-05-SUMMARY.md`
</output>
