---
phase: 05-onboarding---stripe-polish
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/lib/tier.ts
  - src/app/actions/trucks.ts
  - src/app/actions/drivers.ts
autonomous: true

must_haves:
  truths:
    - "checkTierLimit returns allowed/current/limit for trucks and users"
    - "isAccountSuspended returns boolean based on is_suspended or expired grace period"
    - "Creating a 6th truck on Starter plan returns a limit error"
    - "Creating a 4th user on Starter plan returns a limit error"
    - "Enterprise plan allows unlimited trucks and users"
    - "Suspended account cannot create trucks or drivers"
  artifacts:
    - path: "src/lib/tier.ts"
      provides: "checkTierLimit and isAccountSuspended functions"
      exports: ["checkTierLimit", "isAccountSuspended"]
    - path: "src/app/actions/trucks.ts"
      provides: "createTruck with tier limit and suspension check"
      contains: "checkTierLimit"
    - path: "src/app/actions/drivers.ts"
      provides: "createDriver with tier limit and suspension check"
      contains: "checkTierLimit"
  key_links:
    - from: "src/app/actions/trucks.ts"
      to: "src/lib/tier.ts"
      via: "import checkTierLimit"
      pattern: "checkTierLimit.*trucks"
    - from: "src/app/actions/drivers.ts"
      to: "src/lib/tier.ts"
      via: "import checkTierLimit"
      pattern: "checkTierLimit.*users"
---

<objective>
Add tier-based limit enforcement to Server Actions for trucks and drivers. Implement checkTierLimit and isAccountSuspended utility functions.

Purpose: Starter users cannot exceed 5 trucks / 3 users, Pro users cannot exceed 20 trucks / 10 users. Suspended accounts are blocked from creating new resources. This is the application-layer enforcement -- the DB triggers from Plan 01 provide the last line of defense.
Output: Updated tier.ts with enforcement functions, updated createTruck and createDriver Server Actions with limit checks.
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@src/lib/tier.ts
@src/app/actions/trucks.ts
@src/app/actions/drivers.ts
@src/types/index.ts
@.planning/phases/05-onboarding---stripe-polish/05-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add checkTierLimit and isAccountSuspended to tier.ts</name>
  <files>src/lib/tier.ts</files>
  <action>
Extend `src/lib/tier.ts` with two new exported functions. Keep all existing functions (getTierDisplayName, getStatusBadgeColor, hasMinRole) unchanged.

**1. checkTierLimit function:**

```typescript
import { TIER_LIMITS, type SubscriptionPlan } from '@/types'

export async function checkTierLimit(
  supabase: any,  // SupabaseClient type -- using any for simplicity like existing patterns
  tenantId: string,
  resource: 'trucks' | 'users'
): Promise<{ allowed: boolean; current: number; limit: number; plan: string }> {
  // Fetch tenant plan from DB (always check DB, never JWT -- JWT may be stale per Pitfall 2)
  const { data: tenant } = await supabase
    .from('tenants')
    .select('plan, is_suspended')
    .eq('id', tenantId)
    .single()

  if (!tenant) {
    return { allowed: false, current: 0, limit: 0, plan: 'unknown' }
  }

  // Suspended accounts cannot create anything
  if (tenant.is_suspended) {
    return { allowed: false, current: 0, limit: 0, plan: tenant.plan }
  }

  // Map plan to tier limits. 'trial' uses starter limits.
  const plan = tenant.plan as SubscriptionPlan
  const tierKey = plan === ('trial' as any) ? 'starter' : plan
  const limits = TIER_LIMITS[tierKey as SubscriptionPlan]

  if (!limits) {
    return { allowed: false, current: 0, limit: 0, plan: tenant.plan }
  }

  const limit = limits[resource]

  // Count current resources
  const table = resource === 'trucks' ? 'trucks' : 'tenant_memberships'
  const { count } = await supabase
    .from(table)
    .select('id', { count: 'exact', head: true })
    .eq('tenant_id', tenantId)

  const current = count ?? 0

  return {
    allowed: limit === Infinity ? true : current < limit,
    current,
    limit: limit === Infinity ? -1 : limit,  // -1 signals unlimited
    plan: tenant.plan,
  }
}
```

**2. isAccountSuspended function:**

```typescript
export async function isAccountSuspended(
  supabase: any,
  tenantId: string
): Promise<{ suspended: boolean; gracePeriodEndsAt: string | null }> {
  const { data: tenant } = await supabase
    .from('tenants')
    .select('is_suspended, grace_period_ends_at')
    .eq('id', tenantId)
    .single()

  if (!tenant) {
    return { suspended: false, gracePeriodEndsAt: null }
  }

  // Check if grace period has expired but is_suspended hasn't been set yet
  if (tenant.grace_period_ends_at && !tenant.is_suspended) {
    const graceEnd = new Date(tenant.grace_period_ends_at)
    if (graceEnd < new Date()) {
      // Grace period expired -- mark as suspended
      await supabase
        .from('tenants')
        .update({ is_suspended: true })
        .eq('id', tenantId)
      return { suspended: true, gracePeriodEndsAt: tenant.grace_period_ends_at }
    }
  }

  return {
    suspended: tenant.is_suspended,
    gracePeriodEndsAt: tenant.grace_period_ends_at,
  }
}
```

Import `TIER_LIMITS` and `SubscriptionPlan` from `@/types` at the top of the file. The existing import of `TenantRole` stays.
  </action>
  <verify>Run `npx tsc --noEmit` to confirm no TypeScript errors. Verify functions are exported correctly. Check that checkTierLimit handles 'trial' plan by mapping to starter limits.</verify>
  <done>tier.ts exports checkTierLimit (returns allowed/current/limit/plan) and isAccountSuspended (returns suspended/gracePeriodEndsAt). Trial plan maps to starter limits. Suspended accounts always return allowed: false.</done>
</task>

<task type="auto">
  <name>Task 2: Add tier limit checks to createTruck and createDriver Server Actions</name>
  <files>src/app/actions/trucks.ts, src/app/actions/drivers.ts</files>
  <action>
**1. Update `src/app/actions/trucks.ts` -- add limit check to createTruck:**

After the `tenantId` check and before the `.insert()` call, add:

```typescript
import { checkTierLimit } from '@/lib/tier'

// After tenantId validation:
const tierCheck = await checkTierLimit(supabase, tenantId, 'trucks')
if (!tierCheck.allowed) {
  if (tierCheck.limit === 0) {
    return { error: 'Your account is suspended. Please update your payment method.' }
  }
  return { error: `Truck limit reached (${tierCheck.current}/${tierCheck.limit}). Upgrade your plan to add more trucks.` }
}
```

Do NOT change any other logic in the file. Only add the import and the check block.

**2. Update `src/app/actions/drivers.ts` -- add limit check to createDriver:**

Same pattern -- after `tenantId` validation and before the `.insert()` call:

```typescript
import { checkTierLimit } from '@/lib/tier'

// After tenantId validation:
const tierCheck = await checkTierLimit(supabase, tenantId, 'users')
if (!tierCheck.allowed) {
  if (tierCheck.limit === 0) {
    return { error: 'Your account is suspended. Please update your payment method.' }
  }
  return { error: `Team member limit reached (${tierCheck.current}/${tierCheck.limit}). Upgrade your plan to add more team members.` }
}
```

**Important:** Only add the check to the `create` actions (createTruck, createDriver). Do NOT modify update, delete, or status actions -- editing and deleting existing resources should always work regardless of tier.
  </action>
  <verify>Run `npx tsc --noEmit` to confirm no TypeScript errors. Verify the tier check is placed BEFORE the insert call. Verify that update/delete/status actions are NOT modified.</verify>
  <done>createTruck checks truck tier limit before insert, returning descriptive error with current/max counts. createDriver checks user tier limit before insert with same pattern. Suspended accounts get a distinct error message. Update/delete/status actions remain unchanged.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `checkTierLimit(supabase, tenantId, 'trucks')` returns `{ allowed: true, current: N, limit: 5, plan: 'starter' }` when under limit
- `checkTierLimit(supabase, tenantId, 'trucks')` returns `{ allowed: false, current: 5, limit: 5, plan: 'starter' }` when at limit
- `checkTierLimit` with 'trial' plan uses starter limits (5 trucks, 3 users)
- `checkTierLimit` with 'enterprise' plan returns `{ allowed: true, limit: -1 }` (unlimited)
- `isAccountSuspended` returns `{ suspended: true }` when grace period expired
- `createTruck` returns error message when truck limit reached
- `createDriver` returns error message when user limit reached
</verification>

<success_criteria>
- Tier enforcement works at Server Action level with descriptive error messages
- DB triggers from Plan 01 provide backup enforcement
- Trial plan uses starter limits
- Enterprise plan is unlimited
- Suspended accounts are blocked from creating resources
- Existing update/delete functionality unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/05-onboarding---stripe-polish/05-02-SUMMARY.md`
</output>
