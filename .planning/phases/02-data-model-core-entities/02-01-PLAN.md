---
phase: 02-data-model-core-entities
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema.ts
  - supabase/migrations/00002_core_entities.sql
  - src/components/providers/query-provider.tsx
  - src/app/(dashboard)/layout.tsx
  - src/stores/draft-store.ts
  - src/components/shared/entity-card.tsx
  - src/components/shared/filter-bar.tsx
  - src/components/shared/pagination.tsx
  - src/components/shared/empty-state.tsx
  - src/components/shared/status-badge.tsx
  - src/components/shared/confirm-dialog.tsx
  - src/lib/validations/order.ts
  - src/lib/validations/driver.ts
  - src/lib/validations/truck.ts
  - src/lib/validations/broker.ts
  - src/types/database.ts
  - src/types/index.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "All 4 entity tables exist in the database with RLS policies"
    - "Shared UI components render without errors"
    - "TanStack Query provider wraps the dashboard"
    - "Zod validation schemas exist for all entities"
    - "Draft auto-save store persists form state to localStorage"
  artifacts:
    - path: "supabase/migrations/00002_core_entities.sql"
      provides: "SQL for orders, drivers, trucks, brokers tables + RLS + triggers + grants"
      contains: "CREATE TABLE public.orders"
    - path: "src/db/schema.ts"
      provides: "Drizzle schema definitions for all 4 entity tables + enums"
      contains: "orderStatusEnum"
    - path: "src/components/providers/query-provider.tsx"
      provides: "QueryClientProvider wrapper for TanStack Query"
      contains: "QueryClientProvider"
    - path: "src/stores/draft-store.ts"
      provides: "Zustand persist store for form draft auto-save"
      contains: "useDraftStore"
    - path: "src/lib/validations/order.ts"
      provides: "Zod schemas for order vehicle, location, pricing steps"
      contains: "orderVehicleSchema"
  key_links:
    - from: "src/app/(dashboard)/layout.tsx"
      to: "src/components/providers/query-provider.tsx"
      via: "QueryProvider wrapping children"
      pattern: "QueryProvider"
    - from: "src/db/schema.ts"
      to: "supabase/migrations/00002_core_entities.sql"
      via: "Drizzle schema mirrors SQL tables"
      pattern: "orders.*pgTable"
---

<objective>
Create the database foundation and shared infrastructure for all Phase 2 entities. This includes the SQL migration with all 4 entity tables (orders, drivers, trucks, brokers), Drizzle ORM schema extensions, pgEnums for status types, RLS policies following the established (SELECT get_tenant_id()) pattern, shared UI components (cards, filters, pagination, empty states, status badges), TanStack Query provider, draft auto-save store, and Zod validation schemas for all entities.

Purpose: Every subsequent plan in Phase 2 depends on this foundation -- database tables, shared components, and validation schemas must exist before any entity CRUD can be built.
Output: SQL migration, extended Drizzle schema, shared components, validation schemas, QueryClientProvider, draft store.
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-data-model-core-entities/02-CONTEXT.md
@.planning/phases/02-data-model-core-entities/02-RESEARCH.md
@.planning/phases/01-project-setup-auth-multi-tenancy/01-02-SUMMARY.md
@src/db/schema.ts
@src/db/index.ts
@src/types/index.ts
@src/types/database.ts
@src/app/(dashboard)/layout.tsx
@supabase/migrations/00001_initial_schema.sql
@src/stores/sidebar-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SQL migration + Drizzle schema for all entity tables</name>
  <files>
    supabase/migrations/00002_core_entities.sql
    src/db/schema.ts
    src/types/database.ts
    src/types/index.ts
  </files>
  <action>
    1. Create `supabase/migrations/00002_core_entities.sql` with:

    **Enums:**
    - order_status: 'new', 'assigned', 'picked_up', 'delivered', 'invoiced', 'paid', 'cancelled'
    - payment_type: 'COD', 'COP', 'CHECK', 'BILL', 'SPLIT'
    - driver_type: 'company', 'owner_operator'
    - driver_status: 'active', 'inactive'
    - truck_type: '7_car', '8_car', '9_car', 'flatbed', 'enclosed'
    - truck_status: 'active', 'inactive', 'maintenance'
    - driver_pay_type: 'percentage_of_carrier_pay', 'dispatch_fee_percent', 'per_mile'
    - payment_terms: 'NET15', 'NET30', 'NET45', 'NET60'

    **Tables (all with tenant_id UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE):**

    `brokers`: id (UUID PK), tenant_id, name (TEXT NOT NULL), email, phone, address, city, state, zip, payment_terms (payment_terms enum), factoring_company, notes, created_at, updated_at

    `drivers`: id (UUID PK), tenant_id, first_name (TEXT NOT NULL), last_name (TEXT NOT NULL), email, phone, address, city, state, zip, license_number, driver_type (driver_type enum NOT NULL DEFAULT 'company'), driver_status (driver_status enum NOT NULL DEFAULT 'active'), pay_type (driver_pay_type enum NOT NULL DEFAULT 'percentage_of_carrier_pay'), pay_rate (NUMERIC(5,2) NOT NULL DEFAULT 0 -- percentage or per-mile rate), notes, created_at, updated_at

    `trucks`: id (UUID PK), tenant_id, unit_number (TEXT NOT NULL), truck_type (truck_type enum NOT NULL DEFAULT '7_car'), truck_status (truck_status enum NOT NULL DEFAULT 'active'), year (INTEGER), make (TEXT), model (TEXT), vin (TEXT), ownership (TEXT DEFAULT 'company' -- 'company' or 'owner_operator'), notes, created_at, updated_at

    `orders`: id (UUID PK), tenant_id, order_number (TEXT), broker_id (UUID REFERENCES brokers), driver_id (UUID REFERENCES drivers), vehicle_vin, vehicle_year (INTEGER), vehicle_make, vehicle_model, vehicle_type, vehicle_color, status (order_status NOT NULL DEFAULT 'new'), cancelled_reason, pickup_location, pickup_city, pickup_state, pickup_zip, pickup_contact_name, pickup_contact_phone, pickup_date (DATE), delivery_location, delivery_city, delivery_state, delivery_zip, delivery_contact_name, delivery_contact_phone, delivery_date (DATE), actual_pickup_date (TIMESTAMPTZ), actual_delivery_date (TIMESTAMPTZ), revenue (NUMERIC(12,2) DEFAULT '0'), carrier_pay (NUMERIC(12,2) DEFAULT '0'), broker_fee (NUMERIC(12,2) DEFAULT '0'), payment_type (payment_type DEFAULT 'COP'), notes, created_at, updated_at

    **RLS policies** for each table (same pattern as Phase 1):
    - ENABLE ROW LEVEL SECURITY
    - SELECT: `tenant_id = (SELECT public.get_tenant_id())`
    - INSERT: `WITH CHECK (tenant_id = (SELECT public.get_tenant_id()))`
    - UPDATE: both USING and WITH CHECK
    - DELETE: USING clause

    **Indexes:**
    - brokers: (tenant_id)
    - drivers: (tenant_id), (tenant_id, driver_status)
    - trucks: (tenant_id), (tenant_id, truck_status)
    - orders: (tenant_id), (tenant_id, status), (tenant_id, broker_id), (tenant_id, driver_id)

    **Triggers:**
    - set_updated_at on all 4 tables (reuse existing handle_updated_at function)
    - generate_order_number trigger on orders (BEFORE INSERT, generates 'ORD-' + zero-padded sequential number per tenant)

    **Realtime grants:**
    - GRANT SELECT ON public.orders TO supabase_realtime;
    - GRANT SELECT ON public.drivers TO supabase_realtime;
    - GRANT SELECT ON public.trucks TO supabase_realtime;
    - GRANT SELECT ON public.brokers TO supabase_realtime;

    2. Extend `src/db/schema.ts` to add Drizzle definitions for all 4 tables with pgEnum definitions. Follow the exact pattern from the existing tenants/tenantMemberships tables. Use pgEnum from drizzle-orm/pg-core. Add type exports (e.g., `export type Order = typeof orders.$inferSelect`).

    3. Update `src/types/database.ts` to add TypeScript interfaces matching all 4 entity tables (snake_case properties matching Supabase response format, for use with Supabase client queries).

    4. Update `src/types/index.ts` to add:
    - OrderStatus, PaymentType, DriverType, DriverStatus, TruckType, TruckStatus, DriverPayType, PaymentTerms type unions
    - ORDER_STATUSES, PAYMENT_TYPES, etc. const arrays for iteration
    - Status display label maps (e.g., ORDER_STATUS_LABELS: Record<OrderStatus, string>)
    - Status color maps for use with badges

    IMPORTANT: Use `(SELECT public.get_tenant_id())` wrapper in ALL RLS policies -- not bare function call. This is the established pattern from Phase 1 for performance.
  </action>
  <verify>
    - `npx tsc --noEmit` passes with no errors related to schema or type files
    - SQL file contains CREATE TABLE for orders, drivers, trucks, brokers
    - SQL file contains all 8 enum definitions
    - SQL file contains RLS policies with (SELECT public.get_tenant_id()) pattern for all 4 tables
    - SQL file contains generate_order_number trigger function
    - SQL file contains GRANT SELECT ... TO supabase_realtime for all 4 tables
    - Drizzle schema exports Order, Driver, Truck, Broker types
  </verify>
  <done>
    All 4 entity tables defined in SQL migration with RLS + triggers + indexes + realtime grants. Drizzle schema mirrors SQL. TypeScript types exported for both Drizzle and Supabase client usage. Status enums and display maps available.
  </done>
</task>

<task type="auto">
  <name>Task 2: Install dependencies and add shadcn/ui components</name>
  <files>
    package.json
  </files>
  <action>
    1. Install new dependencies:
    ```
    npm install react-hook-form @hookform/resolvers
    ```

    2. Add shadcn/ui components (run each individually to avoid issues):
    ```
    npx shadcn@latest add sheet badge select form tabs dialog skeleton textarea tooltip popover calendar switch scroll-area alert-dialog
    ```

    3. Verify all components installed by checking `src/components/ui/` directory contains: sheet.tsx, badge.tsx, select.tsx, form.tsx, tabs.tsx, dialog.tsx, skeleton.tsx, textarea.tsx, tooltip.tsx, popover.tsx, calendar.tsx, switch.tsx, scroll-area.tsx, alert-dialog.tsx

    IMPORTANT: If any shadcn command fails, try running them one at a time. Use `--yes` or `--overwrite` flag if prompted about existing files.
  </action>
  <verify>
    - `npm ls react-hook-form` shows installed version ^7.56
    - `npm ls @hookform/resolvers` shows installed version ^5.2
    - All 14 shadcn/ui component files exist in `src/components/ui/`
    - `npx tsc --noEmit` passes
  </verify>
  <done>
    react-hook-form and @hookform/resolvers installed. All 14 shadcn/ui components available for use in entity forms and list views.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create shared infrastructure (QueryProvider, draft store, shared components, Zod schemas)</name>
  <files>
    src/components/providers/query-provider.tsx
    src/app/(dashboard)/layout.tsx
    src/stores/draft-store.ts
    src/components/shared/status-badge.tsx
    src/components/shared/entity-card.tsx
    src/components/shared/filter-bar.tsx
    src/components/shared/pagination.tsx
    src/components/shared/empty-state.tsx
    src/components/shared/confirm-dialog.tsx
    src/lib/validations/order.ts
    src/lib/validations/driver.ts
    src/lib/validations/truck.ts
    src/lib/validations/broker.ts
  </files>
  <action>
    1. Create `src/components/providers/query-provider.tsx` -- QueryClientProvider wrapper using `useState(() => new QueryClient({...}))` pattern. Set staleTime: 30_000, refetchOnWindowFocus: false as defaults. Mark 'use client'.

    2. Wrap children in `src/app/(dashboard)/layout.tsx` with QueryProvider. Import from `@/components/providers/query-provider`. The QueryProvider should wrap the existing layout content (around {children} specifically, keeping the existing Server Component logic intact).

    3. Create `src/stores/draft-store.ts` -- Zustand store with persist middleware. Interface: saveDraft(key, data), loadDraft(key), clearDraft(key), hasDraft(key). Storage name: 'vroomx-drafts'. Each draft entry includes _savedAt timestamp. Follow the exact pattern from 02-RESEARCH.md Pattern 4.

    4. Create shared UI components:

    `src/components/shared/status-badge.tsx`: Color-coded badge component. Props: { status: string, type: 'order' | 'driver' | 'truck' }. Uses the Badge component from shadcn/ui. Color maps:
    - Order: new=blue, assigned=amber, picked_up=purple, delivered=green, invoiced=indigo, paid=emerald, cancelled=red
    - Driver: active=green, inactive=gray
    - Truck: active=green, inactive=gray, maintenance=amber
    Labels: snake_case to Title Case (picked_up -> "Picked Up")

    `src/components/shared/entity-card.tsx`: Base card layout component. Props: { children, onClick?, className? }. Renders a card div with hover state, cursor-pointer when onClick provided, rounded-lg border shadow-sm bg-white. This is a composable primitive, not entity-specific.

    `src/components/shared/filter-bar.tsx`: Reusable horizontal filter bar. Props: { filters: FilterConfig[], onFilterChange: (key, value) => void, activeFilters: Record<string, string> }. FilterConfig: { key, label, type: 'select' | 'date-range' | 'search', options?: {value, label}[] }. Renders a flex row with Select dropdowns, search Input, and "Clear filters" button. Uses URL search params pattern from research.

    `src/components/shared/pagination.tsx`: Pagination controls. Props: { page: number, pageSize: number, total: number, onPageChange: (page) => void }. Shows "Showing X-Y of Z" text, Previous/Next buttons, page number display. Disable Previous on page 0, Next on last page.

    `src/components/shared/empty-state.tsx`: Empty state placeholder. Props: { icon: LucideIcon, title: string, description: string, action?: { label: string, onClick: () => void } }. Centered layout with icon, text, and optional CTA button.

    `src/components/shared/confirm-dialog.tsx`: Wrapper around AlertDialog. Props: { open, onOpenChange, title, description, confirmLabel?, destructive?: boolean, onConfirm: () => void | Promise<void> }. Shows Cancel and Confirm buttons. If destructive, Confirm button uses variant="destructive".

    5. Create Zod validation schemas:

    `src/lib/validations/broker.ts`: brokerSchema with name (min 1), email (optional email), phone (optional), address/city/state/zip (optional), paymentTerms (optional enum), factoringCompany (optional), notes (optional).

    `src/lib/validations/driver.ts`: driverSchema with firstName (min 1), lastName (min 1), email (optional email), phone (optional), address/city/state/zip (optional), licenseNumber (optional), driverType (enum), driverStatus (enum), payType (enum), payRate (number min 0 max 100), notes (optional).

    `src/lib/validations/truck.ts`: truckSchema with unitNumber (min 1), truckType (enum), truckStatus (enum), year (optional number 1900-2030), make (optional), model (optional), vin (optional, 17 chars when provided), ownership (optional enum 'company' | 'owner_operator'), notes (optional).

    `src/lib/validations/order.ts`: Split into 3 step schemas + combined:
    - orderVehicleSchema: vehicleVin (optional 17 chars), vehicleYear (coerce number), vehicleMake (min 1), vehicleModel (min 1), vehicleType (optional), vehicleColor (optional)
    - orderLocationSchema: pickup/delivery location, city, state, zip, contactName, contactPhone, dates
    - orderPricingSchema: revenue (coerce number min 0), carrierPay (coerce number min 0), brokerFee (coerce number min 0 default 0), paymentType (enum), brokerId (optional uuid), driverId (optional uuid)
    - createOrderSchema = merge of all 3

    Follow the exact pattern from 02-RESEARCH.md Pattern 1. Use z from 'zod' (Zod v4).
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - QueryProvider file exists and exports QueryProvider component
    - Dashboard layout imports and uses QueryProvider
    - Draft store exports useDraftStore with saveDraft/loadDraft/clearDraft/hasDraft
    - All 6 shared components exist in src/components/shared/
    - All 4 validation schema files exist in src/lib/validations/
    - `npm run build` succeeds (or at minimum `npx tsc --noEmit`)
  </verify>
  <done>
    QueryClientProvider wraps dashboard. Draft auto-save store ready. 6 shared UI components ready for entity pages. 4 Zod validation schemas ready for forms and server actions. All infrastructure needed by subsequent plans is in place.
  </done>
</task>

</tasks>

<verification>
- TypeScript compilation passes: `npx tsc --noEmit`
- SQL migration file is valid and complete
- All shared components render without errors
- Dashboard layout wraps content with QueryProvider
- Zod schemas validate correctly (can be verified by importing in a test)
</verification>

<success_criteria>
- 4 entity table definitions in SQL migration with RLS + triggers + indexes
- Drizzle schema extended with all entity tables and pgEnums
- TypeScript types for all entities available via imports
- react-hook-form and @hookform/resolvers installed
- 14 shadcn/ui components available
- QueryClientProvider wrapping dashboard routes
- Draft auto-save Zustand store functional
- 6 shared UI components ready for composition
- 4 Zod validation schemas ready for forms
- `npx tsc --noEmit` passes clean
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-model-core-entities/02-01-SUMMARY.md`
</output>
