---
phase: 02-data-model-core-entities
plan: 06
type: execute
wave: 4
depends_on: ["02-02", "02-03", "02-04", "02-05"]
files_modified:
  - src/app/(dashboard)/orders/[id]/page.tsx
  - src/app/(dashboard)/orders/_components/order-detail.tsx
  - src/app/(dashboard)/orders/_components/order-timeline.tsx
  - src/app/(dashboard)/orders/_components/order-status-actions.tsx
  - src/app/actions/orders.ts
  - src/hooks/use-orders.ts
  - src/hooks/use-drivers.ts
  - src/hooks/use-trucks.ts
  - src/hooks/use-brokers.ts
autonomous: true

must_haves:
  truths:
    - "Dispatcher can view order detail page with all information"
    - "Dispatcher can change order status following the workflow"
    - "Status rollback works (go back one step for corrections)"
    - "Cancellation requires a reason"
    - "Cross-entity links navigate to broker/driver detail pages"
    - "Real-time updates reflect changes across browser tabs"
  artifacts:
    - path: "src/app/(dashboard)/orders/[id]/page.tsx"
      provides: "Order detail page"
      contains: "OrderDetail"
    - path: "src/app/(dashboard)/orders/_components/order-timeline.tsx"
      provides: "Visual status timeline showing order progression"
      contains: "timeline"
    - path: "src/app/(dashboard)/orders/_components/order-status-actions.tsx"
      provides: "Status transition buttons with workflow enforcement"
      contains: "updateOrderStatus"
  key_links:
    - from: "src/app/(dashboard)/orders/_components/order-detail.tsx"
      to: "/brokers/[id]"
      via: "Link component for cross-entity navigation"
      pattern: "href.*brokers"
    - from: "src/app/(dashboard)/orders/_components/order-detail.tsx"
      to: "/drivers/[id]"
      via: "Link component for cross-entity navigation"
      pattern: "href.*drivers"
    - from: "src/hooks/use-orders.ts"
      to: "supabase.channel"
      via: "Supabase Realtime subscription invalidates TanStack Query cache"
      pattern: "postgres_changes.*orders"
    - from: "src/app/(dashboard)/orders/_components/order-status-actions.tsx"
      to: "src/app/actions/orders.ts"
      via: "updateOrderStatus server action"
      pattern: "updateOrderStatus"
---

<objective>
Build the order detail view with status workflow, cross-entity navigation, and Supabase Realtime subscriptions for all entity list views. This plan completes the order experience and adds live update capability across all Phase 2 entities.

Purpose: The order detail view is where dispatchers spend most of their time -- viewing order info, changing status, and navigating to related entities. Realtime updates ensure two dispatchers see the same data without manual refresh.
Output: Order detail page with status workflow + timeline, cross-entity links, and Realtime subscriptions on all 4 entity hooks.
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-data-model-core-entities/02-CONTEXT.md
@.planning/phases/02-data-model-core-entities/02-RESEARCH.md
@.planning/phases/02-data-model-core-entities/02-01-SUMMARY.md
@.planning/phases/02-data-model-core-entities/02-05-SUMMARY.md
@src/hooks/use-orders.ts
@src/hooks/use-drivers.ts
@src/hooks/use-trucks.ts
@src/hooks/use-brokers.ts
@src/app/actions/orders.ts
@src/app/(dashboard)/orders/_components/order-card.tsx
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create order detail page with status workflow and cross-entity navigation</name>
  <files>
    src/app/(dashboard)/orders/[id]/page.tsx
    src/app/(dashboard)/orders/_components/order-detail.tsx
    src/app/(dashboard)/orders/_components/order-timeline.tsx
    src/app/(dashboard)/orders/_components/order-status-actions.tsx
    src/app/actions/orders.ts
  </files>
  <action>
    1. Add `updateOrderStatus` to `src/app/actions/orders.ts`:
    - `updateOrderStatus(id: string, newStatus: string, reason?: string)`:
      - Validate newStatus is a valid order_status enum value
      - If newStatus is 'cancelled', require reason parameter (return error if missing)
      - If newStatus is 'picked_up', set actual_pickup_date to now()
      - If newStatus is 'delivered', set actual_delivery_date to now()
      - Update order status + relevant timestamp fields
      - revalidatePath(`/orders/${id}`) and revalidatePath('/orders')
    - `rollbackOrderStatus(id: string)`:
      - Fetch current order status
      - Determine previous status: new<-assigned<-picked_up<-delivered<-invoiced<-paid
      - If current status is 'new', return error (can't rollback further)
      - If current status is 'cancelled', return error (cancelled orders can't rollback)
      - Update to previous status, clear relevant date fields if rolling back from picked_up/delivered
      - revalidatePath

    2. Create `src/app/(dashboard)/orders/_components/order-status-actions.tsx` ('use client'):
    - Props: { orderId: string, currentStatus: OrderStatus }
    - Defines allowed transitions: new->assigned, assigned->picked_up, picked_up->delivered, delivered->invoiced, invoiced->paid
    - Cancelled is allowed from: new, assigned, picked_up (before delivered)
    - Renders: "Advance to [Next Status]" primary button, "Roll Back" outline button, "Cancel Order" destructive button
    - Cancel Order opens AlertDialog with required reason Textarea
    - Rollback opens ConfirmDialog: "Roll back to [previous status]?"
    - Disables buttons during mutation (loading state)

    3. Create `src/app/(dashboard)/orders/_components/order-timeline.tsx` ('use client'):
    - Props: { currentStatus: OrderStatus, createdAt: string, actualPickupDate?: string, actualDeliveryDate?: string }
    - Visual horizontal timeline showing all 6 statuses as dots/circles
    - Completed statuses: filled circle with checkmark, colored
    - Current status: filled circle, pulsing/highlighted
    - Future statuses: empty circle, gray
    - Shows dates below completed statuses where available
    - Cancelled status shown as a red X overlay if applicable

    4. Create `src/app/(dashboard)/orders/_components/order-detail.tsx` ('use client'):
    - Props: { order: Order (with broker/driver joins) }
    - Layout sections:
      - **Header**: Order number + status badge + status actions
      - **Timeline**: OrderTimeline component
      - **Vehicle Info**: VIN, year/make/model, type, color (card layout)
      - **Route**: Pickup location (full address, contact, date) -> Delivery location (full address, contact, date). Visual arrow/line between them.
      - **Financial**: Revenue, carrier pay, broker fee, margin (revenue - carrierPay - brokerFee), payment type badge
      - **Assignments**: Broker name (Link to /brokers/[id]), Driver name (Link to /drivers/[id]). Use next/link for cross-entity navigation. Show "Unassigned" if no broker/driver.
      - **Notes**: Display notes if present
      - **Metadata**: Created at, updated at timestamps
    - Edit button opens OrderDrawer in edit mode (import from existing order-drawer.tsx)
    - Delete with ConfirmDialog (only allowed for 'new' status)

    5. Create `src/app/(dashboard)/orders/[id]/page.tsx` ('use client'):
    - Extract id from params (Next.js 16: `const { id } = await params` if server, or use useParams if client)
    - Uses useOrder(id) hook
    - Loading state with Skeleton
    - Not found state if order is null
    - Renders OrderDetail component
    - Back link to /orders

    IMPORTANT for cross-entity links: Use Next.js Link component (`import Link from 'next/link'`). Broker link: `<Link href={'/brokers/' + order.broker?.id}>{order.broker?.name}</Link>`. Driver link: `<Link href={'/drivers/' + order.driver?.id}>{order.driver?.first_name + ' ' + order.driver?.last_name}</Link>`. Only render as link if the related entity exists.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Order detail page renders at /orders/[id]
    - OrderStatusActions has advance, rollback, and cancel buttons
    - OrderTimeline shows status progression visually
    - Cross-entity links use next/link href to /brokers/[id] and /drivers/[id]
    - Cancel requires reason
    - Delete only available for 'new' status orders
  </verify>
  <done>
    Order detail page complete with: visual status timeline, status workflow enforcement (advance/rollback/cancel), cross-entity navigation links to brokers and drivers, financial summary, and all order information displayed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Supabase Realtime subscriptions to all entity hooks</name>
  <files>
    src/hooks/use-orders.ts
    src/hooks/use-drivers.ts
    src/hooks/use-trucks.ts
    src/hooks/use-brokers.ts
  </files>
  <action>
    Add Supabase Realtime subscriptions to each entity's TanStack Query hook to invalidate the cache when data changes. This enables live updates: if dispatcher A creates an order, dispatcher B sees it appear without refreshing.

    For each hook file (use-orders.ts, use-drivers.ts, use-trucks.ts, use-brokers.ts), add a Realtime subscription in the list hook:

    Pattern (apply to each hook's list function, e.g., useOrders, useDrivers, useTrucks, useBrokers):
    ```
    // Inside the list hook (e.g., useOrders)
    const queryClient = useQueryClient()
    const supabase = createBrowserClient()

    useEffect(() => {
      const channel = supabase
        .channel('{entity}-changes')  // e.g., 'orders-changes'
        .on('postgres_changes', {
          event: '*',  // INSERT, UPDATE, DELETE
          schema: 'public',
          table: '{entity}',  // e.g., 'orders'
        }, () => {
          queryClient.invalidateQueries({ queryKey: ['{entity}'] })
        })
        .subscribe()

      return () => { supabase.removeChannel(channel) }
    }, [supabase, queryClient])
    ```

    IMPORTANT NOTES:
    - Import useQueryClient from '@tanstack/react-query' and useEffect from 'react'
    - Use a SINGLE channel per entity type (not per component instance)
    - Invalidate with partial key: `{ queryKey: ['orders'] }` invalidates both list and detail queries
    - For DELETE events, invalidation is the safe approach (re-fetches with RLS applied) -- do NOT try to filter DELETE events by tenant_id on the channel level, as that would require passing tenant_id to the client
    - Channel name must be unique per entity (e.g., 'orders-changes', 'drivers-changes')
    - The dependency array should include supabase and queryClient references
    - This relies on GRANT SELECT TO supabase_realtime being applied in the SQL migration (Plan 01)
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Each hook file contains a useEffect with supabase.channel subscription
    - Each hook invalidates queries on postgres_changes events
    - Each hook cleans up the channel in the useEffect return function
    - Channel names are unique: 'orders-changes', 'drivers-changes', 'trucks-changes', 'brokers-changes'
  </verify>
  <done>
    All 4 entity hooks have Supabase Realtime subscriptions. Changes made by any user in the same tenant are reflected in real-time across all browser tabs. Cache invalidation on postgres_changes ensures data freshness.
  </done>
</task>

</tasks>

<verification>
- Order detail page renders with all sections
- Status workflow: can advance, rollback, and cancel orders
- Timeline visualization shows progression
- Cross-entity links navigate correctly
- Realtime: creating a record in one tab causes list refresh in another
- TypeScript compilation clean
</verification>

<success_criteria>
- Dispatcher can view order detail at /orders/[id] with all info
- Order detail shows: vehicle info, route, financial summary, assignments, timeline
- Status can be advanced following the workflow (new -> assigned -> ... -> paid)
- Status can be rolled back one step
- Cancellation requires a reason and is only available before delivered
- Broker name links to /brokers/[id], driver name links to /drivers/[id]
- Real-time: change in one tab reflects in another tab within seconds
- All 4 entity list views update in real-time
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-model-core-entities/02-06-SUMMARY.md`
</output>
