---
phase: 02-data-model-core-entities
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/app/(dashboard)/brokers/page.tsx
  - src/app/(dashboard)/brokers/[id]/page.tsx
  - src/app/(dashboard)/brokers/_components/broker-card.tsx
  - src/app/(dashboard)/brokers/_components/broker-list.tsx
  - src/app/(dashboard)/brokers/_components/broker-form.tsx
  - src/app/(dashboard)/brokers/_components/broker-drawer.tsx
  - src/app/actions/brokers.ts
  - src/hooks/use-brokers.ts
  - src/lib/queries/brokers.ts
autonomous: true

must_haves:
  truths:
    - "Dispatcher can see a list of brokers as cards in a grid"
    - "Dispatcher can create a new broker via slide-out drawer"
    - "Dispatcher can edit an existing broker"
    - "Dispatcher can view broker detail page with all info"
    - "Broker data is tenant-isolated"
  artifacts:
    - path: "src/app/(dashboard)/brokers/page.tsx"
      provides: "Brokers list page"
      contains: "BrokerList"
    - path: "src/app/(dashboard)/brokers/_components/broker-form.tsx"
      provides: "Broker form with react-hook-form + Zod validation"
      contains: "useForm"
    - path: "src/app/actions/brokers.ts"
      provides: "Server Actions: createBroker, updateBroker, deleteBroker"
      contains: "use server"
    - path: "src/hooks/use-brokers.ts"
      provides: "TanStack Query hook for fetching brokers"
      contains: "useQuery"
  key_links:
    - from: "src/app/(dashboard)/brokers/_components/broker-form.tsx"
      to: "src/app/actions/brokers.ts"
      via: "Server Action call on form submit"
      pattern: "createBroker|updateBroker"
    - from: "src/hooks/use-brokers.ts"
      to: "supabase.from('brokers')"
      via: "Supabase browser client query"
      pattern: "from\\('brokers'\\)"
    - from: "src/app/(dashboard)/brokers/_components/broker-list.tsx"
      to: "src/hooks/use-brokers.ts"
      via: "useBrokers hook for data fetching"
      pattern: "useBrokers"
---

<objective>
Build complete Brokers CRUD -- the simplest entity, establishing the full vertical slice pattern (list page with card grid, slide-out drawer form, detail page, server actions, TanStack Query hook) that Drivers and Trucks plans will follow.

Purpose: Brokers are referenced by orders (broker_id FK) and are the simplest entity to implement, making them ideal for establishing the CRUD pattern. This plan creates the template that Plans 03 and 04 will replicate.
Output: Fully functional broker management with list, create, edit, detail, and delete capabilities.
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-data-model-core-entities/02-CONTEXT.md
@.planning/phases/02-data-model-core-entities/02-RESEARCH.md
@.planning/phases/02-data-model-core-entities/02-01-SUMMARY.md
@src/db/schema.ts
@src/lib/validations/broker.ts
@src/components/shared/entity-card.tsx
@src/components/shared/filter-bar.tsx
@src/components/shared/pagination.tsx
@src/components/shared/empty-state.tsx
@src/components/shared/confirm-dialog.tsx
@src/stores/draft-store.ts
@src/app/(dashboard)/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create broker server actions and TanStack Query hook</name>
  <files>
    src/app/actions/brokers.ts
    src/hooks/use-brokers.ts
    src/lib/queries/brokers.ts
  </files>
  <action>
    1. Create `src/lib/queries/brokers.ts` -- Supabase query builder functions:
    - `fetchBrokers(supabase, filters)`: SELECT with optional search (name ilike), pagination (.range()), count: 'exact', order by name ASC. Filters: { search?: string, page?: number, pageSize?: number }.
    - `fetchBroker(supabase, id)`: SELECT single by id.

    2. Create `src/hooks/use-brokers.ts` -- TanStack Query hooks:
    - `useBrokers(filters)`: useQuery with queryKey ['brokers', filters], calls fetchBrokers. staleTime 30_000.
    - `useBroker(id)`: useQuery with queryKey ['broker', id], calls fetchBroker. enabled: !!id.
    Import createBrowserClient from '@/lib/supabase/client'.

    3. Create `src/app/actions/brokers.ts` -- Server Actions:
    - 'use server' directive at top
    - `createBroker(data: unknown)`: Parse with brokerSchema.safeParse(), create Supabase server client, insert into brokers table with tenant_id from JWT (use supabase.auth.getUser() to get user, then get tenant_id from app_metadata). Actually, since RLS is enforced, we need to pass tenant_id in the insert. Get it from the auth user's app_metadata. Map camelCase to snake_case. Return { data: broker } or { error: string }.
    - `updateBroker(id: string, data: unknown)`: Parse, update where id matches, revalidatePath('/brokers').
    - `deleteBroker(id: string)`: Delete where id matches, revalidatePath('/brokers').

    IMPORTANT: For inserts, tenant_id must be included in the data because the RLS INSERT policy uses WITH CHECK. Get tenant_id from `(await supabase.auth.getUser()).data.user?.app_metadata?.tenant_id`. revalidatePath('/brokers') after each mutation.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Server actions file has 'use server' directive
    - All 3 server actions exported
    - Query hook uses correct queryKey pattern with filters
  </verify>
  <done>
    Broker data layer complete: 3 server actions (create, update, delete) with Zod validation, 2 TanStack Query hooks (list, detail), Supabase query builders.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create broker UI components (list, card, drawer, form, detail page)</name>
  <files>
    src/app/(dashboard)/brokers/page.tsx
    src/app/(dashboard)/brokers/[id]/page.tsx
    src/app/(dashboard)/brokers/_components/broker-card.tsx
    src/app/(dashboard)/brokers/_components/broker-list.tsx
    src/app/(dashboard)/brokers/_components/broker-form.tsx
    src/app/(dashboard)/brokers/_components/broker-drawer.tsx
  </files>
  <action>
    1. Create `src/app/(dashboard)/brokers/_components/broker-card.tsx` ('use client'):
    - Props: { broker: Broker (database type), onClick: () => void }
    - Uses the shared EntityCard component
    - Displays: name (bold), email, phone, payment terms badge, factoring company if exists
    - Quick actions: Edit button (pencil icon from lucide-react)
    - Clicking the card calls onClick (navigates to detail)

    2. Create `src/app/(dashboard)/brokers/_components/broker-form.tsx` ('use client'):
    - Props: { broker?: Broker (for edit mode), onSuccess: () => void, onCancel: () => void }
    - Uses react-hook-form with zodResolver and brokerSchema from '@/lib/validations/broker'
    - Fields: name (Input, required), email (Input), phone (Input), address (Input), city (Input), state (Input), zip (Input), paymentTerms (Select with NET15/NET30/NET45/NET60 options), factoringCompany (Input), notes (Textarea)
    - Draft auto-save: On form.watch changes, call useDraftStore.saveDraft('broker-new', values) for create mode. Load draft on mount via loadDraft. Clear draft on successful submit.
    - Submit handler: Calls createBroker or updateBroker server action, shows errors if returned, calls onSuccess on success.
    - Key prop pattern: Use `key={broker?.id ?? 'create'}` on the form to prevent state leaks between create/edit.

    3. Create `src/app/(dashboard)/brokers/_components/broker-drawer.tsx` ('use client'):
    - Props: { open: boolean, onOpenChange: (open: boolean) => void, broker?: Broker }
    - Uses shadcn/ui Sheet component (side="right", className="w-full sm:max-w-lg")
    - SheetHeader with title "New Broker" or "Edit Broker"
    - Renders BrokerForm inside SheetContent
    - Unsaved changes warning: If form isDirty and user tries to close, show ConfirmDialog asking to discard changes.
    - On success, closes drawer and clears draft.

    4. Create `src/app/(dashboard)/brokers/_components/broker-list.tsx` ('use client'):
    - Uses useBrokers hook with URL search params for filters
    - Filter bar with search input (name filter)
    - Grid layout: `grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4`
    - Renders BrokerCard for each broker
    - EmptyState when no brokers (Building2 icon, "No brokers yet", "Add your first broker to start tracking")
    - Pagination at bottom
    - "Add Broker" button in top-right that opens BrokerDrawer
    - Loading state with Skeleton components (3 skeleton cards in grid)
    - On card click, navigates to /brokers/[id] using next/navigation useRouter

    5. Create `src/app/(dashboard)/brokers/page.tsx`:
    - Simple page component that renders BrokerList
    - Title: "Brokers" with brief description

    6. Create `src/app/(dashboard)/brokers/[id]/page.tsx`:
    - Server Component that receives params.id
    - Uses useBroker hook for data (or make it a client component)
    - Actually, make this a client component ('use client') that uses useBroker(id) hook
    - Displays all broker fields in a clean layout
    - Sections: Contact Info, Payment Terms, Notes
    - Edit button opens BrokerDrawer in edit mode
    - Delete button with ConfirmDialog (destructive)
    - Back link to /brokers
    - Shows "Orders from this broker" section (placeholder text for now -- will be wired in Plan 05 when orders exist)
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - All 6 component files exist
    - BrokerList uses useBrokers hook
    - BrokerForm uses react-hook-form with zodResolver
    - BrokerDrawer uses Sheet component
    - BrokerCard renders broker data
    - Broker detail page renders broker info
    - `npm run build` succeeds (or `npx tsc --noEmit`)
  </verify>
  <done>
    Complete Brokers CRUD vertical slice: card-grid list with search, slide-out drawer with form + draft save + unsaved changes warning, detail page with edit/delete, server actions for all mutations. Pattern established for Drivers and Trucks plans.
  </done>
</task>

</tasks>

<verification>
- Brokers list page renders at /brokers
- Broker detail page renders at /brokers/[id]
- Create/Edit drawer opens with form
- Zod validation works on form submit
- TypeScript compilation clean
</verification>

<success_criteria>
- Dispatcher can view broker list as card grid at /brokers
- Dispatcher can create broker via drawer with validation
- Dispatcher can edit broker via drawer
- Dispatcher can view broker detail at /brokers/[id]
- Dispatcher can delete broker with confirmation
- Draft auto-save works (close drawer, reopen, draft is there)
- Empty state shows when no brokers exist
- Search filters broker list by name
- Pagination works when > 20 brokers
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-model-core-entities/02-02-SUMMARY.md`
</output>
