---
phase: 02-data-model-core-entities
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/app/(dashboard)/drivers/page.tsx
  - src/app/(dashboard)/drivers/[id]/page.tsx
  - src/app/(dashboard)/drivers/_components/driver-card.tsx
  - src/app/(dashboard)/drivers/_components/driver-list.tsx
  - src/app/(dashboard)/drivers/_components/driver-form.tsx
  - src/app/(dashboard)/drivers/_components/driver-drawer.tsx
  - src/app/actions/drivers.ts
  - src/hooks/use-drivers.ts
  - src/lib/queries/drivers.ts
autonomous: true

must_haves:
  truths:
    - "Dispatcher can see a list of drivers as cards in a grid"
    - "Dispatcher can create a new driver with pay configuration"
    - "Dispatcher can edit a driver's profile and pay rate"
    - "Dispatcher can view driver detail page with pay info and status"
    - "Driver pay type and rate are configurable per driver"
    - "Driver data is tenant-isolated"
  artifacts:
    - path: "src/app/(dashboard)/drivers/page.tsx"
      provides: "Drivers list page"
      contains: "DriverList"
    - path: "src/app/(dashboard)/drivers/_components/driver-form.tsx"
      provides: "Driver form with pay configuration"
      contains: "payType"
    - path: "src/app/actions/drivers.ts"
      provides: "Server Actions: createDriver, updateDriver, deleteDriver"
      contains: "use server"
    - path: "src/hooks/use-drivers.ts"
      provides: "TanStack Query hook for fetching drivers"
      contains: "useQuery"
  key_links:
    - from: "src/app/(dashboard)/drivers/_components/driver-form.tsx"
      to: "src/app/actions/drivers.ts"
      via: "Server Action call on form submit"
      pattern: "createDriver|updateDriver"
    - from: "src/hooks/use-drivers.ts"
      to: "supabase.from('drivers')"
      via: "Supabase browser client query"
      pattern: "from\\('drivers'\\)"
---

<objective>
Build complete Drivers CRUD with pay configuration -- the second vertical slice following the pattern established by Brokers (Plan 02). Drivers have additional complexity: driver type (company/owner-operator), status management, and three pay types (percentage of carrier pay, dispatch fee %, per mile).

Purpose: Drivers are a core entity referenced by orders (driver_id FK). The pay configuration drives financial calculations in later phases. This plan ensures driver management is fully functional.
Output: Fully functional driver management with list, create, edit, detail, pay configuration, and status management.
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-data-model-core-entities/02-CONTEXT.md
@.planning/phases/02-data-model-core-entities/02-RESEARCH.md
@.planning/phases/02-data-model-core-entities/02-01-SUMMARY.md
@src/db/schema.ts
@src/lib/validations/driver.ts
@src/components/shared/entity-card.tsx
@src/components/shared/status-badge.tsx
@src/components/shared/filter-bar.tsx
@src/components/shared/pagination.tsx
@src/components/shared/empty-state.tsx
@src/components/shared/confirm-dialog.tsx
@src/stores/draft-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create driver server actions, query builders, and TanStack Query hooks</name>
  <files>
    src/app/actions/drivers.ts
    src/hooks/use-drivers.ts
    src/lib/queries/drivers.ts
  </files>
  <action>
    1. Create `src/lib/queries/drivers.ts` -- Supabase query builder functions:
    - `fetchDrivers(supabase, filters)`: SELECT with optional filters: status (eq), search (first_name/last_name ilike), driverType (eq). Pagination with .range(). count: 'exact'. Order by last_name ASC, first_name ASC.
    - `fetchDriver(supabase, id)`: SELECT single by id.
    - Filters interface: { status?: string, driverType?: string, search?: string, page?: number, pageSize?: number }

    2. Create `src/hooks/use-drivers.ts` -- TanStack Query hooks ('use client'):
    - `useDrivers(filters)`: useQuery with queryKey ['drivers', filters], calls fetchDrivers.
    - `useDriver(id)`: useQuery with queryKey ['driver', id], calls fetchDriver. enabled: !!id.
    - Import createBrowserClient from '@/lib/supabase/client'.

    3. Create `src/app/actions/drivers.ts` -- Server Actions:
    - 'use server' directive
    - `createDriver(data: unknown)`: Parse with driverSchema.safeParse(), get tenant_id from auth user app_metadata, insert with snake_case mapping (first_name, last_name, driver_type, driver_status, pay_type, pay_rate). revalidatePath('/drivers'). Return { data } or { error }.
    - `updateDriver(id: string, data: unknown)`: Parse, update where id matches. revalidatePath('/drivers').
    - `deleteDriver(id: string)`: Delete where id matches. revalidatePath('/drivers').
    - `updateDriverStatus(id: string, status: 'active' | 'inactive')`: Quick status toggle. Update only driver_status field. revalidatePath('/drivers').

    IMPORTANT: Map payRate to pay_rate, payType to pay_type, driverType to driver_type, driverStatus to driver_status in the insert/update objects.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Server actions file has 'use server' directive
    - 4 server actions exported (create, update, delete, updateStatus)
    - Query hooks use correct queryKey pattern
  </verify>
  <done>
    Driver data layer complete: 4 server actions (create, update, delete, updateStatus) with Zod validation, 2 TanStack Query hooks (list with filters, detail), Supabase query builders with status/type/search filtering.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create driver UI components (list, card, drawer, form, detail page)</name>
  <files>
    src/app/(dashboard)/drivers/page.tsx
    src/app/(dashboard)/drivers/[id]/page.tsx
    src/app/(dashboard)/drivers/_components/driver-card.tsx
    src/app/(dashboard)/drivers/_components/driver-list.tsx
    src/app/(dashboard)/drivers/_components/driver-form.tsx
    src/app/(dashboard)/drivers/_components/driver-drawer.tsx
  </files>
  <action>
    1. Create `src/app/(dashboard)/drivers/_components/driver-card.tsx` ('use client'):
    - Props: { driver: Driver (database type), onClick: () => void }
    - Uses shared EntityCard
    - Displays: full name (first + last, bold), driver type badge (Company / Owner-Operator), status badge (using shared StatusBadge with type='driver'), phone, email
    - Pay info line: "Pay: 25% of carrier pay" or "Dispatch fee: 10%" or "Per mile: $0.50/mi"
    - Quick actions: status toggle (Switch component), edit button

    2. Create `src/app/(dashboard)/drivers/_components/driver-form.tsx` ('use client'):
    - Props: { driver?: Driver, onSuccess: () => void, onCancel: () => void }
    - Uses react-hook-form with zodResolver and driverSchema
    - Fields organized in sections:
      - **Personal Info**: firstName (required), lastName (required), email, phone
      - **Address**: address, city, state, zip
      - **Driver Details**: licenseNumber, driverType (Select: Company / Owner-Operator), driverStatus (Select: Active / Inactive)
      - **Pay Configuration**: payType (Select: Percentage of Carrier Pay / Dispatch Fee % / Per Mile), payRate (Input number, label changes based on payType: "Cut %" / "Fee %" / "Rate per mile $")
    - Draft auto-save for create mode (key: 'driver-new')
    - Submit calls createDriver or updateDriver

    3. Create `src/app/(dashboard)/drivers/_components/driver-drawer.tsx` ('use client'):
    - Same pattern as BrokerDrawer: Sheet side="right", title based on create/edit mode
    - Unsaved changes warning on close when form isDirty
    - Closes and clears draft on success

    4. Create `src/app/(dashboard)/drivers/_components/driver-list.tsx` ('use client'):
    - Uses useDrivers hook with URL search params
    - Filter bar: search (name), status filter (Select: All/Active/Inactive), driver type filter (Select: All/Company/Owner-Operator)
    - Grid layout: same as brokers (1/2/3 cols responsive)
    - DriverCard for each driver
    - EmptyState (UserCircle icon, "No drivers yet")
    - Pagination, loading skeletons
    - "Add Driver" button opens DriverDrawer

    5. Create `src/app/(dashboard)/drivers/page.tsx`:
    - Renders DriverList
    - Title: "Drivers"

    6. Create `src/app/(dashboard)/drivers/[id]/page.tsx` ('use client'):
    - Uses useDriver(id) hook
    - Sections: Personal Info, Contact, Address, Driver Details, Pay Configuration
    - **Pay Configuration display**: Shows pay type and rate clearly, with a visual callout (e.g., "This driver earns 25% of carrier pay on each order")
    - **Assigned Orders section**: Placeholder for now -- "Assigned orders will appear here" (wired in Plan 05)
    - **Earnings Summary section**: Placeholder -- "Earnings summary will appear here" (wired in later phase)
    - Edit button opens DriverDrawer in edit mode
    - Delete button with ConfirmDialog
    - Back link to /drivers
    - Status toggle with immediate updateDriverStatus action
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - All 6 component files exist
    - DriverForm has pay configuration fields (payType select, payRate input)
    - DriverCard shows pay info
    - Driver detail page has Pay Configuration section
    - Filter bar supports status and driver type filtering
    - `npm run build` succeeds (or `npx tsc --noEmit`)
  </verify>
  <done>
    Complete Drivers CRUD vertical slice: card-grid list with status/type filtering, slide-out drawer with pay configuration, detail page with pay display and status toggle, all mutations through server actions.
  </done>
</task>

</tasks>

<verification>
- Drivers list page renders at /drivers
- Driver detail page renders at /drivers/[id]
- Pay configuration is visible and editable
- Status toggle works on detail page and card
- Filters work for status and driver type
- TypeScript compilation clean
</verification>

<success_criteria>
- Dispatcher can view driver list as card grid at /drivers
- Dispatcher can create driver with full pay configuration (3 pay types)
- Dispatcher can edit driver profile and pay rate
- Dispatcher can toggle driver status (active/inactive) from card or detail
- Dispatcher can view driver detail at /drivers/[id] with pay info
- Dispatcher can delete driver with confirmation
- Driver list filters by status and driver type
- Pay rate label changes based on pay type selection
- Draft auto-save works for new driver creation
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-model-core-entities/02-03-SUMMARY.md`
</output>
