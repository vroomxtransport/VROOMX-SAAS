---
phase: 02-data-model-core-entities
plan: 05
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - src/app/(dashboard)/orders/page.tsx
  - src/app/(dashboard)/orders/_components/order-card.tsx
  - src/app/(dashboard)/orders/_components/order-list.tsx
  - src/app/(dashboard)/orders/_components/order-filters.tsx
  - src/app/(dashboard)/orders/_components/order-drawer.tsx
  - src/app/(dashboard)/orders/_components/order-form.tsx
  - src/app/(dashboard)/orders/_components/vehicle-step.tsx
  - src/app/(dashboard)/orders/_components/location-step.tsx
  - src/app/(dashboard)/orders/_components/pricing-step.tsx
  - src/app/actions/orders.ts
  - src/hooks/use-orders.ts
  - src/hooks/use-vin-decode.ts
  - src/lib/queries/orders.ts
  - src/lib/vin-decoder.ts
autonomous: true

must_haves:
  truths:
    - "Dispatcher can see a list of orders as cards in a grid"
    - "Dispatcher can create an order via multi-step wizard drawer"
    - "VIN decode auto-fills vehicle year/make/model"
    - "Order list filters by status, broker, driver, and date range"
    - "Order cards show vehicle info, route, status badge, and price"
    - "Draft auto-save persists wizard state across drawer close/reopen"
  artifacts:
    - path: "src/app/(dashboard)/orders/page.tsx"
      provides: "Orders list page"
      contains: "OrderList"
    - path: "src/app/(dashboard)/orders/_components/order-form.tsx"
      provides: "Multi-step order wizard form"
      contains: "step"
    - path: "src/app/(dashboard)/orders/_components/vehicle-step.tsx"
      provides: "Step 1: Vehicle info with VIN decode"
      contains: "useVinDecode"
    - path: "src/app/actions/orders.ts"
      provides: "Server Actions: createOrder, updateOrder, deleteOrder"
      contains: "use server"
    - path: "src/lib/vin-decoder.ts"
      provides: "NHTSA vPIC API client for VIN decode"
      contains: "decodeVin"
    - path: "src/hooks/use-vin-decode.ts"
      provides: "TanStack Query hook for VIN decode"
      contains: "useVinDecode"
  key_links:
    - from: "src/app/(dashboard)/orders/_components/vehicle-step.tsx"
      to: "src/hooks/use-vin-decode.ts"
      via: "VIN decode hook auto-fills fields"
      pattern: "useVinDecode"
    - from: "src/app/(dashboard)/orders/_components/order-form.tsx"
      to: "src/app/actions/orders.ts"
      via: "Server Action on final step submit"
      pattern: "createOrder|updateOrder"
    - from: "src/hooks/use-orders.ts"
      to: "supabase.from('orders')"
      via: "Supabase browser client with joins"
      pattern: "from\\('orders'\\).*broker.*driver"
    - from: "src/app/(dashboard)/orders/_components/pricing-step.tsx"
      to: "src/hooks/use-brokers.ts"
      via: "Broker select dropdown fetches broker list"
      pattern: "useBrokers"
---

<objective>
Build the Orders CRUD with multi-step wizard, VIN decode, and advanced filtering. Orders are the most complex entity in Phase 2: they have a 3-step creation wizard (Vehicle -> Location -> Pricing & Broker), VIN decode integration via NHTSA API, FK references to brokers and drivers, draft auto-save, and comprehensive filtering (status, broker, driver, date range, search).

Purpose: Order management is the core of the TMS. This plan creates the primary entity that dispatchers interact with daily.
Output: Orders list with card grid and filters, multi-step creation wizard with VIN decode, edit capability, and all server actions.
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-data-model-core-entities/02-CONTEXT.md
@.planning/phases/02-data-model-core-entities/02-RESEARCH.md
@.planning/phases/02-data-model-core-entities/02-01-SUMMARY.md
@.planning/phases/02-data-model-core-entities/02-02-SUMMARY.md
@.planning/phases/02-data-model-core-entities/02-03-SUMMARY.md
@src/db/schema.ts
@src/lib/validations/order.ts
@src/hooks/use-brokers.ts
@src/hooks/use-drivers.ts
@src/components/shared/entity-card.tsx
@src/components/shared/status-badge.tsx
@src/components/shared/filter-bar.tsx
@src/components/shared/pagination.tsx
@src/components/shared/empty-state.tsx
@src/stores/draft-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VIN decoder, order server actions, and TanStack Query hooks</name>
  <files>
    src/lib/vin-decoder.ts
    src/hooks/use-vin-decode.ts
    src/app/actions/orders.ts
    src/hooks/use-orders.ts
    src/lib/queries/orders.ts
  </files>
  <action>
    1. Create `src/lib/vin-decoder.ts` -- NHTSA vPIC API client:
    - Base URL: `https://vpic.nhtsa.dot.gov/api/vehicles/DecodeVinValues`
    - `decodeVin(vin: string): Promise<VinDecodeResult>` -- Fetches `${BASE}/${vin}?format=json`, parses Results[0]
    - VinDecodeResult interface: { make, model, year, bodyClass, vehicleType, errorCode, errorText } (all strings)
    - Handle errors gracefully: network failures return descriptive error, empty results throw

    2. Create `src/hooks/use-vin-decode.ts` ('use client'):
    - `useVinDecode(vin: string)` -- TanStack Query hook
    - queryKey: ['vin-decode', vin]
    - enabled: vin.length === 17 (only decode complete VINs)
    - staleTime: Infinity (VIN data never changes)
    - retry: 1

    3. Create `src/lib/queries/orders.ts` -- Supabase query builders:
    - `fetchOrders(supabase, filters)`: SELECT with joined relations: `*, broker:brokers(id, name), driver:drivers(id, first_name, last_name)`. count: 'exact'. Order by created_at DESC.
    - Filters: status (eq), brokerId (eq), driverId (eq), dateFrom (gte created_at), dateTo (lte created_at), search (or: vehicle_vin ilike, vehicle_make ilike, order_number ilike). Pagination .range().
    - `fetchOrder(supabase, id)`: SELECT single with same joins.

    4. Create `src/hooks/use-orders.ts` ('use client'):
    - `useOrders(filters)`: useQuery with queryKey ['orders', filters], calls fetchOrders.
    - `useOrder(id)`: useQuery with queryKey ['order', id], calls fetchOrder. enabled: !!id.
    - Filters interface: { status?, brokerId?, driverId?, dateFrom?, dateTo?, search?, page?, pageSize? }

    5. Create `src/app/actions/orders.ts` -- Server Actions:
    - 'use server' directive
    - `createOrder(data: unknown)`: Parse with createOrderSchema (merged vehicle+location+pricing). Get tenant_id from auth. Map all camelCase to snake_case for insert. Do NOT set order_number -- the DB trigger generates it. revalidatePath('/orders').
    - `updateOrder(id: string, data: unknown)`: Parse with createOrderSchema.partial() (allow partial updates). Update. revalidatePath('/orders').
    - `deleteOrder(id: string)`: Delete. revalidatePath('/orders').

    IMPORTANT: Do NOT include order_number in the insert -- the PostgreSQL trigger generates it atomically. Map camelCase form fields to snake_case DB columns: vehicleVin->vehicle_vin, vehicleMake->vehicle_make, pickupLocation->pickup_location, carrierPay->carrier_pay, etc.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - VIN decoder function exists with correct NHTSA URL
    - VIN decode hook only triggers at 17 characters
    - Order query builder includes broker and driver joins
    - Order server actions map camelCase to snake_case
    - Order server actions do NOT set order_number (trigger handles it)
  </verify>
  <done>
    Order data layer complete: VIN decode client + hook, 3 server actions with Zod validation, 2 TanStack Query hooks with broker/driver joins, query builders with comprehensive filtering (status, broker, driver, date, search).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create order UI components (list, card, filters, multi-step wizard drawer)</name>
  <files>
    src/app/(dashboard)/orders/page.tsx
    src/app/(dashboard)/orders/_components/order-card.tsx
    src/app/(dashboard)/orders/_components/order-list.tsx
    src/app/(dashboard)/orders/_components/order-filters.tsx
    src/app/(dashboard)/orders/_components/order-drawer.tsx
    src/app/(dashboard)/orders/_components/order-form.tsx
    src/app/(dashboard)/orders/_components/vehicle-step.tsx
    src/app/(dashboard)/orders/_components/location-step.tsx
    src/app/(dashboard)/orders/_components/pricing-step.tsx
  </files>
  <action>
    1. Create `src/app/(dashboard)/orders/_components/order-card.tsx` ('use client'):
    - Props: { order: Order (with broker/driver joins), onClick: () => void }
    - Card layout (user decided: Super Dispatch info density + Ship.Cars clean aesthetic):
      - Top: Order number (e.g., "ORD-000001") + status badge (color-coded)
      - Vehicle line: "2024 Toyota Camry" (year make model) in bold
      - Route: "Miami, FL -> Houston, TX" (pickup_city, pickup_state -> delivery_city, delivery_state) with arrow icon
      - Broker name (if assigned, as a subtle label)
      - Bottom row: Price "$1,500" + driver name (if assigned)
    - Quick actions: status change dropdown (Select with allowed next statuses), edit button (pencil icon)
    - Status change quick action calls a future updateOrderStatus action

    2. Create `src/app/(dashboard)/orders/_components/order-filters.tsx` ('use client'):
    - Horizontal filter bar specific to orders
    - Filters (all using URL search params via useSearchParams):
      - Search input (debounced, searches VIN/make/order number)
      - Status select (All + all 7 statuses)
      - Broker select (fetched via useBrokers -- show All + broker names)
      - Driver select (fetched via useDrivers -- show All + driver names)
      - Date range: From date + To date (using Calendar + Popover from shadcn/ui)
    - "Clear all" button to reset all filters
    - Filters update URL params, which useOrders reads

    3. Create `src/app/(dashboard)/orders/_components/vehicle-step.tsx` ('use client'):
    - Receives react-hook-form FormProvider context (useFormContext)
    - VIN input field (17 chars max) with "Decode" button
    - When VIN is 17 chars, automatically triggers useVinDecode hook
    - On successful decode, auto-fills: vehicleYear, vehicleMake, vehicleModel, vehicleType
    - Shows decode status: loading spinner during decode, success checkmark, or error message
    - "Enter manually" toggle/link that shows fields without VIN requirement
    - Manual fields always visible: vehicleYear (number), vehicleMake, vehicleModel, vehicleType, vehicleColor
    - VIN decode results populate fields but user can override

    4. Create `src/app/(dashboard)/orders/_components/location-step.tsx` ('use client'):
    - Receives FormProvider context
    - Two sections: Pickup and Delivery
    - Each section: location (address), city, state (2-char), zip, contactName, contactPhone, date (Calendar + Popover)
    - Visual separation between pickup and delivery (divider or two-column on desktop)

    5. Create `src/app/(dashboard)/orders/_components/pricing-step.tsx` ('use client'):
    - Receives FormProvider context
    - Fields: revenue ($ input), carrierPay ($ input), brokerFee ($ input)
    - paymentType select (COD, COP, CHECK, BILL, SPLIT)
    - Broker select: Dropdown populated from useBrokers() hook, searchable, with "None" option
    - Driver select: Dropdown populated from useDrivers({ status: 'active' }) hook, searchable, with "Unassigned" option
    - Summary section showing calculated margin: revenue - carrierPay - brokerFee

    6. Create `src/app/(dashboard)/orders/_components/order-form.tsx` ('use client'):
    - Props: { order?: Order, onSuccess, onCancel }
    - Multi-step wizard with 3 steps: Vehicle (0), Location (1), Pricing (2)
    - Uses react-hook-form FormProvider wrapping all steps
    - Step indicator at top showing current step with labels
    - Back/Next buttons at bottom
    - "Next" validates current step fields before advancing (use trigger() on step-specific fields)
    - Final step has "Create Order" or "Save Changes" button that submits via createOrder/updateOrder
    - Step validation mapping: step 0 -> orderVehicleSchema fields, step 1 -> orderLocationSchema fields, step 2 -> orderPricingSchema fields
    - Draft auto-save: form.watch subscription saves to useDraftStore with key 'order-new' (create mode only)
    - Load draft on mount for create mode
    - Clear draft on successful submit
    - key prop: `key={order?.id ?? 'create'}` to prevent state leaks

    7. Create `src/app/(dashboard)/orders/_components/order-drawer.tsx` ('use client'):
    - Sheet side="right", wider than other entities: `className="w-full sm:max-w-2xl"` (wizard needs more space)
    - Title: "New Order - Step X of 3" or "Edit Order"
    - Unsaved changes warning when closing with dirty form
    - Renders OrderForm inside

    8. Create `src/app/(dashboard)/orders/_components/order-list.tsx` ('use client'):
    - Uses useOrders hook
    - Renders OrderFilters at top
    - Grid: `grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4`
    - OrderCard for each order
    - EmptyState (PackageOpen icon, "No orders yet", "Create your first order to get started")
    - Pagination, loading skeletons (3 skeleton cards)
    - "New Order" button (primary, prominent) opens OrderDrawer
    - Shows total count: "Showing X of Y orders"

    9. Create `src/app/(dashboard)/orders/page.tsx`:
    - Renders OrderList
    - Title: "Orders"
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - All 9 component files exist
    - OrderForm has 3 steps with step navigation
    - VehicleStep uses useVinDecode hook
    - PricingStep uses useBrokers and useDrivers for select dropdowns
    - OrderFilters has status, broker, driver, date range, and search filters
    - OrderCard shows order number, vehicle, route, status badge, price
    - `npm run build` succeeds (or `npx tsc --noEmit`)
  </verify>
  <done>
    Complete Orders CRUD: card-grid list with comprehensive filtering (status/broker/driver/date/search), multi-step creation wizard with VIN decode auto-fill, draft auto-save, broker/driver selection, and all server actions. The most complex entity in Phase 2 is fully functional.
  </done>
</task>

</tasks>

<verification>
- Orders list page renders at /orders
- Multi-step wizard navigates between 3 steps
- VIN decode calls NHTSA API and auto-fills fields
- Manual vehicle entry works without VIN
- Broker and driver select dropdowns populate from database
- Status filter works
- Search filters by VIN/make/order number
- TypeScript compilation clean
</verification>

<success_criteria>
- Dispatcher can view order list as card grid at /orders
- Order cards show: order number, vehicle info, route (city, state -> city, state), status badge, price
- Dispatcher can create order via 3-step wizard (Vehicle -> Location -> Pricing)
- VIN decode auto-fills year/make/model on valid 17-char VIN
- Manual vehicle entry works when VIN unavailable
- Broker and driver can be assigned during order creation
- Step validation prevents advancing with invalid fields
- Draft auto-save persists wizard state if drawer is closed
- Order list filters by status, broker, driver, date range, and search
- Pagination works
- Financial summary shows margin on pricing step
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-model-core-entities/02-05-SUMMARY.md`
</output>
