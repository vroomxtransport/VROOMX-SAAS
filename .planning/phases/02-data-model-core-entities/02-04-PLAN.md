---
phase: 02-data-model-core-entities
plan: 04
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/app/(dashboard)/trucks/page.tsx
  - src/app/(dashboard)/trucks/[id]/page.tsx
  - src/app/(dashboard)/trucks/_components/truck-card.tsx
  - src/app/(dashboard)/trucks/_components/truck-list.tsx
  - src/app/(dashboard)/trucks/_components/truck-form.tsx
  - src/app/(dashboard)/trucks/_components/truck-drawer.tsx
  - src/app/actions/trucks.ts
  - src/hooks/use-trucks.ts
  - src/lib/queries/trucks.ts
autonomous: true

must_haves:
  truths:
    - "Dispatcher can see a list of trucks as cards in a grid"
    - "Dispatcher can create a new truck with type and details"
    - "Dispatcher can edit an existing truck"
    - "Dispatcher can view truck detail page"
    - "Truck status management works (active/inactive/maintenance)"
    - "Truck data is tenant-isolated"
  artifacts:
    - path: "src/app/(dashboard)/trucks/page.tsx"
      provides: "Trucks list page"
      contains: "TruckList"
    - path: "src/app/(dashboard)/trucks/_components/truck-form.tsx"
      provides: "Truck form with type selection"
      contains: "useForm"
    - path: "src/app/actions/trucks.ts"
      provides: "Server Actions: createTruck, updateTruck, deleteTruck"
      contains: "use server"
    - path: "src/hooks/use-trucks.ts"
      provides: "TanStack Query hook for fetching trucks"
      contains: "useQuery"
  key_links:
    - from: "src/app/(dashboard)/trucks/_components/truck-form.tsx"
      to: "src/app/actions/trucks.ts"
      via: "Server Action call on form submit"
      pattern: "createTruck|updateTruck"
    - from: "src/hooks/use-trucks.ts"
      to: "supabase.from('trucks')"
      via: "Supabase browser client query"
      pattern: "from\\('trucks'\\)"
---

<objective>
Build complete Trucks CRUD -- the third vertical slice following the established pattern from Brokers and Drivers. Trucks have type classification (7-Car, 8-Car, 9-Car, Flatbed, Enclosed), three-way status management (active/inactive/maintenance), and vehicle identification fields.

Purpose: Trucks are referenced in the dispatch workflow (Phase 3) for trip creation. This plan ensures fleet management is fully functional with status tracking and type classification.
Output: Fully functional truck/fleet management with list, create, edit, detail, status management, and type filtering.
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-data-model-core-entities/02-CONTEXT.md
@.planning/phases/02-data-model-core-entities/02-RESEARCH.md
@.planning/phases/02-data-model-core-entities/02-01-SUMMARY.md
@src/db/schema.ts
@src/lib/validations/truck.ts
@src/components/shared/entity-card.tsx
@src/components/shared/status-badge.tsx
@src/components/shared/filter-bar.tsx
@src/components/shared/pagination.tsx
@src/components/shared/empty-state.tsx
@src/components/shared/confirm-dialog.tsx
@src/stores/draft-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create truck server actions, query builders, and TanStack Query hooks</name>
  <files>
    src/app/actions/trucks.ts
    src/hooks/use-trucks.ts
    src/lib/queries/trucks.ts
  </files>
  <action>
    1. Create `src/lib/queries/trucks.ts` -- Supabase query builder functions:
    - `fetchTrucks(supabase, filters)`: SELECT with optional filters: truckStatus (eq), truckType (eq), search (unit_number/make/model ilike). Pagination .range(). count: 'exact'. Order by unit_number ASC.
    - `fetchTruck(supabase, id)`: SELECT single by id.
    - Filters: { status?: string, truckType?: string, search?: string, page?: number, pageSize?: number }

    2. Create `src/hooks/use-trucks.ts` ('use client'):
    - `useTrucks(filters)`: useQuery with queryKey ['trucks', filters], calls fetchTrucks.
    - `useTruck(id)`: useQuery with queryKey ['truck', id], calls fetchTruck. enabled: !!id.

    3. Create `src/app/actions/trucks.ts` -- Server Actions:
    - 'use server' directive
    - `createTruck(data: unknown)`: Parse with truckSchema, get tenant_id, insert with snake_case mapping (unit_number, truck_type, truck_status). revalidatePath('/trucks').
    - `updateTruck(id: string, data: unknown)`: Parse, update. revalidatePath('/trucks').
    - `deleteTruck(id: string)`: Delete. revalidatePath('/trucks').
    - `updateTruckStatus(id: string, status: 'active' | 'inactive' | 'maintenance')`: Quick status change. revalidatePath('/trucks').
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - 4 server actions exported
    - Query hooks use correct queryKey pattern
  </verify>
  <done>
    Truck data layer complete: 4 server actions, 2 TanStack Query hooks, query builders with status/type/search filtering.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create truck UI components (list, card, drawer, form, detail page)</name>
  <files>
    src/app/(dashboard)/trucks/page.tsx
    src/app/(dashboard)/trucks/[id]/page.tsx
    src/app/(dashboard)/trucks/_components/truck-card.tsx
    src/app/(dashboard)/trucks/_components/truck-list.tsx
    src/app/(dashboard)/trucks/_components/truck-form.tsx
    src/app/(dashboard)/trucks/_components/truck-drawer.tsx
  </files>
  <action>
    1. Create `src/app/(dashboard)/trucks/_components/truck-card.tsx` ('use client'):
    - Displays: unit number (bold, large), truck type badge (7-Car, 8-Car, etc.), status badge (using StatusBadge with type='truck'), year/make/model line, VIN (truncated), ownership badge (Company/Owner-Operator)
    - Quick actions: status change dropdown (Select with active/inactive/maintenance), edit button

    2. Create `src/app/(dashboard)/trucks/_components/truck-form.tsx` ('use client'):
    - Uses react-hook-form with zodResolver and truckSchema
    - Fields:
      - **Identity**: unitNumber (required), vin (optional, validated to 17 chars if provided)
      - **Vehicle Info**: year (number), make, model
      - **Classification**: truckType (Select: 7-Car Hauler / 8-Car Hauler / 9-Car Hauler / Flatbed / Enclosed), truckStatus (Select: Active / Inactive / Maintenance)
      - **Ownership**: ownership (Select: Company / Owner-Operator)
      - **Notes**: notes (Textarea)
    - Draft auto-save for create mode (key: 'truck-new')
    - Truck type display labels: '7_car' -> '7-Car Hauler', '8_car' -> '8-Car Hauler', etc.

    3. Create `src/app/(dashboard)/trucks/_components/truck-drawer.tsx` ('use client'):
    - Same Sheet pattern as Brokers/Drivers
    - Unsaved changes warning on dirty close

    4. Create `src/app/(dashboard)/trucks/_components/truck-list.tsx` ('use client'):
    - Uses useTrucks hook with URL search params
    - Filter bar: search (unit number/make/model), status filter (All/Active/Inactive/Maintenance), truck type filter (All/7-Car/8-Car/9-Car/Flatbed/Enclosed)
    - Grid layout (same responsive pattern)
    - TruckCard for each truck
    - EmptyState (Truck icon from lucide, "No trucks yet", "Add your first truck to manage your fleet")
    - Pagination, loading skeletons
    - "Add Truck" button opens TruckDrawer

    5. Create `src/app/(dashboard)/trucks/page.tsx`:
    - Renders TruckList
    - Title: "Fleet" (matching the sidebar nav label)

    6. Create `src/app/(dashboard)/trucks/[id]/page.tsx` ('use client'):
    - Uses useTruck(id) hook
    - Sections: Vehicle Info (unit number, VIN, year/make/model), Classification (type, status, ownership), Notes
    - Status management: Select dropdown to change status with immediate updateTruckStatus call
    - Edit button opens TruckDrawer in edit mode
    - Delete with ConfirmDialog
    - Back link to /trucks
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - All 6 component files exist
    - TruckForm has truck type and status selects
    - Truck type labels are human-readable (not raw enum values)
    - TruckCard shows unit number, type badge, status badge
    - Filter bar has status and truck type filters
    - `npm run build` succeeds (or `npx tsc --noEmit`)
  </verify>
  <done>
    Complete Trucks CRUD vertical slice: card-grid list with status/type filtering, slide-out drawer form, detail page with status management, server actions for all mutations. Fleet management fully functional.
  </done>
</task>

</tasks>

<verification>
- Trucks list page renders at /trucks
- Truck detail page renders at /trucks/[id]
- Truck type labels display correctly (7-Car Hauler, etc.)
- Status management works (3 statuses)
- Filters work for status and truck type
- TypeScript compilation clean
</verification>

<success_criteria>
- Dispatcher can view truck list as card grid at /trucks
- Dispatcher can create truck with type classification
- Dispatcher can edit truck details
- Dispatcher can change truck status (active/inactive/maintenance) from card or detail
- Dispatcher can view truck detail at /trucks/[id]
- Dispatcher can delete truck with confirmation
- Truck list filters by status and type
- Truck type labels are human-readable (not enum values)
- Draft auto-save works for new truck creation
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-model-core-entities/02-04-SUMMARY.md`
</output>
