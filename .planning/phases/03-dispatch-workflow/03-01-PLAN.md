---
phase: 03-dispatch-workflow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00003_trips_and_dispatch.sql
  - src/db/schema.ts
  - src/types/index.ts
  - src/types/database.ts
  - src/lib/validations/trip.ts
  - src/lib/validations/trip-expense.ts
  - src/components/layout/sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "trips and trip_expenses tables exist with RLS policies"
    - "orders table has trip_id foreign key column"
    - "per_car value exists in driver_pay_type enum"
    - "Trip and TripExpense TypeScript types are exported"
    - "Trip and trip expense Zod validation schemas exist"
    - "Sidebar shows Dispatch and Orders links (not Loads/Routes)"
  artifacts:
    - path: "supabase/migrations/00003_trips_and_dispatch.sql"
      provides: "Trips, trip_expenses tables, RLS, indexes, triggers, trip_id on orders"
      contains: "CREATE TABLE public.trips"
    - path: "src/db/schema.ts"
      provides: "Drizzle schema for trips and trip_expenses tables"
      contains: "export const trips"
    - path: "src/types/index.ts"
      provides: "TripStatus, ExpenseCategory types with labels, colors, const arrays"
      contains: "TripStatus"
    - path: "src/types/database.ts"
      provides: "Trip, TripExpense snake_case interfaces"
      contains: "export interface Trip"
    - path: "src/lib/validations/trip.ts"
      provides: "Trip Zod schema for form validation"
      contains: "tripSchema"
    - path: "src/lib/validations/trip-expense.ts"
      provides: "Trip expense Zod schema for form validation"
      contains: "tripExpenseSchema"
    - path: "src/components/layout/sidebar.tsx"
      provides: "Updated navigation with Dispatch and Orders links"
      contains: "/dispatch"
  key_links:
    - from: "src/db/schema.ts"
      to: "supabase/migrations/00003_trips_and_dispatch.sql"
      via: "Drizzle schema mirrors SQL tables"
      pattern: "trips.*pgTable"
    - from: "src/types/index.ts"
      to: "src/db/schema.ts"
      via: "Type unions match pgEnum values"
      pattern: "TripStatus.*planned.*in_progress"
    - from: "src/types/database.ts"
      to: "src/db/schema.ts"
      via: "Interface fields match Drizzle column names"
      pattern: "trip_number.*driver_id.*truck_id"
---

<objective>
Create the database foundation for the dispatch workflow: trips and trip_expenses tables with RLS, Drizzle schema definitions, TypeScript types, Zod validation schemas, and sidebar navigation update.

Purpose: Establishes all schema, types, and validation infrastructure that every subsequent Phase 3 plan depends on. Without this foundation, no trip CRUD, financial calculations, or UI can be built.

Output: SQL migration, Drizzle schema, TypeScript types/interfaces, Zod schemas, and updated sidebar navigation.
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-dispatch-workflow/03-CONTEXT.md
@.planning/phases/03-dispatch-workflow/03-RESEARCH.md

# Key source files to reference for established patterns:
@supabase/migrations/00002_core_entities.sql
@src/db/schema.ts
@src/types/index.ts
@src/types/database.ts
@src/lib/validations/order.ts
@src/lib/validations/driver.ts
@src/components/layout/sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: SQL migration for trips, trip_expenses, and orders.trip_id</name>
  <files>supabase/migrations/00003_trips_and_dispatch.sql</files>
  <action>
Create SQL migration `00003_trips_and_dispatch.sql` following the exact pattern established in `00002_core_entities.sql`. The migration must include:

**1. New enums:**
- `trip_status`: `'planned', 'in_progress', 'at_terminal', 'completed'`
- `expense_category`: `'fuel', 'tolls', 'repairs', 'lodging', 'misc'`

**2. Extend existing enum:**
- Add `'per_car'` to `driver_pay_type` enum: `ALTER TYPE public.driver_pay_type ADD VALUE 'per_car';`

**3. Create `trips` table:**
```sql
CREATE TABLE public.trips (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  trip_number TEXT,
  driver_id UUID NOT NULL REFERENCES public.drivers(id),
  truck_id UUID NOT NULL REFERENCES public.trucks(id),
  status public.trip_status NOT NULL DEFAULT 'planned',
  start_date DATE NOT NULL,
  end_date DATE NOT NULL,
  -- Manually entered financials
  carrier_pay NUMERIC(12,2) DEFAULT 0,
  -- Denormalized financial summary (computed by app code)
  total_revenue NUMERIC(12,2) DEFAULT 0,
  total_broker_fees NUMERIC(12,2) DEFAULT 0,
  driver_pay NUMERIC(12,2) DEFAULT 0,
  total_expenses NUMERIC(12,2) DEFAULT 0,
  net_profit NUMERIC(12,2) DEFAULT 0,
  order_count INTEGER DEFAULT 0,
  -- Metadata
  notes TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

**4. Create `trip_expenses` table:**
```sql
CREATE TABLE public.trip_expenses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  trip_id UUID NOT NULL REFERENCES public.trips(id) ON DELETE CASCADE,
  category public.expense_category NOT NULL DEFAULT 'misc',
  custom_label TEXT,
  amount NUMERIC(12,2) NOT NULL,
  notes TEXT,
  expense_date DATE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

**5. Add `trip_id` to orders table:**
```sql
ALTER TABLE public.orders ADD COLUMN trip_id UUID REFERENCES public.trips(id);
CREATE INDEX idx_orders_tenant_trip ON public.orders(tenant_id, trip_id);
```

**6. Indexes (same pattern as 00002):**
- `idx_trips_tenant_id` on `(tenant_id)`
- `idx_trips_tenant_status` on `(tenant_id, status)`
- `idx_trips_tenant_driver` on `(tenant_id, driver_id)`
- `idx_trips_tenant_truck` on `(tenant_id, truck_id)`
- `idx_trips_tenant_dates` on `(tenant_id, start_date, end_date)`
- `idx_trip_expenses_tenant_id` on `(tenant_id)`
- `idx_trip_expenses_trip_id` on `(trip_id)`

**7. Triggers:**
- `handle_updated_at` trigger on both tables (same as 00002)
- `generate_trip_number` trigger on trips (same pattern as `generate_order_number` in 00002): format `TRIP-XXXXXX`, zero-padded 6 digits, per-tenant sequential

**8. RLS policies (same `(SELECT ...)` wrapper pattern as 00002):**
- Enable RLS on both tables
- SELECT: `tenant_id = (SELECT get_tenant_id())`
- INSERT: `tenant_id = (SELECT get_tenant_id())`
- UPDATE: `tenant_id = (SELECT get_tenant_id())`
- DELETE: `tenant_id = (SELECT get_tenant_id())`

**9. Realtime:**
```sql
ALTER PUBLICATION supabase_realtime ADD TABLE public.trips;
ALTER PUBLICATION supabase_realtime ADD TABLE public.trip_expenses;
```

Reference `00002_core_entities.sql` for exact syntax patterns (RLS policy format, trigger syntax, index naming).
  </action>
  <verify>
Review the SQL file for:
- Both CREATE TABLE statements present
- ALTER TABLE for orders.trip_id
- ALTER TYPE for per_car enum value
- RLS enabled + 4 policies per table (SELECT, INSERT, UPDATE, DELETE) with (SELECT ...) wrapper
- All indexes created
- Triggers for updated_at and trip_number
- Realtime publication
  </verify>
  <done>SQL migration creates trips, trip_expenses tables with RLS, adds trip_id to orders, extends driver_pay_type enum with per_car</done>
</task>

<task type="auto">
  <name>Task 2: Drizzle schema, TypeScript types, Zod validations, and sidebar update</name>
  <files>
    src/db/schema.ts
    src/types/index.ts
    src/types/database.ts
    src/lib/validations/trip.ts
    src/lib/validations/trip-expense.ts
    src/components/layout/sidebar.tsx
  </files>
  <action>
**A. Update `src/db/schema.ts`** -- Add new enums and tables after the existing Phase 2 tables:

1. Add `tripStatusEnum`: `pgEnum('trip_status', ['planned', 'in_progress', 'at_terminal', 'completed'])`
2. Add `expenseCategoryEnum`: `pgEnum('expense_category', ['fuel', 'tolls', 'repairs', 'lodging', 'misc'])`
3. Update `driverPayTypeEnum` to include `'per_car'`: `pgEnum('driver_pay_type', ['percentage_of_carrier_pay', 'dispatch_fee_percent', 'per_mile', 'per_car'])`
4. Add `tripId` column to the existing `orders` table definition: `tripId: uuid('trip_id').references(() => trips.id)` -- be careful with circular references, place trips table before adding the column or use a string reference
5. Add `trips` pgTable definition with all columns matching the SQL migration. Use `numeric()` with `{ precision: 12, scale: 2 }` and `.default('0')` for financial columns (string defaults for decimal precision, same as orders table).
6. Add `tripExpenses` pgTable definition matching the SQL migration.
7. Add indexes using the same pattern as existing tables.

**B. Update `src/types/index.ts`** -- Add Phase 3 types after the Phase 2 section:

```typescript
// ============================================================================
// Phase 3: Dispatch Workflow Types
// ============================================================================

export type TripStatus = 'planned' | 'in_progress' | 'at_terminal' | 'completed'
export type ExpenseCategory = 'fuel' | 'tolls' | 'repairs' | 'lodging' | 'misc'

// Const arrays
export const TRIP_STATUSES: readonly TripStatus[] = ['planned', 'in_progress', 'at_terminal', 'completed'] as const
export const EXPENSE_CATEGORIES: readonly ExpenseCategory[] = ['fuel', 'tolls', 'repairs', 'lodging', 'misc'] as const

// Labels
export const TRIP_STATUS_LABELS: Record<TripStatus, string> = {
  planned: 'Planned',
  in_progress: 'In Progress',
  at_terminal: 'At Terminal',
  completed: 'Completed',
}
export const EXPENSE_CATEGORY_LABELS: Record<ExpenseCategory, string> = {
  fuel: 'Fuel',
  tolls: 'Tolls',
  repairs: 'Repairs',
  lodging: 'Lodging',
  misc: 'Miscellaneous',
}

// Colors (trip status)
export const TRIP_STATUS_COLORS: Record<TripStatus, string> = {
  planned: 'bg-blue-50 text-blue-700 border-blue-200',
  in_progress: 'bg-amber-50 text-amber-700 border-amber-200',
  at_terminal: 'bg-purple-50 text-purple-700 border-purple-200',
  completed: 'bg-green-50 text-green-700 border-green-200',
}

// Truck capacity lookup (derived from truck_type)
export const TRUCK_CAPACITY: Record<TruckType, number> = {
  '7_car': 7,
  '8_car': 8,
  '9_car': 9,
  'flatbed': 4,
  'enclosed': 6,
}
```

Also update `DRIVER_PAY_TYPES` const array to include `'per_car'`, and add `per_car: 'Per Car'` to `DRIVER_PAY_TYPE_LABELS`.

**C. Update `src/types/database.ts`** -- Add Trip and TripExpense interfaces:

```typescript
export interface Trip {
  id: string
  tenant_id: string
  trip_number: string | null
  driver_id: string
  truck_id: string
  status: 'planned' | 'in_progress' | 'at_terminal' | 'completed'
  start_date: string
  end_date: string
  carrier_pay: string
  total_revenue: string
  total_broker_fees: string
  driver_pay: string
  total_expenses: string
  net_profit: string
  order_count: number
  notes: string | null
  created_at: string
  updated_at: string
}

export interface TripExpense {
  id: string
  tenant_id: string
  trip_id: string
  category: 'fuel' | 'tolls' | 'repairs' | 'lodging' | 'misc'
  custom_label: string | null
  amount: string
  notes: string | null
  expense_date: string | null
  created_at: string
  updated_at: string
}
```

Also add `trip_id: string | null` to the existing `Order` interface.

**D. Create `src/lib/validations/trip.ts`:**

```typescript
import { z } from 'zod/v4'

export const tripSchema = z.object({
  driver_id: z.string().min(1, 'Driver is required'),
  truck_id: z.string().min(1, 'Truck is required'),
  start_date: z.string().min(1, 'Start date is required'),
  end_date: z.string().min(1, 'End date is required'),
  carrier_pay: z.coerce.number().min(0).default(0),
  notes: z.string().optional(),
})

export type TripInput = z.input<typeof tripSchema>
export type TripFormData = z.infer<typeof tripSchema>
```

Note: Use `z.input<>` for the form type (same pattern as drivers/orders for fields with `.default()`).

**E. Create `src/lib/validations/trip-expense.ts`:**

```typescript
import { z } from 'zod/v4'

export const tripExpenseSchema = z.object({
  category: z.enum(['fuel', 'tolls', 'repairs', 'lodging', 'misc']),
  custom_label: z.string().optional(),
  amount: z.coerce.number().min(0.01, 'Amount must be greater than 0'),
  notes: z.string().optional(),
  expense_date: z.string().optional(),
})

export type TripExpenseInput = z.input<typeof tripExpenseSchema>
export type TripExpenseFormData = z.infer<typeof tripExpenseSchema>
```

**F. Update `src/components/layout/sidebar.tsx`:**

Update the `NAV_ITEMS` array. Replace the current entries:
- Change `{ name: 'Loads', href: '/loads', icon: Package }` to `{ name: 'Orders', href: '/orders', icon: Package }`
- Change `{ name: 'Routes', href: '/routes', icon: Route }` to `{ name: 'Dispatch', href: '/dispatch', icon: Route }`
- Change `{ name: 'Customers', href: '/customers', icon: Building2, minRole: 'dispatcher' }` to `{ name: 'Brokers', href: '/brokers', icon: Building2, minRole: 'dispatcher' }`

Keep all other items unchanged. The navigation order should be: Dashboard, Orders, Dispatch, Trucks, Drivers, Brokers, Invoices, Settings.

**G. Update `src/components/shared/status-badge.tsx`:**

Add 'trip' to the `StatusBadgeType` union and add a case to both `getColorClasses` and `getLabel` functions:
- Import `TRIP_STATUS_COLORS`, `TRIP_STATUS_LABELS`, and `TripStatus` from `@/types`
- Add `case 'trip':` returning `TRIP_STATUS_COLORS[status as TripStatus]` and `TRIP_STATUS_LABELS[status as TripStatus]`
  </action>
  <verify>
Run `npx tsc --noEmit` to check for TypeScript errors across all modified files. Verify:
- No circular reference issues in schema.ts (trips table referenced by orders.trip_id)
- All type unions match enum values exactly
- Zod schemas export both Input and infer types
- StatusBadge supports 'trip' type
- Sidebar shows correct navigation items
  </verify>
  <done>Drizzle schema has trips + trip_expenses tables. TypeScript types include TripStatus, ExpenseCategory with labels/colors/arrays. Zod schemas validate trip and expense forms. Sidebar shows Orders, Dispatch, Brokers navigation. StatusBadge supports trip status.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. SQL migration file is valid SQL (review manually)
3. Drizzle schema types match SQL column definitions exactly
4. Types/database.ts interfaces match Drizzle column names (snake_case)
5. Types/index.ts has TripStatus, ExpenseCategory, TRUCK_CAPACITY exports
6. Both Zod schemas export Input and inferred types
7. StatusBadge renders trip status badges
8. Sidebar links point to /orders, /dispatch, /brokers (not /loads, /routes, /customers)
</verification>

<success_criteria>
- trips and trip_expenses tables defined in SQL and Drizzle with matching schemas
- orders.trip_id FK column added in both SQL and Drizzle
- per_car added to driver_pay_type enum
- All Phase 3 types, labels, colors, and const arrays exported from types/index.ts
- Trip and TripExpense interfaces in types/database.ts
- Trip and trip expense Zod validation schemas created
- Sidebar navigation updated to functional page links
- StatusBadge supports trip status type
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/03-dispatch-workflow/03-01-SUMMARY.md`
</output>
