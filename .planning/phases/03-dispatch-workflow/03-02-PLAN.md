---
phase: 03-dispatch-workflow
plan: 02
type: tdd
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/lib/financial/trip-calculations.ts
  - src/lib/financial/__tests__/trip-calculations.test.ts
autonomous: true

must_haves:
  truths:
    - "calculateTripFinancials returns correct revenue sum from orders"
    - "Company driver pay calculated as percentage of revenue after broker fees"
    - "Owner-operator dispatch fee calculated correctly"
    - "Per-car flat rate calculates driverPay as rate * orderCount"
    - "Net profit equals revenue minus broker fees minus driver pay minus expenses minus carrier pay"
    - "Empty orders array returns all zeros"
  artifacts:
    - path: "src/lib/financial/trip-calculations.ts"
      provides: "Pure financial calculation function"
      exports: ["calculateTripFinancials"]
      min_lines: 40
    - path: "src/lib/financial/__tests__/trip-calculations.test.ts"
      provides: "Test suite for financial calculations"
      contains: "calculateTripFinancials"
      min_lines: 60
  key_links:
    - from: "src/lib/financial/trip-calculations.ts"
      to: "src/types/index.ts"
      via: "Uses DriverPayType type"
      pattern: "import.*DriverPayType"
---

<objective>
Build and test the pure financial calculation module for trip-level financials using TDD. This module computes revenue, broker fees, driver pay (three models), expenses, and net profit.

Purpose: Financial calculations are the core business logic of the TMS. Using TDD ensures correctness for all driver pay models (company driver %, owner-operator dispatch fee %, per-car flat rate) and edge cases. This module is called by every trip mutation in Plan 03.

Output: Fully tested `calculateTripFinancials()` function with comprehensive test coverage.
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-dispatch-workflow/03-CONTEXT.md
@.planning/phases/03-dispatch-workflow/03-RESEARCH.md

# Reference for financial logic (Horizon Star adaptation)
# See RESEARCH.md "Financial Calculation Logic -- Detailed Analysis" section
@src/types/index.ts
</context>

<feature>
  <name>Trip Financial Calculations</name>
  <files>src/lib/financial/trip-calculations.ts, src/lib/financial/__tests__/trip-calculations.test.ts</files>
  <behavior>
The `calculateTripFinancials` function takes four inputs and returns a `TripFinancials` object.

**Inputs:**
1. `orders: OrderFinancials[]` -- array of `{ revenue: number, brokerFee: number }`
2. `driver: DriverConfig | null` -- `{ driverType, payType, payRate }` or null (no driver assigned)
3. `expenses: TripExpenseItem[]` -- array of `{ amount: number }`
4. `carrierPay: number` -- manually entered at trip level

**Output:** `TripFinancials` with fields: revenue, brokerFees, carrierPay, driverPay, expenses, netProfit

**Calculation rules (from CONTEXT.md and Horizon Star reference):**
- `revenue` = SUM of all order revenues
- `brokerFees` = SUM of all order broker fees
- `expenses` = SUM of all expense amounts
- `carrierPay` = passthrough (manually entered)

**Driver pay depends on pay model:**

1. **Company driver (`driverType: 'company'`, `payType: 'percentage_of_carrier_pay'`):**
   - `revenueAfterFees = revenue - brokerFees`
   - `driverPay = revenueAfterFees * (payRate / 100)`

2. **Owner-operator dispatch fee (`driverType: 'owner_operator'`, `payType: 'dispatch_fee_percent'`):**
   - `revenueAfterFees = revenue - brokerFees`
   - `dispatchFee = revenueAfterFees * (payRate / 100)` -- this is the COMPANY's cut
   - `driverPay = revenueAfterFees - dispatchFee` -- driver gets the remainder
   - (The company's profit from this type = dispatchFee, which ends up in netProfit)

3. **Per-car flat rate (`payType: 'per_car'`):**
   - `driverPay = payRate * orders.length`

4. **No driver / unknown pay type:**
   - `driverPay = 0`

**Net profit:** `revenue - brokerFees - driverPay - expenses - carrierPay`

**Test cases:**

| Case | Orders | Driver | Expenses | CarrierPay | Expected |
|------|--------|--------|----------|------------|----------|
| Empty orders | [] | company 60% | [] | 0 | all zeros |
| Single order, company driver 60% | [{rev: 1000, fee: 100}] | company 60% | [] | 0 | rev: 1000, fees: 100, driverPay: 540, net: 360 |
| Multi order, company driver 50% | [{rev: 2000, fee: 200}, {rev: 1500, fee: 150}] | company 50% | [{50}] | 100 | rev: 3500, fees: 350, driverPay: 1575, exp: 50, carrier: 100, net: 1425 |
| Owner-op dispatch fee 10% | [{rev: 5000, fee: 500}] | owner_op dispatch_fee 10% | [] | 0 | rev: 5000, fees: 500, driverPay: 4050, net: 450 |
| Per-car $50 | [{rev: 1000, fee: 100}, {rev: 1200, fee: 150}] | per_car 50 | [{30}] | 0 | rev: 2200, fees: 250, driverPay: 100, exp: 30, net: 1820 |
| With carrier pay and expenses | [{rev: 3000, fee: 300}] | company 40% | [{100}, {50}] | 500 | rev: 3000, fees: 300, driverPay: 1080, exp: 150, carrier: 500, net: 970 |
| Null driver | [{rev: 1000, fee: 100}] | null | [] | 0 | rev: 1000, fees: 100, driverPay: 0, net: 900 |
  </behavior>
  <implementation>
Create `src/lib/financial/trip-calculations.ts` with:

1. Interface definitions: `OrderFinancials`, `DriverConfig`, `TripExpenseItem`, `TripFinancials`
2. Export `calculateTripFinancials()` as a pure function (no side effects, no database calls)
3. Use `DriverPayType` from `@/types` for the payType field in DriverConfig

The function must handle:
- Empty orders array (returns all zeros)
- Null driver config (driverPay = 0)
- All three pay models
- Negative net profit (valid -- trip can lose money)
- Large numbers (use standard JS number math -- precision is handled at the DB level with numeric(12,2))

Test file location: `src/lib/financial/__tests__/trip-calculations.test.ts`
Use Vitest (check if installed) or the project's test runner. If no test runner is configured, install Vitest as devDependency and add a minimal vitest.config.ts.

**IMPORTANT:** Check `package.json` for existing test configuration before choosing a test runner. If none exists, add Vitest:
```bash
npm install -D vitest
```
And create a minimal `vitest.config.ts` with path aliases matching tsconfig.
  </implementation>
</feature>

<verification>
1. Test suite runs and all test cases pass: `npx vitest run src/lib/financial`
2. Function handles all three driver pay models correctly
3. Empty/null inputs produce sensible defaults (zeros)
4. Net profit calculation matches: revenue - brokerFees - driverPay - expenses - carrierPay
5. `npx tsc --noEmit` passes
</verification>

<success_criteria>
- calculateTripFinancials function exists and is exported
- All 7+ test cases pass
- Company driver percentage calculation correct
- Owner-operator dispatch fee calculation correct
- Per-car flat rate calculation correct
- Edge cases handled (empty orders, null driver, zero amounts)
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/03-dispatch-workflow/03-02-SUMMARY.md`
</output>
