---
phase: 03-dispatch-workflow
plan: 05
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified:
  - src/app/(dashboard)/trips/[id]/page.tsx
  - src/app/(dashboard)/trips/_components/trip-detail.tsx
  - src/app/(dashboard)/trips/_components/trip-financial-card.tsx
  - src/app/(dashboard)/trips/_components/trip-orders.tsx
  - src/app/(dashboard)/trips/_components/trip-expenses.tsx
  - src/app/(dashboard)/trips/_components/trip-status-actions.tsx
  - src/app/(dashboard)/trips/_components/assign-order-dialog.tsx
autonomous: true

must_haves:
  truths:
    - "Trip detail page shows trip info with driver and truck"
    - "Financial summary card displays 6 key numbers (revenue, carrier pay, broker fees, driver pay, expenses, net profit)"
    - "Orders assigned to the trip are listed with unassign capability"
    - "New orders can be assigned via search dialog"
    - "Trip expenses can be added, edited, and deleted"
    - "Trip status can be advanced and rolled back"
    - "Capacity indicator shows current/max"
  artifacts:
    - path: "src/app/(dashboard)/trips/[id]/page.tsx"
      provides: "Trip detail page wrapper"
      contains: "TripDetail"
      min_lines: 10
    - path: "src/app/(dashboard)/trips/_components/trip-detail.tsx"
      provides: "Main trip detail layout with all sections"
      contains: "useTrip"
      min_lines: 60
    - path: "src/app/(dashboard)/trips/_components/trip-financial-card.tsx"
      provides: "Financial summary card with 6 numbers"
      contains: "Revenue"
      min_lines: 40
    - path: "src/app/(dashboard)/trips/_components/trip-orders.tsx"
      provides: "Orders list assigned to trip with unassign"
      contains: "unassignOrderFromTrip"
      min_lines: 40
    - path: "src/app/(dashboard)/trips/_components/trip-expenses.tsx"
      provides: "Expense management section"
      contains: "createTripExpense"
      min_lines: 50
    - path: "src/app/(dashboard)/trips/_components/trip-status-actions.tsx"
      provides: "Status workflow buttons"
      contains: "updateTripStatus"
      min_lines: 30
    - path: "src/app/(dashboard)/trips/_components/assign-order-dialog.tsx"
      provides: "Dialog to search and assign unassigned orders"
      contains: "useUnassignedOrders"
      min_lines: 50
  key_links:
    - from: "src/app/(dashboard)/trips/_components/trip-detail.tsx"
      to: "src/hooks/use-trips.ts"
      via: "useTrip hook provides trip data"
      pattern: "useTrip"
    - from: "src/app/(dashboard)/trips/_components/trip-financial-card.tsx"
      to: "src/types/database.ts"
      via: "Reads denormalized financial fields from Trip"
      pattern: "total_revenue|net_profit"
    - from: "src/app/(dashboard)/trips/_components/assign-order-dialog.tsx"
      to: "src/hooks/use-unassigned-orders.ts"
      via: "Hook provides unassigned orders for selection"
      pattern: "useUnassignedOrders"
---

<objective>
Build the trip detail page with financial summary card, order list with assignment, expense management, and status workflow. This is the operational hub for a single trip.

Purpose: The trip detail page is where dispatchers manage a specific trip: view financials, assign/unassign orders, manage expenses, and advance trip status. The financial summary card (6 key numbers) is the core value proposition showing real-time trip profitability.

Output: Trip detail page at `/trips/[id]` with financial card, orders section, expenses section, and status actions.
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-dispatch-workflow/03-CONTEXT.md
@.planning/phases/03-dispatch-workflow/03-RESEARCH.md
@.planning/phases/03-dispatch-workflow/03-02-SUMMARY.md
@.planning/phases/03-dispatch-workflow/03-03-SUMMARY.md

# Reference existing detail page pattern:
@src/app/(dashboard)/orders/[id]/page.tsx
@src/app/(dashboard)/orders/_components/order-detail.tsx
@src/components/shared/status-badge.tsx
@src/components/shared/confirm-dialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Trip detail page layout, financial card, and status actions</name>
  <files>
    src/app/(dashboard)/trips/[id]/page.tsx
    src/app/(dashboard)/trips/_components/trip-detail.tsx
    src/app/(dashboard)/trips/_components/trip-financial-card.tsx
    src/app/(dashboard)/trips/_components/trip-status-actions.tsx
  </files>
  <action>
**A. Create `src/app/(dashboard)/trips/[id]/page.tsx`:**
- Server Component page wrapper (same pattern as orders/[id]/page.tsx)
- Extract `id` from params (async params pattern for Next.js 16)
- Render `<TripDetail id={id} />`

**B. Create `src/app/(dashboard)/trips/_components/trip-detail.tsx`:**
- `'use client'` component
- Uses `useTrip(id)` hook to fetch trip with driver/truck relations
- Uses `useTripExpenses(id)` hook for expenses (needed for expenses section)
- **Layout structure:**
  1. **Header:** Back link to /dispatch, Trip number (TRIP-000001), StatusBadge (trip type), TripStatusActions
  2. **Trip info bar:** Truck (unit # + type), Driver (name + type), Date range, Capacity (orderCount/truckCapacity)
  3. **Financial summary card** (TripFinancialCard component)
  4. **Two-column layout below financial card:**
     - Left (wider): TripOrders component (orders assigned to this trip)
     - Right (narrower): TripExpenses component (expense management)
  5. **Optional:** Notes section if trip has notes, and edit button to update trip fields (carrier_pay, notes, dates)
- Handle loading state with skeleton (follow order-detail.tsx pattern)
- Handle not-found state with redirect or error message

**C. Create `src/app/(dashboard)/trips/_components/trip-financial-card.tsx`:**
- Displays 6 key financial numbers from CONTEXT.md in a summary card:
  1. **Revenue** -- `trip.total_revenue` (green accent, dollar icon)
  2. **Carrier Pay** -- `trip.carrier_pay` (gray, editable inline or via edit button)
  3. **Broker Fees** -- `trip.total_broker_fees` (amber accent)
  4. **Driver Pay** -- `trip.driver_pay` (blue accent). Also show driver's pay model label (e.g., "60% of Revenue" or "$50/car")
  5. **Expenses** -- `trip.total_expenses` (red accent)
  6. **Net Profit** -- `trip.net_profit` (green if positive, red if negative, bold/larger text)
- Layout: 3x2 grid of stat cards (responsive: 2x3 on medium, 1x6 on mobile)
- Each stat card shows: label, dollar amount (formatted with Intl.NumberFormat), optional subtitle
- **Currency formatting:** Use `Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' })` consistent with existing order-detail.tsx pattern
- Parse string values to numbers for display: `parseFloat(trip.total_revenue || '0')`
- Show carrier_pay as editable: small edit icon/button that opens inline edit or a small dialog to update carrier_pay (calls `updateTrip(id, { carrier_pay })`)

**D. Create `src/app/(dashboard)/trips/_components/trip-status-actions.tsx`:**
- Shows status transition buttons based on current trip status
- **Status transitions (CONTEXT.md):** planned -> in_progress -> at_terminal -> completed
- **Forward transitions:** Show a button to advance to the next status
  - planned -> "Start Trip" button (advances to in_progress)
  - in_progress -> "Mark At Terminal" button (advances to at_terminal)
  - at_terminal -> "Complete Trip" button (advances to completed)
  - completed -> No forward button
- **Rollback:** Show a secondary "Rollback" button that goes to the previous status
  - in_progress -> "Rollback to Planned"
  - at_terminal -> "Rollback to In Progress"
  - completed -> "Rollback to At Terminal"
  - planned -> No rollback button
- Use `ConfirmDialog` for status changes (especially "Complete Trip" which syncs orders to delivered)
- Confirmation message should mention the order status sync: "This will mark all X orders as delivered. Continue?"
- Call `updateTripStatus(id, newStatus)` server action
- Show loading state on buttons during server action execution
  </action>
  <verify>
Run `npx tsc --noEmit`. Check:
- /trips/[id] page renders trip detail
- Financial card shows 6 numbers formatted as currency
- Net profit is green when positive, red when negative
- Status buttons show correct transitions based on current status
- Confirm dialog appears before status changes
- Carrier pay is editable
- Back link navigates to /dispatch
  </verify>
  <done>Trip detail page shows header with status, trip info, financial summary card with 6 numbers, and status workflow buttons with confirmation dialogs and order sync messaging.</done>
</task>

<task type="auto">
  <name>Task 2: Trip orders list with assign/unassign and expense management</name>
  <files>
    src/app/(dashboard)/trips/_components/trip-orders.tsx
    src/app/(dashboard)/trips/_components/assign-order-dialog.tsx
    src/app/(dashboard)/trips/_components/trip-expenses.tsx
  </files>
  <action>
**A. Create `src/app/(dashboard)/trips/_components/trip-orders.tsx`:**
- Shows orders assigned to this trip in a list/table format
- **"Add Order" button** at the top that opens AssignOrderDialog
- For each order, show:
  - Order number
  - Vehicle info (year make model)
  - Route (pickup_state -> delivery_state)
  - Revenue (formatted as currency)
  - Broker fee (formatted as currency)
  - StatusBadge (order type)
  - **"Remove" button** -- calls `unassignOrderFromTrip(orderId)` with ConfirmDialog
- Order number is a clickable link to `/orders/${order.id}`
- Show capacity indicator: "X of Y" with progress bar (X = orders assigned, Y = truck capacity from TRUCK_CAPACITY)
- **Soft validation warning:** If orders exceed truck capacity, show an amber warning banner: "Capacity exceeded: X orders on a Y-car hauler" -- but still allow adding more (per CONTEXT.md: "warn on capacity overflow, always allow override")
- Fetch orders for this trip using Supabase query: `orders.select('*, broker:brokers(id, name)').eq('trip_id', tripId).order('created_at')`
- Can use an inline hook or add a `useTripOrders(tripId)` query in the component
- Empty state: "No orders assigned. Click 'Add Order' to assign orders to this trip."

**B. Create `src/app/(dashboard)/trips/_components/assign-order-dialog.tsx`:**
- Dialog for assigning unassigned orders to this trip
- Uses `useUnassignedOrders(search)` hook to fetch available orders
- **Search input** at the top: filters orders by order_number, VIN, make (debounced, 300ms)
- **Order list:** Each unassigned order shows:
  - Order number
  - Vehicle (year make model)
  - Route (pickup_state -> delivery_state)
  - Revenue
  - Status badge
  - **"Assign" button** -- calls `assignOrderToTrip(orderId, tripId)`
- Show loading states during assignment
- After assignment, the order disappears from the unassigned list (Realtime invalidation handles this)
- If trip is at/over capacity, show amber warning at top of dialog but do NOT prevent assignment
- Empty state: "No unassigned orders found." (with note about search if search is active)
- Dialog closes after any assignment (or stays open for batch assignment -- prefer staying open so dispatcher can assign multiple orders in sequence)

**C. Create `src/app/(dashboard)/trips/_components/trip-expenses.tsx`:**
- Shows expenses for this trip with add/edit/delete capability
- Uses `useTripExpenses(tripId)` hook
- **"Add Expense" button** opens an inline form or small dialog
- **Expense form fields:**
  1. Category -- Select from EXPENSE_CATEGORIES with labels from EXPENSE_CATEGORY_LABELS
  2. Custom Label -- Text input, visible when category is 'misc' (for custom expense descriptions)
  3. Amount -- Number input (currency formatted)
  4. Date -- Optional date input
  5. Notes -- Optional text input
- **Expense list:** Each expense shows:
  - Category label (or custom_label if misc with custom_label set)
  - Amount (formatted as currency)
  - Date (if set)
  - Edit button (opens form pre-filled with expense data)
  - Delete button (with ConfirmDialog)
- **Total row** at bottom showing sum of all expenses
- **CRUD calls:**
  - Create: `createTripExpense(tripId, formData)`
  - Update: `updateTripExpense(id, tripId, formData)`
  - Delete: `deleteTripExpense(id, tripId)`
- Each mutation triggers financial recalculation (handled in server actions)
- Empty state: "No expenses recorded for this trip."
- Form validation: Amount required and > 0, category required
  </action>
  <verify>
Run `npx tsc --noEmit`. Check:
- Orders list shows assigned orders with details
- "Add Order" opens assign dialog with search
- Assign button calls assignOrderToTrip and order moves to assigned list
- "Remove" button unassigns order with confirmation
- Capacity warning shows when over truck capacity
- Expense CRUD works (add, edit, delete)
- Custom label field appears for misc category
- Total expenses row updates after mutations
  </verify>
  <done>Trip detail page has orders section with assign/unassign dialogs, capacity warnings, and expense section with full CRUD. All mutations trigger financial recalculation.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Trip detail page loads at /trips/[id] with all sections
3. Financial card shows 6 formatted currency values
4. Net profit color-coded (green positive, red negative)
5. Status buttons show correct transitions with confirmation
6. Orders list shows assigned orders, "Add Order" opens search dialog
7. Unassigned orders searchable and assignable
8. Capacity warning shows when over truck capacity but allows override
9. Expense CRUD works with category selection and custom labels
10. All mutations trigger financial recalculation (verify values update)
</verification>

<success_criteria>
- Trip detail page fully functional at /trips/[id]
- Financial summary card shows all 6 numbers correctly
- Carrier pay is editable
- Status workflow: planned -> in_progress -> at_terminal -> completed with rollback
- Orders assignable from dialog, unassignable from list
- Capacity warnings shown but overridable
- Expense CRUD with predefined and custom categories
- Financial values update after every mutation (order assign/unassign, expense add/edit/delete, carrier pay edit)
</success_criteria>

<output>
After completion, create `.planning/phases/03-dispatch-workflow/03-05-SUMMARY.md`
</output>
