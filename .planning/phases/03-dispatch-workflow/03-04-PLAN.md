---
phase: 03-dispatch-workflow
plan: 04
type: execute
wave: 3
depends_on: ["03-01", "03-03"]
files_modified:
  - src/app/(dashboard)/dispatch/page.tsx
  - src/app/(dashboard)/dispatch/_components/dispatch-board.tsx
  - src/app/(dashboard)/dispatch/_components/trip-row.tsx
  - src/app/(dashboard)/dispatch/_components/trip-filters.tsx
  - src/app/(dashboard)/dispatch/_components/new-trip-dialog.tsx
autonomous: true

must_haves:
  truths:
    - "Dispatch board shows trips grouped by status sections"
    - "Each trip row shows truck unit #, driver name, capacity, route summary, status badge, date range"
    - "Trips can be filtered by status, driver, truck, and date range"
    - "New trip can be created from a modal dialog with truck and driver search"
    - "After trip creation, user is redirected to the trip detail page"
    - "Dispatch board page is accessible at /dispatch"
  artifacts:
    - path: "src/app/(dashboard)/dispatch/page.tsx"
      provides: "Dispatch board page wrapper"
      contains: "DispatchBoard"
      min_lines: 10
    - path: "src/app/(dashboard)/dispatch/_components/dispatch-board.tsx"
      provides: "Main dispatch board with status-grouped trip sections"
      contains: "useTrips"
      min_lines: 60
    - path: "src/app/(dashboard)/dispatch/_components/trip-row.tsx"
      provides: "Individual trip row component"
      contains: "StatusBadge"
      min_lines: 30
    - path: "src/app/(dashboard)/dispatch/_components/trip-filters.tsx"
      provides: "Filter bar for dispatch board"
      contains: "TripFilters"
      min_lines: 30
    - path: "src/app/(dashboard)/dispatch/_components/new-trip-dialog.tsx"
      provides: "Trip creation modal dialog"
      contains: "createTrip"
      min_lines: 60
  key_links:
    - from: "src/app/(dashboard)/dispatch/_components/dispatch-board.tsx"
      to: "src/hooks/use-trips.ts"
      via: "Hook provides trip data"
      pattern: "useTrips"
    - from: "src/app/(dashboard)/dispatch/_components/new-trip-dialog.tsx"
      to: "src/app/actions/trips.ts"
      via: "Form submits to createTrip server action"
      pattern: "createTrip"
    - from: "src/app/(dashboard)/dispatch/_components/trip-row.tsx"
      to: "src/app/(dashboard)/trips/[id]/page.tsx"
      via: "Row click navigates to trip detail"
      pattern: "href.*trips/"
---

<objective>
Build the dispatch board page -- a trips-focused table/list view with status-grouped sections, filters, and a trip creation modal. This is the primary dispatcher workspace.

Purpose: The dispatch board is the central hub where dispatchers view and manage all trips. It shows trips grouped by status (Planned, In Progress, At Terminal, Completed) with medium-density rows showing key operational info. This is NOT a card grid -- it's a table/list view, departing from the entity pattern used in Phase 2.

Output: Dispatch board page at `/dispatch` with filterable trip list, status-grouped sections, and trip creation modal.
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-dispatch-workflow/03-CONTEXT.md
@.planning/phases/03-dispatch-workflow/03-RESEARCH.md
@.planning/phases/03-dispatch-workflow/03-01-SUMMARY.md
@.planning/phases/03-dispatch-workflow/03-03-SUMMARY.md

# Reference existing UI patterns:
@src/app/(dashboard)/orders/page.tsx
@src/app/(dashboard)/orders/_components/order-list.tsx
@src/app/(dashboard)/orders/_components/order-filters.tsx
@src/components/shared/status-badge.tsx
@src/components/shared/filter-bar.tsx
@src/components/shared/pagination.tsx
@src/components/shared/empty-state.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dispatch board page with status-grouped trip list</name>
  <files>
    src/app/(dashboard)/dispatch/page.tsx
    src/app/(dashboard)/dispatch/_components/dispatch-board.tsx
    src/app/(dashboard)/dispatch/_components/trip-row.tsx
    src/app/(dashboard)/dispatch/_components/trip-filters.tsx
  </files>
  <action>
**A. Create `src/app/(dashboard)/dispatch/page.tsx`:**
- Server Component page wrapper (same pattern as orders/page.tsx)
- Renders heading "Dispatch Board" and the `<DispatchBoard />` client component
- Accepts searchParams for filter state (same URL search params pattern as orders)

**B. Create `src/app/(dashboard)/dispatch/_components/dispatch-board.tsx`:**
- `'use client'` component
- Uses `useTrips(filters)` hook to fetch trips
- Reads filters from URL search params (same pattern as order-list.tsx)
- **Layout: Status-grouped sections**, NOT a flat table. Group trips by status:
  1. "Planned" section (blue accent)
  2. "In Progress" section (amber accent)
  3. "At Terminal" section (purple accent)
  4. "Completed" section (green accent)
- Each section is a collapsible group with a header showing status name and count (e.g., "Planned (3)")
  - Use a simple disclosure/accordion: section header clickable to collapse/expand
  - All sections expanded by default except "Completed" which starts collapsed
- Each section contains trip rows (or "No trips" empty state if section is empty)
- **Top bar:** "New Trip" button (opens NewTripDialog) + TripFilters component
- Show total count: "Showing X trips"
- Use `Pagination` component at the bottom (same as orders)
- Show `EmptyState` when no trips at all exist ("No trips yet. Create your first trip to get started.")

**C. Create `src/app/(dashboard)/dispatch/_components/trip-row.tsx`:**
- Renders a single trip as a table-like row (NOT a card)
- **Row columns per CONTEXT.md medium density spec:**
  1. **Trip #** -- trip_number (e.g., "TRIP-000001")
  2. **Truck** -- unit number from joined truck (e.g., "T-101")
  3. **Driver** -- first_name + last initial from joined driver (e.g., "John D.")
  4. **Capacity** -- `orderCount / truckCapacity` format (e.g., "7/9"). Use `TRUCK_CAPACITY[truck.truck_type]` for max. Color code: green if under capacity, amber if at capacity, red if over.
  5. **Route** -- Display route summary from denormalized fields: `trip.origin_summary` and `trip.destination_summary`. Format: "FL -> NY" using a right arrow character. If both fields are populated, show `${trip.origin_summary} -> ${trip.destination_summary}` (e.g., "FL -> NY" or "FL, GA -> NY, PA"). If only one is populated, show what's available. If neither is populated (no orders assigned), show "No route" in muted text.
  6. **Status** -- StatusBadge component with type="trip"
  7. **Dates** -- formatted start_date - end_date range (e.g., "Jan 5 - Jan 8")
- **Entire row is clickable** -- navigates to `/trips/${trip.id}` (same pattern as order cards navigating to detail)
- Use `next/link` wrapping the row or an `onClick` with `router.push`
- Hover state on the row (light background change)
- Responsive: On mobile, stack key info vertically or use horizontal scroll

**D. Create `src/app/(dashboard)/dispatch/_components/trip-filters.tsx`:**
- Follow the same pattern as `order-filters.tsx`
- **Filter fields:**
  1. **Status** -- Select dropdown with TRIP_STATUSES options + "All Statuses" default
  2. **Driver** -- Select dropdown populated from `useDrivers()` hook (same pattern as order-filters using existing hooks for dynamic options). Show driver first_name + last_name as label, driver.id as value
  3. **Truck** -- Select dropdown populated from `useTrucks()` hook. Show unit_number as label, truck.id as value
  4. **Date range** -- Two date inputs (start_date, end_date) for filtering trips by date range
  5. **Search** -- Text input for trip number search (integrated into FilterBar or standalone)
- All filter values stored in URL search params (same shareable/bookmarkable pattern as orders)
- Use `useRouter` + `useSearchParams` to read/write filter state
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compilation. Manually verify:
- /dispatch page renders without errors (start dev server if possible)
- Trips are grouped by status sections
- Filter dropdowns populate from hooks (drivers, trucks)
- Status badges render with correct colors for trip statuses
- Pagination works
- Row click navigates to /trips/[id]
  </verify>
  <done>Dispatch board at /dispatch shows status-grouped trip sections with filterable rows. Each row shows trip #, truck, driver, capacity, route summary (e.g., "FL -> NY"), status badge, and date range. Rows are clickable to navigate to trip detail.</done>
</task>

<task type="auto">
  <name>Task 2: Trip creation modal dialog</name>
  <files>src/app/(dashboard)/dispatch/_components/new-trip-dialog.tsx</files>
  <action>
Create `new-trip-dialog.tsx` using shadcn/ui Dialog component (already installed):

**Dialog trigger:** "New Trip" button on the dispatch board (primary blue button with Plus icon)

**Dialog content:**
- Title: "Create New Trip"
- Form with react-hook-form + zodResolver using `tripSchema`
- **Required fields per CONTEXT.md:**
  1. **Truck** -- Type-ahead searchable select. Use shadcn `Select` component or `Popover` + `Command` pattern for filterable dropdown. Populate from `useTrucks({ status: 'active' })` -- only show active trucks. Display format: "Unit # | Truck Type" (e.g., "T-101 | 9-Car Hauler"). Value: truck.id
  2. **Driver** -- Type-ahead searchable select. Populate from `useDrivers({ status: 'active' })` -- only show active drivers. Display format: "First Last | Driver Type" (e.g., "John Doe | Company"). Value: driver.id
  3. **Start Date** -- Date input (use shadcn Calendar/DatePicker or simple input type="date")
  4. **End Date** -- Date input
  5. **Carrier Pay** -- Optional numeric input, defaults to 0 (formatted as currency)
  6. **Notes** -- Optional textarea

- **Type-ahead implementation:** Use the shadcn `Popover` + `Command` pattern for searchable selects. This is the standard shadcn combobox pattern. If that's too complex, use a simple `Select` with `onSearchChange` or inline input filter -- follow whichever pattern is already established in the codebase for dynamic selects (check order-filters.tsx or driver-form.tsx for existing patterns).

**Form submission:**
- Call `createTrip(formData)` server action
- On success: close dialog, redirect to `/trips/${tripId}` (per CONTEXT.md: "After creation, redirect to trip detail page for order assignment")
- On error: show error toast using sonner/toast (follow existing error handling pattern)
- Submit button shows loading state during submission

**Dialog behavior:**
- Opens via state managed in DispatchBoard component
- Closes on Cancel button or overlay click
- Form resets when dialog opens
  </action>
  <verify>
Run `npx tsc --noEmit` to verify compilation. Check:
- Dialog opens and closes correctly
- Form validates required fields (truck, driver, dates)
- Type-ahead search filters truck and driver lists
- createTrip is called on submit
- Redirect to /trips/[id] on success
- Loading state shown during submission
  </verify>
  <done>Trip creation modal opens from dispatch board, collects truck + driver + dates with type-ahead search, creates trip via server action, and redirects to trip detail page for order assignment.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. /dispatch page loads and renders dispatch board
3. Trips grouped by status sections with correct color coding
4. All 4 filter types work (status, driver, truck, date range)
5. New Trip dialog opens, validates, and creates trip
6. Trip rows are clickable and navigate to /trips/[id]
7. Capacity display shows orderCount/truckCapacity
8. Route summary shows origin -> destination from denormalized fields (e.g., "FL -> NY")
9. URL search params persist filter state (shareable URLs)
</verification>

<success_criteria>
- Dispatch board accessible at /dispatch with status-grouped trip sections
- Trip rows show: trip #, truck, driver, capacity, route summary, status, dates
- Filters for status, driver, truck, and date range
- New Trip modal with type-ahead truck/driver selection
- Trip creation redirects to trip detail page
- URL search params for filters (shareable)
- Responsive layout
</success_criteria>

<output>
After completion, create `.planning/phases/03-dispatch-workflow/03-04-SUMMARY.md`
</output>
