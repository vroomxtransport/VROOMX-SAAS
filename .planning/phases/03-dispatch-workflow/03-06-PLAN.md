---
phase: 03-dispatch-workflow
plan: 06
type: execute
wave: 4
depends_on: ["03-03", "03-05"]
files_modified:
  - src/app/(dashboard)/orders/_components/assign-to-trip.tsx
  - src/app/(dashboard)/orders/_components/order-detail.tsx
autonomous: true

must_haves:
  truths:
    - "Order detail page shows current trip assignment"
    - "Orders can be assigned to a trip from the order detail page"
    - "Orders can be reassigned to a different trip in a single action"
    - "Unassigning from the order detail page sets trip_id to null"
  artifacts:
    - path: "src/app/(dashboard)/orders/_components/assign-to-trip.tsx"
      provides: "Assign-to-trip component with trip search and selection"
      contains: "assignOrderToTrip"
      min_lines: 40
    - path: "src/app/(dashboard)/orders/_components/order-detail.tsx"
      provides: "Updated order detail with trip assignment section"
      contains: "AssignToTrip"
  key_links:
    - from: "src/app/(dashboard)/orders/_components/assign-to-trip.tsx"
      to: "src/app/actions/trips.ts"
      via: "Calls assignOrderToTrip and unassignOrderFromTrip"
      pattern: "assignOrderToTrip|unassignOrderFromTrip"
    - from: "src/app/(dashboard)/orders/_components/order-detail.tsx"
      to: "src/app/(dashboard)/orders/_components/assign-to-trip.tsx"
      via: "Renders AssignToTrip component"
      pattern: "AssignToTrip"
---

<objective>
Add trip assignment capability to the existing order detail page. Dispatchers can assign orders to trips from either direction -- this plan handles the order-side direction.

Purpose: Per CONTEXT.md, assignment works in "both directions" -- from the trip detail page (built in Plan 05) and from the order detail page (this plan). This gives dispatchers flexibility: they can start from whichever page they're viewing.

Output: "Assign to Trip" section on the order detail page with trip search, assignment, reassignment, and unassignment.
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-dispatch-workflow/03-CONTEXT.md
@.planning/phases/03-dispatch-workflow/03-RESEARCH.md
@.planning/phases/03-dispatch-workflow/03-03-SUMMARY.md

# The file we're modifying:
@src/app/(dashboard)/orders/_components/order-detail.tsx
@src/app/(dashboard)/orders/[id]/page.tsx
@src/hooks/use-orders.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AssignToTrip component</name>
  <files>src/app/(dashboard)/orders/_components/assign-to-trip.tsx</files>
  <action>
Create `assign-to-trip.tsx` as a `'use client'` component that shows the current trip assignment for an order and allows changing it.

**Props:**
- `orderId: string` -- the order being assigned
- `currentTripId: string | null` -- current trip assignment (null if unassigned)
- `currentTripNumber: string | null` -- trip number for display

**Three states:**

1. **Unassigned (currentTripId is null):**
   - Show "Not assigned to a trip" message
   - Show "Assign to Trip" button that opens a trip search/select
   - Trip search: Use a Popover + Command (combobox) or simple Select to search trips
   - Fetch available trips using `useTrips()` hook (or a simplified query)
   - Show trip options: "TRIP-000001 | John D. | T-101 | Jan 5-8"
   - On selection: Call `assignOrderToTrip(orderId, selectedTripId)`

2. **Assigned (currentTripId exists):**
   - Show current trip info: trip number as a link to `/trips/${currentTripId}`, driver name, truck unit #
   - Show "Change Trip" button -- opens same search/select to reassign to different trip
   - On selection: Call `assignOrderToTrip(orderId, newTripId)` -- this handles the reassignment (unassigns from old, assigns to new, recalculates both)
   - Show "Remove from Trip" button -- calls `unassignOrderFromTrip(orderId)` with ConfirmDialog

3. **Loading state:**
   - Show skeleton while action is processing

**Trip search/select implementation:**
- Simple approach: Use shadcn Select or Popover+Command pattern
- Fetch trips list: Filter to only 'planned' and 'in_progress' trips (completed trips shouldn't receive new orders)
- Search by trip_number
- Show in dropdown: trip_number, driver name, truck unit #, date range, order count
- Each option clickable to assign

**Important behavior per CONTEXT.md:**
- "One trip per order, easy reassign" -- reassignment is a single action
- "Moving an order to a different trip is a single action. Old trip auto-updates its counts and financials" -- this is handled by the `assignOrderToTrip` server action which recalculates both trips
  </action>
  <verify>
Run `npx tsc --noEmit`. Check:
- Component renders correctly for unassigned state
- Component renders correctly for assigned state with trip link
- Trip search/select populates with available trips
- Assignment calls assignOrderToTrip
- Reassignment calls assignOrderToTrip (which handles both trips)
- Unassignment calls unassignOrderFromTrip with confirmation
  </verify>
  <done>AssignToTrip component shows current trip assignment with search/select for assigning, reassigning, or removing trip assignment.</done>
</task>

<task type="auto">
  <name>Task 2: Wire AssignToTrip into order detail page</name>
  <files>src/app/(dashboard)/orders/_components/order-detail.tsx</files>
  <action>
Modify the existing `order-detail.tsx` to include the AssignToTrip component.

**Changes needed:**

1. **Import AssignToTrip:**
   ```typescript
   import { AssignToTrip } from './assign-to-trip'
   ```

2. **Add trip assignment section** to the order detail layout. Place it in a logical position -- either:
   - After the order info section and before the status timeline
   - Or as a dedicated card/section in the detail layout
   - Best placement: After the main order details card, before or alongside the status section

3. **Pass props to AssignToTrip:**
   - `orderId={order.id}`
   - `currentTripId={order.trip_id}` -- this requires the order data to include trip_id (should already be there from the schema update in Plan 01 adding trip_id to the Order interface)
   - `currentTripNumber` -- This requires the order query to join the trip. Two options:
     a. Update the `fetchOrder` query in `src/lib/queries/orders.ts` to join trips: `.select('*, broker:brokers(...), driver:drivers(...), trip:trips(id, trip_number)')` -- then pass `order.trip?.trip_number`
     b. Or have AssignToTrip fetch the trip data internally if currentTripId is provided
   - **Preferred approach (a):** Update the orders query to include trip relation. Modify `src/lib/queries/orders.ts` `fetchOrder` function to add `trip:trips(id, trip_number, status)` to the select. Then pass the trip data through.

4. **Also update `src/lib/queries/orders.ts`** (if needed):
   - In `fetchOrder()`: Add `trip:trips(id, trip_number, status)` to the select string
   - In `fetchOrders()`: Optionally add trip relation for the list view too (so order cards can show trip assignment)
   - Update the TypeScript types if needed (OrderWithRelations)

5. **Conditional rendering:** Only show the AssignToTrip section if the order is in an assignable status ('new', 'assigned', 'picked_up'). Orders that are 'delivered', 'invoiced', 'paid', or 'cancelled' should not be reassignable (or at least show a warning).

**IMPORTANT:** Be careful not to break the existing order detail page. Read the current order-detail.tsx fully before making changes. Add the new section alongside existing sections, don't restructure the layout.
  </action>
  <verify>
Run `npx tsc --noEmit`. Check:
- Order detail page still renders correctly for all order statuses
- AssignToTrip section appears for unassigned orders
- AssignToTrip section shows current trip for assigned orders
- Trip number links to /trips/[id]
- Order queries include trip relation (fetchOrder and optionally fetchOrders)
- No regressions in existing order detail functionality
  </verify>
  <done>Order detail page shows trip assignment section. Orders can be assigned, reassigned, or unassigned from trips directly from the order detail page. Order queries include trip relation.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Order detail page shows trip assignment for all orders
3. Unassigned orders show "Assign to Trip" with trip search
4. Assigned orders show current trip with link, change option, and remove option
5. Reassignment works as single action (old trip recalculated)
6. Trip search filters to planned/in_progress trips
7. Existing order detail functionality not broken
8. Orders query includes trip relation data
</verification>

<success_criteria>
- Order detail page has functional "Assign to Trip" section
- Both directions of assignment work: from trip detail (Plan 05) and from order detail (this plan)
- Reassignment is a single action that updates both trips
- Trip number on order detail links to trip detail page
- Unassignment resets order status to 'new'
- No regressions in order detail page
</success_criteria>

<output>
After completion, create `.planning/phases/03-dispatch-workflow/03-06-SUMMARY.md`
</output>
