# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

VroomX is a multi-tenant SaaS TMS (Transportation Management System) for vehicle transport carriers. Carriers sign up, pick a pricing tier (Starter/Pro/Enterprise), and manage orders, trips, drivers, trucks, billing, and invoicing. There is also a companion iOS driver app in `VroomXDriver/` (SwiftUI).

## Commands

```bash
npm run dev          # Start Next.js dev server (localhost:3000)
npm run build        # Production build
npm run lint         # ESLint
npm run test:e2e     # Playwright end-to-end tests
npm run test:e2e:ui  # Playwright with interactive UI
npx vitest           # Run unit tests (e.g. trip-calculations)
npx vitest run src/lib/financial/__tests__/trip-calculations.test.ts  # Single test file
npx drizzle-kit push # Push Drizzle schema changes to DB
npx drizzle-kit generate  # Generate migration from schema diff
```

## Architecture

### Tech Stack

- **Framework**: Next.js 16 (App Router), React 19, TypeScript
- **Styling**: Tailwind CSS v4, Radix UI primitives via shadcn/ui (`src/components/ui/`)
- **Database**: Supabase (PostgreSQL) with Row-Level Security. Every table has `tenant_id`
- **ORM**: Drizzle ORM for schema definition and migrations; Supabase JS client for runtime queries
- **Auth**: Supabase Auth (email/password + magic link). Tenant/role stored in `user.app_metadata`
- **Payments**: Stripe (Checkout, Billing Portal, Webhooks)
- **State**: Zustand (client stores), TanStack React Query (server state + realtime invalidation)
- **Email**: Resend for transactional emails
- **Monitoring**: Sentry (errors), PostHog (analytics, proxied via `/ingest`)

### Route Groups

- `src/app/(marketing)/` — Public landing page
- `src/app/(auth)/` — Login, signup, invite acceptance, auth-confirm
- `src/app/(dashboard)/` — Protected app. Auth check + tenant fetch in layout.tsx

### Data Flow Pattern

Each entity (orders, trips, drivers, trucks, brokers, etc.) follows the same pattern:

1. **Schema**: `src/db/schema.ts` — Drizzle table definitions and type exports
2. **Types**: `src/types/index.ts` — Union types, const arrays, label maps, color maps
3. **Validation**: `src/lib/validations/{entity}.ts` — Zod schemas for form/action input
4. **Queries**: `src/lib/queries/{entity}.ts` — Supabase query functions (client-side, called from hooks)
5. **Hooks**: `src/hooks/use-{entity}.ts` — TanStack Query hooks with Supabase Realtime invalidation
6. **Actions**: `src/app/actions/{entity}.ts` — Server actions (`'use server'`) for mutations
7. **Pages**: `src/app/(dashboard)/{entity}/page.tsx` — Route pages and `_components/` for page-specific components

### Multi-Tenancy

- Every database table has a `tenant_id` column enforced by PostgreSQL RLS policies
- `tenant_id` and `role` are stored in `user.app_metadata` (set during signup/invite acceptance)
- The dashboard layout (`src/app/(dashboard)/layout.tsx`) fetches tenant info and gates access
- Middleware (`src/lib/supabase/proxy.ts`) handles session refresh and route protection
- Tier limits enforced via `src/lib/tier.ts` (`checkTierLimit`, `isAccountSuspended`)

### Database

- **Schema source of truth**: `src/db/schema.ts` (Drizzle)
- **Migrations**: `supabase/migrations/` (7 sequential migration files)
- **Runtime queries use Supabase JS client** (not Drizzle query builder) — Drizzle is only for schema/migrations
- **Connection**: `src/db/index.ts` uses `postgres` driver with `prepare: false` (required for PgBouncer)
- `DATABASE_URL` = pooled connection (port 6543), `DATABASE_URL_DIRECT` = direct connection (port 5432, for Drizzle migrations)

### Supabase Client Pattern

- `src/lib/supabase/server.ts` — Server Component/Action client (reads cookies)
- `src/lib/supabase/client.ts` — Browser client (for hooks/client components)
- `src/lib/supabase/service-role.ts` — Admin client (bypasses RLS, server-only)
- `src/lib/supabase/proxy.ts` — Middleware session refresh logic

### Financial Calculations

`src/lib/financial/trip-calculations.ts` contains the pure `calculateTripFinancials()` function. Driver pay models:
- Company driver: `percentage_of_carrier_pay` — % of (revenue - brokerFees)
- Owner-operator: `dispatch_fee_percent` — company keeps fee %, driver gets remainder
- Flat rate: `per_car` — payRate * order count

### Key Conventions

- Path alias: `@/*` maps to `./src/*`
- Server actions use Zod validation, `createClient()` for auth, and `revalidatePath` after mutations
- Order numbers are auto-generated by a DB trigger (never set in app code)
- UI components from shadcn in `src/components/ui/`, shared components in `src/components/shared/`
- Layout components (sidebar, header, breadcrumbs) in `src/components/layout/`
- Zustand stores in `src/stores/` (sidebar state, draft state, dashboard widget preferences)

### Environment Variables

See `.env.local.example` for required vars. Key groups: Supabase (public + secret), Stripe (secret key + webhook + price IDs), Sentry, PostHog.

### Design System

Uses oklch brand colors with CSS custom properties (`--brand`, `--brand-glow`, etc.) and utility classes defined in `src/app/globals.css` (e.g., `glass-card`, `glass-card-hover`, `shimmer-border`, `card-hover`). Dark-atmospheric design with frosted glass effects.
